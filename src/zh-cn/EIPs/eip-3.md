---
eip: 3
title: 添加 CALLDEPTH 操作码
author: Martin Holst Swende <martin@swende.se>
status: 撤回
type: 标准跟踪
category: 核心
created: 2015-11-19
---

# 摘要

这是一个添加新操作码 `CALLDEPTH` 的提案。`CALLDEPTH` 操作码将返回剩余可用的调用栈深度。

# 动机

合约调用其他合约的深度是有限制的；即调用栈。当前限制为 `256`。如果一个合约调用另一个合约（通过 `CALL` 或 `CALLCODE`），当达到调用栈深度限制时，该操作将失败。

这种行为使得合约容易受到“调用栈攻击” [1]。在这种攻击中，攻击者首先创建一个合适的栈深度，例如通过递归调用。在这一步之后，攻击者调用目标合约。如果目标合约调用了另一个合约，该调用将失败。如果返回值没有被正确检查以确认调用是否成功，后果可能会很严重。

示例：

1. 合约 `A` 希望被定期调用，并在每个区块中向调用者支付以太币。
2. 当合约 `A` 被调用时，它调用合约 `B` 和 `C`，这消耗了大量的 gas。调用后，合约 `A` 向调用者支付以太币。
3. 恶意用户 `X` 确保在调用 A 之前栈深度较浅。对 `B` 和 `C` 的调用都失败，但 `X` 仍然可以收集奖励。

可以通过两种方式防御这种攻击：

1. 调用后检查返回值。
2. 实验性地检查调用栈深度。Piper Merriam 提供了一个库 [2] 用于此目的。此方法在 gas 上相当昂贵。

[1] 也称为“浅栈攻击”和“栈攻击”。然而，准确地说，单词“栈”在 EVM 中有不同的含义，不应与“调用栈”混淆。

[2] https://github.com/pipermerriam/ethereum-stack-depth-lib

# 规范

操作码 `CALLDEPTH` 应返回剩余的调用栈深度。值为 `0` 表示调用栈已耗尽，无法进行进一步的调用。

# 理由

实际的调用栈深度以及调用栈深度限制在执行期间存在于 EVM 中，但在 EVM 内部不可用。实现应该相当简单，并且将提供一种廉价的方式来防止调用栈攻击。

# 实现

未实现。