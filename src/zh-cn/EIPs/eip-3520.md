---
eip: 3520
title: 交易目标操作码
author: Alex Papageorgiou (@alex-ppg)
discussions-to: https://ethereum-magicians.org/t/eip-3520-transaction-destination-opcode/6058
status: Stagnant
type: Standards Track
category: Core
created: 2021-04-16
requires: 3508
---

## 简单总结

提供对交易原始接收者的访问。

## 摘要

本 EIP 引入了以下 EVM 指令：`ENTRYPOINT`。

该指令旨在提供对交易原始接收者的访问，即 `to` 地址，从而使得可以与 [EIP-3508](./eip-3508.md) 结合应用新的反思方式。

## 动机

不可否认，智能合约变得比以往任何时候都更加互联。到目前为止，智能合约完全依赖于合规接口和反思来引入复杂多合约交互的调用链中的新步骤。然而，这种方法仅限于向前的方式，限制了可以表现的交互类型。

本 EIP 的目的是提供一种方式，使合约能够识别区块链上交易的入口点，并通过对原始交易数据本身进行反思来推断交易的原始意图。

本 EIP 使得新类型智能合约的开发成为可能，因为它可以为 [EIP-721](./eip-721) NFT 和 [EIP-20](./eip-20) 代币打开新的路径，以检测其交易属于哪种操作，例如检测对去中心化交易所的流动性提供或在抵押贷款协议中的贷款。

## 规范

### ENTRYPOINT (`0x4a`)

`ENTRYPOINT` 指令使用 0 个栈参数，并将交易的原始 `to` 成员推送到栈上。该指令返回的地址是一个 160 位值，填充到 256 位。该操作的执行成本为 `G_base`，与 `ORIGIN` (`0x32`) 相似。

`ENTRYPOINT` 操作码返回的地址将等同于栈中最近的 `AUTHCALL` 指定的 `to` 地址参数。如果栈中没有 `AUTHCALL`，则 `ENTRYPOINT` 将检索原始交易的 `to` 字段。

## 理由

### AUTHCALL (`0xf7`) 交互

[EIP-3074](./eip-3074.md) 引入了一种新的调用指令 `AUTHCALL` (`0xf7`)，它将替换交易的 `ORIGIN` (`0x32`) 为上下文变量 `authorized`。`AUTHCALL` 的意图是防止在智能合约和 EOA 之间的歧视，而 `ORIGIN` 最初促进了这种歧视。`ENTRYPOINT` 操作码本身重新引入了系统中的歧视，因为它间接允许评估正在执行的智能合约代码是否由 EOA 执行，通过验证 `ENTRYPOINT == ADDRESS`，其中 `ADDRESS` (`0x30`) 检索当前执行账户地址。因此，合理的做法是将 `ENTRYPOINT` 操作码返回的值替换为 `AUTHCALL` 的目标。

这种交互确保与 [EIP-3074](./eip-3074.md) 的完全兼容，并确保本 EIP 不会在系统中重新引入任何形式的歧视。

### 命名约定

`ENTRYPOINT` 指令的命名是通过定义一个合理的名称来实现的，该名称立即且清晰地描绘了它所要实现的目标，即信号传递特定调用的第一次交互，即入口点。

### 指令地址空间

等同于 [EIP-3508](./eip-3508)。

### 燃气成本

操作码 ENTRYPOINT (`0x4a`) 本质上执行的与操作码 ORIGIN (`0x32`) 相同，因此共享完全相同的燃气成本。

### 对 EIP-3508 的依赖

`ENTRYPOINT` (`0x4a`) 指令本身没有明显的好处，因为它可以被 `AUTHCALL` (`0xf7`) 指令替代，因此应仅与 [EIP-3508](./eip-3508.md) 中定义的 `ORIGINDATA*` 操作码一起引入系统。

## 向后兼容性

本 EIP 不会改变或调整 EVM 提供的现有功能，因此不存在已知问题。

## 测试用例

TODO。

## 安全考虑

### 反思合约

`ENTRYPOINT` 指令允许将 `ORIGINDATALOAD` 和 `ORIGINDATACOPY` 值与特定智能合约地址和接口关联，使得可以基于调用的函数签名和提供的参数进行反思，从而可靠地推断出调用特定智能合约的调用路径，并允许在这些特殊情况下定义更细粒度的交互。

然而，这种类型的反思应仅应用于预先批准的合约，而不是用户定义的合约，因为这种反思所带来的价值完全依赖于合约代码的不可变性和正确性，而用户提供的合约可以轻易绕过这两者。

### 调用者歧视

本 EIP 的指令不应被用作区分 EOA 调用者和智能合约的方式，因为这种类型的区分可以被规范章节中定义的 `AUTHCALL` 打破。

### 合约创建行为

在合约创建期间，`ENTRYPOINT` 操作码的行为将导致该操作码返回零地址作为交易中第一次交互的地址。合约实现应考虑这一点，类似于如何处理 `ecrecover` 无效签名，以防止软件行为异常。

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。