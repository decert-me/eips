---
eip: 4444
title: 在执行客户端中绑定历史数据
description: 修剪超过一年的历史数据
author: George Kadianakis (@asn-d6), lightclient (@lightclient), Alex Stokes (@ralexstokes)
discussions-to: https://ethereum-magicians.org/t/eip-4444-bound-historical-data-in-execution-clients/7450
status: Stagnant
type: Standards Track
category: Networking
created: 2021-11-02
---

## 摘要

客户端必须停止在 p2p 层上提供超过一年的历史头部、主体和收据。客户端可以本地修剪这些历史数据。

## 动机

历史区块和收据目前占用超过 400GB 的磁盘空间（并且还在增长！）。因此，为了验证链，用户通常必须拥有 1TB 的磁盘。

历史数据对于验证新块并不是必需的，因此一旦客户端同步了链的尖端，历史数据仅在通过 JSON-RPC 明确请求或当对等方尝试同步链时检索。通过修剪历史，这个提案减少了用户的磁盘需求。修剪历史还允许客户端删除处理历史区块的代码。这意味着执行客户端不需要维护处理每次升级的复合更改的代码路径。

最后，这一变化将导致网络带宽使用减少，因为客户端采用基于 PoS 弱主观性假设的更轻量级同步策略。

## 规范

| 参数 | 值 | 描述 |
| - | - | - |
| `HISTORY_PRUNE_EPOCHS` | 82125 | 在信标链纪元中的一年 |

客户端在 p2p 网络上**不应**提供超过 `HISTORY_PRUNE_EPOCHS` 纪元的头部、区块主体和收据。

客户端**可以**本地修剪超过 `HISTORY_PRUNE_EPOCHS` 纪元的头部、区块主体和收据。

#### 启动和同步

此 EIP 影响客户端的启动和同步方式。客户端将无法使用 devp2p 完全同步，因为历史数据将不再被提供。

客户端**必须**使用有效的弱主观性检查点从更近期的链视图启动。为了同步，客户端将弱主观性检查点视为创世区块。我们称这种方法为“检查点同步”。

对于本提案，我们假设客户端始终从配置和有效的弱主观性检查点开始。实现这一点的方式超出了本提案的范围。

## 理由

本提案迫使客户端停止通过 p2p 提供旧的历史数据。我们明确这一点，以迫使客户端从其他来源寻求历史数据，而不是依赖某些客户端的可选行为，这将导致质量下降。

### 为什么是一年？

本提案将 `HISTORY_PRUNE_EPOCHS` 设置为 82125 纪元（一个地球年）。这个常量足够大，可以为弱主观性周期的增长提供足够的空间，同时又足够小，以免占用过多的磁盘空间。

## 向后兼容性

### 保留历史数据

本提案影响使用历史数据的节点（例如，显示区块、交易或账户历史的 web3 应用程序）。保留以太坊的历史是基础，我们相信有多种带外方式可以实现这一点。

历史数据可以通过 torrent 磁力链接或通过 IPFS 等网络进行打包和共享。此外，像 Portal Network 或 The Graph 这样的系统可以用来获取历史数据。

客户端应允许导入和导出历史数据。客户端可以提供脚本来获取/验证数据并自动导入。

### 从创世区块完全同步

通过 p2p 网络将不再可能完全同步。然而，我们希望允许感兴趣的各方自行进行。

我们建议构建一个专门的“完全同步”客户端。该客户端是一个连接器，可以将不同版本的执行引擎拼接在一起，并可以导入历史区块以验证整个以太坊链从创世区块开始并生成所有其他历史数据。

同样重要的是，尽管具有“状态同步”功能的归档节点正在开发中，但目前完全同步仍然是启动它们的唯一可靠方法。希望继续提供归档支持的客户端需要能够导入带外获取的历史区块，并保留对网络每次历史升级的支持。

### 用户体验

本提案影响使用历史数据的应用程序的设置用户体验。因此，我们建议客户端分两个阶段引入这一变化：

在第一阶段，客户端默认不修剪历史数据。它们引入一个类似于 geth 的 `--txlookuplimit` 的命令行选项，用户可以在想要修剪历史数据时使用。

在第二阶段，历史数据默认被修剪，并且命令行选项被移除。客户端假设用户将以带外方式查找和导入数据。

### JSON-RPC 更改

在实施本提案后，某些 JSON-RPC 端点（例如 `getBlockByHash`）将无法判断给定的哈希是无效的还是仅仅太旧。其他端点如 `getLogs` 将简单地不再拥有用户请求的数据。应用程序或客户端应如何处理这种回归超出了本提案的范围。

## 安全考虑

### 依赖弱主观性

随着向 PoS 的转变，使用有效的弱主观性检查点对于安全至关重要，因为存在长程攻击的风险。

本提案依赖于弱主观性假设，并假设客户端不会使用无效或过旧的 WS 检查点进行启动。

本提案还假设弱主观性周期永远不会超过 `HISTORY_PRUNE_EPOCHS`。如果发生这种情况，具有旧弱主观性检查点的客户端将无法进行“检查点同步”，因为 p2p 网络将无法提供所需的数据。

### 中心化/审查风险

如果缺乏保留历史数据的激励，将存在审查/可用性风险。

确保以太坊历史数据由独立组织保留和播种非常重要，并且其可用性应频繁检查。我们认为这些机制超出了本提案的范围。

此外，更多的去中心化应用程序可能会依赖中心化服务来获取历史数据，因为设置完整节点将变得更加困难。

### 与其他提案的混淆

由于有许多替代提案旨在减少执行客户端在磁盘上的占用，我们决定强制执行 EIP 的特定发音。在发音 EIP 编号时，**必须**发音为 EIP “四四”。所有其他发音都是不正确的。

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。