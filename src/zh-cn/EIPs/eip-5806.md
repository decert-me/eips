---
eip: 5806
title: 委托交易
description: 添加了一种新交易类型，允许外部拥有账户（EOA）通过委托执行任意代码
author: Hadrien Croubois (@Amxx)
discussions-to: https://ethereum-magicians.org/t/eip-5806-delegate-transaction/11409
status: 草案
type: 标准跟踪
category: 核心
created: 2022-10-20
requires: 2718, 2930
---

## 摘要

此 EIP 添加了一种新交易类型，允许外部拥有账户（EOA）使用类似委托调用的机制执行任意代码。

## 动机

EOA 是最广泛使用的账户类型，但其执行操作的能力仅限于部署合约和发送“调用”交易。目前，EOA 无法执行任意代码，这极大限制了用户与区块链的交互。账户抽象已被广泛讨论，但向主流采用的路径仍不明确。一些方法，如 [ERC-4337](./eip-4337.md)，希望改善智能钱包的可用性，但未解决应用程序对智能钱包的支持问题。

虽然智能合约钱包在用户体验方面有很多优势，但由于相关成本以及某些 EOA 拥有不可转让资产的事实，所有用户不太可能很快迁移。

此 EIP 提出了一种方法，允许 EOA 执行任意代码，且对 EVM 的更改最小，并使用用户习惯的相同安全模型。通过允许 EOA 对合约执行委托调用（类似于合约如何使用 [EIP-7](./eip-7.md) 委托调用其他合约），EOA 将能够更好地控制他们想要执行的操作。该提案的目标不是提供账户抽象原语。

通过对多调用合约（例如部署到 `0xcA11bde05977b3631167028862bE2a173976CA11` 的合约）执行委托调用，EOA 将能够将多个交易批量处理为一个交易（成为所有子调用的 `msg.sender`）。这将为希望与协议交互的用户提供更好的用户体验（无需多次交易，避免可变的 gas 价格和 21k gas 的开销），并提高此类交互的安全性（通过避免在 `approval` 和随后的 `transferFrom` 之间被利用的不安全代币批准）。

其他未预见的逻辑可以在智能合约中实现并被 EOA 使用。这包括发出事件。

此 EIP 并不旨在取代其他账户抽象提案。它希望成为一种易于实现的替代方案，能够显著改善 EOA 拥有者的用户体验。

## 规范

本文档中的关键词“必须”、“必须不”、“要求”、“应”、“应不”、“应该”、“应该不”、“推荐”、“可以”和“可选”应按 RFC 2119 中的描述进行解释。

### 参数

- `FORK_BLKNUM` = `待定`
- `TX_TYPE` = 待定, > 0x03 ([EIP-4844](./eip-4844.md))

从 `FORK_BLOCK_NUMBER` 开始，引入一种新的 [EIP-2718](./eip-2718.md) 交易，`TransactionType` = `TX_TYPE(待定)`。

新交易的内在成本继承自 [EIP-2930](./eip-2930.md)，具体为 `21000 + 16 * 非零 calldata 字节 + 4 * 零 calldata 字节 + 1900 * 访问列表存储键计数 + 2400 * 访问列表地址计数`。

该交易的 [EIP-2718](./eip-2718.md) `TransactionPayload` 为

```
rlp([chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, destination, data, access_list, signature_y_parity, signature_r, signature_s])
```

所有字段的定义遵循与 [EIP-1559](./eip-1559.md) 相同的语义。请注意此交易中缺少 `amount` 字段！

`to` 字段的语义略有不同，唯一的例外是它必须不为 nil，因此必须始终表示一个 20 字节地址。这意味着委托交易不能具有创建交易的形式。

此交易的 `signature_y_parity, signature_r, signature_s` 元素表示对 `keccak256(TX_TYPE || rlp([chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, destination, data, access_list]))` 的 secp256k1 签名。

该交易的 [EIP-2718](./eip-2718.md) `ReceiptPayload` 为 `rlp([status, cumulative_transaction_gas_used, logs_bloom, logs])`。

此新交易类型的执行等同于 [EIP-7](./eip-7.md) 中引入的委托调用机制，但由 EOA（交易发送者）执行。这意味着 `destination` 中的代码（如果有）应在发送者的上下文中执行。因此，此类交易将从 EOA 发出事件或使用 `Create2`，以 EOA 的地址作为创建者。不过，此交易包含一些限制。

### 操作码限制

出于安全原因，某些操作码不应在 EOA 的上下文中执行：

- `SSTORE` (0x55)：在 EOA 下设置存储会破坏许多假设。特别是，通过委托交易设置的存储可能会导致问题，如果账户稍后使用 [EIP-7377](./eip-7377.md) 或类似方法“迁移”。此外，如果单个 EOA 使用委托交易来针对以不同方式解释该账户下存储布局的代码，存储可能会成为冲突的来源。出于所有这些原因，EOA 应被禁止在委托交易的上下文中执行 `SSTORE`。如果委托交易执行 CALL，调用的目标可以正常操作存储。

- `CREATE` (0xF0)、`CREATE2` (0xF5) 和 `SELFDESTRUCT` (0xFF)：可能会期望来自特定发送者的交易应具有连续的 nonce。如果 EOA 能够执行一个或多个操作来更改发送者账户的 nonce，这一假设将被打破。因此，执行委托交易的 EOA 不应能够使用 `CREATE`、`CREATE2` 或 `SELFDESTRUCT` 操作码。如果委托交易执行 CALL，调用的目标可以正常创建合约。

任何尝试执行这些受限操作的行为将抛出异常。

## 理由

EOA 是最广泛使用的钱包类型。

此 EIP 将通过使用在 [EIP-7](./eip-7.md) 中引入的预先存在且易于理解的委托机制，极大地扩展 EOA 与智能合约的交互能力，而无需向 EVM 添加新复杂性。

## 向后兼容性

由于交易封装 ([EIP-2718](./eip-2718.md))，没有已知的向后兼容性问题。

由于包含逻辑和 gas 成本与类型 2 交易相似，因此应该可以将这种新交易类型包含在同一内存池中。

## 安全考虑

已在其他交易类型中使用的 nonce 机制可以防止重放攻击。与现有交易类型类似，委托交易可以通过用支付更多费用的虚拟交易替换来取消。

由于钱包签署的对象是交易，而不是可能以多种方式处理的签名（如 [EIP-3074](./eip-3074.md) 的情况），因此与签名滥用相关的风险降低。钱包可以模拟此委托交易的执行，并提供良好的保证，确保用户签署的操作不会被篡改。

通过此机制调用的合约可以代表签署者执行任何操作。与其他交易类型一样，签署者在签署委托交易时应非常小心。
## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。