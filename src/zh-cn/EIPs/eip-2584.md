---
eip: 2584
title: 使用覆盖树进行 Trie 格式转换
author: Guillaume Ballet (@gballet)
discussions-to: https://ethresear.ch/t/overlay-method-for-hex-bin-tree-conversion/7104
status: Stagnant
type: Standards Track
category: Core
created: 2020-04-03
---

## 简单总结

本 EIP 提出了将状态 trie 格式从十叉格式转换为二叉格式的方法：新值直接存储在“覆盖”十叉 trie 的二叉 trie 中。同时，十叉 trie 在后台被转换为二叉 trie。当该过程完成后，两个层次将被合并。

## 摘要

本 EIP 描述了一个四阶段的转换过程。

  * 在第一阶段，所有新的状态写入都在覆盖二叉 trie 中进行，同时十叉 trie 正在转换为二叉格式。区块格式被更改为具有两个存储根：十叉 trie 的根（以下简称为“基础” trie）和覆盖二叉 trie 的根。
  * 在给予矿工足够的时间进行转换后，第二阶段开始。覆盖树逐渐合并回新转换的二叉基础 trie。固定数量的条目从覆盖树中删除并插入到基础 trie 中。
  * 第三阶段和最后阶段在覆盖 trie 为空时开始。持有其根的字段从区块头中移除。

## 动机

长期以来，人们对将状态 trie 从十叉格式切换到二叉格式产生了兴趣，原因涉及证明和存储大小。转换过程存在赶上问题，由于完整状态的庞大规模，无法在合理的时间内完成转换（即在与区块时间相同的数量级上）。

## 规范

本规范遵循 [黄皮书](https://ethereum.github.io/yellowpaper) 中引入的符号。在阅读之前，建议熟悉黄皮书。

### 二叉 trie

本 EIP 假设二叉 trie 的定义类似于 MPT，除了：

  * I₀ 中的字节序列被视为一系列 _位_，因此 ∀i≤256，I₀[i] 是键 I₀ 中的第 i 位
  * **扩展** 或 **叶子** 的第一个项目是用位替换 nibbles；
  * **分支** 是一个包含两个项目的结构，其中两个项目对应于在遍历过程中此时键的两个可能位值；
  * c(𝕴,i) ≡ RLP((u(0), u(1)) 在分支中，其中 u(j) = n({I : I ∈ 𝕴 ⋀ I₀[i] = j}, i+1)

设 ß 为函数，给定一个十叉 trie，计算该 trie 在上述二叉 trie 格式中的等效表示。

### 第一阶段

设 _h₁_ 为之前商定的第一阶段开始的区块高度，_h₂_ 为第二阶段开始的区块。在每个高度为 h₁ ≤ _h_ < h₂ 的区块中：

  0. 启动一个后台转换过程，将十叉 trie 转换为其二叉等效形式。该过程的最终目标是计算 _转换后的二叉 trie 的根哈希_，记为 Hᵣ²。十叉 trie 的根在此称为 Hᵣ¹⁶。形式上，该过程写作 Hᵣ² ≡ ß(Hᵣ¹⁶)。
  1. 区块头包含一个新的 Hₒ 字段，即 _覆盖二叉 trie 的根_；
  2. Hᵣ ≡ P(H)ᵣ¹⁶，即只要从十叉到二叉的转换尚未完成，十叉 trie 的根与其父区块的根相同。

执行环境中的以下内容发生变化：

  * 在执行 _状态读取_ 时，ϒ 首先在覆盖 trie 中搜索地址。如果在此处找不到键，ϒ 然后在基础 trie 中搜索，就像在高度 h' < h₁ 的区块中一样；
  * 在执行 _状态写入_ 时，ϒ 将值插入或更新到覆盖树中。基础树保持不变；
  * 如果一个账户被删除，ϒ 在该账户的地址插入空哈希 H(∅) 以标记其删除；从该地址读取的行为与缺失账户相同，无论基础 trie 中存在什么。

第一阶段在区块高度 h₂ 结束，该高度设置得足够远，以便为矿工提供足够的时间进行转换。

### 第二阶段

  本阶段与前一阶段的不同之处在于以下几点：

  * 在区块高度 h₂ 时，在执行 ϒ 之前，Hᵣ ≡ Hᵣ²，即在执行转换函数之前的值被设置为转换后的 _二叉基础 trie 的根_；
  * Hₒ 仍然存在于区块树中，但覆盖 trie 的内容只能 _被读取或删除_；
  * 在区块高度 h ≥ h₂ 时，在执行 ϒ 之前，从二叉覆盖 trie 中删除 N 个账户并插入到二叉基础 trie 中；
  * 在执行 _状态写入_ 时，ϒ 将值插入或更新到 _基础_ trie 中。如果搜索键存在于覆盖 trie 中，则将其删除。

账户删除根据以下规则执行：

  * 选择覆盖树中剩余的前 N 个账户（按字典顺序）；对于每个账户：
  * 如果值为空哈希，则从二叉基础 trie 中删除相同地址的账户；
  * 否则，将覆盖 trie 值插入/更新到基础 trie 中的相应地址。

当覆盖 trie 为空时，第二阶段结束，第三阶段开始。

### 第三阶段

第三阶段与第二阶段相同，除了以下更改：

  * Hₒ 从区块头中删除

## 理由

到目前为止讨论的方法包括“停止世界”方法，在此方法中，链在转换所需的相当长的时间内停止，以及“写时复制”方法，在此方法中，分支在被访问时转换。
这里建议的方法的优点在于，在转换过程中链继续正常运行，并且树在可预测的时间内完全转换为二叉格式。

## 向后兼容性

这需要一个分叉，并将打破向后兼容性，因为哈希和区块格式必然会不同。这将导致不实现覆盖树的客户端与那些不接受新二叉根的客户端之间的分叉。没有提出任何缓解措施，因为这是一个硬分叉。

## 测试用例

  * 对于第一阶段的测试，只需检查十叉 trie 中的每个键在二叉 trie 中也可用。一个更宽松但更快的测试随机选择十叉 trie 中的 1% 键，并检查它们是否存在于二叉 trie 中；
  * 第二和第三阶段待定

## 实现

转换过程的原型版本（第一阶段）可在 `geth` 中找到 [此 PR](https://github.com/holiman/go-ethereum/pull/12)。

## 安全考虑

我可以预见到三种攻击向量：

  * 一种针对性的攻击，可能导致覆盖 trie 不合理地庞大。由于在过渡过程中 gas 成本可能会增加，延长第二阶段将使以太坊在一段时间内变得更加昂贵。这可以通过在第一阶段增加 `SSTORE` 的成本来解决。
  * 相反，如果 h₂ 来得太快，大多数矿工可能无法及时生成 Hᵣ² 的正确值。
  * 如果一个代表超过 51% 网络的矿工组报告无效值，他们可能会在没有人发言的情况下窃取资金。

## 社区反馈

  * 初步测试表明，一台快速的机器可以在大约 30 分钟内完成转换。
  * 本 EIP 的初始版本期望矿工对二叉基础根的值进行投票。由于该过程的复杂性以及该功能已由“最长链”规则保证，因此已将其删除。
## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。