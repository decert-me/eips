---
eip: 1344
title: ChainID 操作码
author: Richard Meissner (@rmeissner), Bryant Eisenbach (@fubuloubu)
discussions-to: https://ethereum-magicians.org/t/add-chain-id-opcode-for-replay-protection-when-handling-signed-messages-in-contracts/1131
category: Core
type: Standards Track
status: Final
created: 2018-08-22
requires: 155
---

## 摘要
此 EIP 添加了一个操作码，返回当前链的 EIP-155 唯一标识符。

## 动机
[EIP-155](./eip-155.md) 提议使用链 ID 来防止不同链之间的重放攻击。在处理签名时，在智能合约中拥有相同的可能性将是一个巨大的好处，特别是对于使用 [EIP-712](./eip-712.md) 的 Layer 2 签名方案。

## 规范
在 0x46 添加一个新的操作码 `CHAINID`，该操作码使用 0 个栈参数。它将当前链 ID 推送到栈上。链 ID 是一个 256 位的值。执行该操作的成本为 `G_base`。

当前链 ID 的值是从链 ID 配置中获取的，该配置应与客户端将接受的来自传入交易的 EIP-155 唯一标识符相匹配。请注意，根据 EIP-155，交易不*要求*具有 EIP-155 唯一标识符，但在这种情况下，此操作码仍将返回配置的链 ID，而不是默认值。

## 理由
EIP-712 提出的当前方法是在编译时指定链 ID。使用这种方法在硬分叉后会导致问题，以及可能导致资金损失或对签名消息的重放攻击的人为错误。
通过添加提议的操作码，将能够访问当前链 ID 并基于此验证签名。

目前，没有关于如何为特定网络设置链 ID 的规范，依赖于客户端实现者和链社区手动做出的选择。在“有争议的分裂”场景中，使用特定链 ID 值的社区可能会决定分裂成两个这样的链。当这种情况发生时，在两个链上保持相同的链 ID 值将是不安全的，因为链 ID 用于协议内交易的重放保护（根据 EIP-155），以及 L2 和“元交易”用例（根据 EIP-712，如本提案所启用）。在当前流程下，这种情况下有两种潜在的解决方案：1）一个链决定修改其链 ID 值（而另一个保持不变），或 2）两个链都决定修改其链 ID 值。

为了减轻这种情况，提议的 `CHAINID` 操作码的用户**必须**确保他们的应用程序能够处理在使用应用程序期间链 ID 值的潜在更新，以便在需要继续使用应用程序时。如果链 ID 发生变化，可以实现一个无信任的预言机，记录链 ID 变更时的时间戳，可以作为应用程序合约系统中的应用级功能实现，或作为全球标准合约引用。未能为这种情况提供缓解措施可能导致之前签署的离线消息突然失去合法性，这可能在结算期间和其他长期验证事件中造成问题。并非所有使用此操作码的应用程序都需要缓解措施来处理这种情况，但开发人员应逐案提供理由。

一个不适合利用全球预言机的场景示例是 Plasma L2 范式。在 Plasma 范式中，操作员或一组操作员将来自 L2 网络的区块提交到基础链（在这种情况下是以太坊），总结在该链上发生的交易。这些区块的提交可能与主链上的重大事件（例如导致链 ID 更新的分裂）不完全对齐，如果链 ID 用于签名消息，可能会导致协议的重大安全隐患。如果操作员无法控制链 ID 的更新，他们将无法与区块提交完美同步更新，某些过去的交易可能会被拒绝，因为它们与更新不对齐。这是试图在有争议的分裂期间过多指定链 ID 行为的意外后果之一，以及为什么拥有一个简单的操作码来访问是最优的，而不是更复杂的预编译或合约。

这个提议的操作码将是实现此功能的最简单方法，并允许开发人员在需要时灵活地实现自己的全球或本地链 ID 变更处理。

## 向后兼容性
此 EIP 与所有实现 EIP-155 链 ID 域分隔符用于交易签名的链完全向后兼容。

## 参考
这之前作为 [EIP-901](https://github.com/ethereum/EIPs/issues/901) 的一部分被建议。

## 测试用例
测试用例已添加到 [ethereum/tests](https://github.com/ethereum/tests/pull/627)

## 实现
Trinity Python 客户端的参考实现 [在这里](https://github.com/ethereum/py-evm/pull/1803)。

一个无信任链 ID 预言机的示例实现 [在这里](https://github.com/fubuloubu/chain-id-oracle/blob/master/ChainIdOracle.vy)。

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。