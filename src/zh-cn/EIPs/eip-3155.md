---
eip: 3155
title: EVM 跟踪规范
description: EVM 跟踪的 JSON 格式
author: Martin Holst Swende (@holiman), Marius van der Wijden (@MariusVanDerWijden)
discussions-to: https://ethereum-magicians.org/t/eip-3155-create-evm-trace-specification/5007
status: Review
type: Standards Track
category: Interface
created: 2020-12-07
---

## 摘要

引入一种新的 JSON 标准，用于在状态测试执行期间记录 EVM 跟踪。

## 动机

以太坊虚拟机在以太坊上执行所有智能合约代码。
为了更好地调试智能合约和状态测试，引入了一种通用格式来记录 EVM 的每个执行步骤。
该格式已由 Go-Ethereum、Parity-Ethereum、Nethermind 和 Besu 实现。
由于通用格式未明确定义，导致实现略有不同，使得开发适当的工具变得困难，从而显著降低了跟踪的实用性。

此 EIP 有多个目标：

- 将规范移至更显眼的位置，以鼓励新客户端实现它
- 严格定义在先前版本中未解决的边界情况
- 允许在执行期间引入新字段时更新规范
- 提供示例输出

在所有主要客户端中实现此 EIP 使我们能够创建有意义的差异模糊测试工具，以对主网和所有即将到来的硬分叉的 EVM 实现进行模糊测试。
它还帮助在链分裂的情况下快速找到执行差异。

此 EIP 将使用户能够创建更好的差异模糊测试基础设施，以比较所有主要以太坊客户端的 EVM 实现。
这可能有助于发现当前存在于客户端实现中的错误。

## 规范

客户端应能够执行简单的交易以及代码并返回跟踪。以下，我们将称此客户端为 CUT（待测试客户端），并使用 Go-Ethereum 的
`evm` 二进制文件作为代码示例。

### 数据类型

| 类型       | 说明                                                        | 示例                 |
|------------|-------------------------------------------------------------|---------------------|
| 数字      | 普通 JSON 数字                                              | "pc":0              |
| 十六进制数字 | 十六进制编码的数字                                        | "gas":"0x2540be400" |
| 字符串    | 普通字符串                                                  | "opName":"PUSH1"    |
| 十六进制字符串 | 十六进制编码的字符串                                    |                     |
| x 的数组  | 编码值的数组                                                |                     |
| 键值对    | 以十六进制字符串编码的键值结构                            |                     |
| 布尔值    | JSON 布尔值可以是 true 或 false                            | "pass": true        |

### 输出

CUT 必须为每个操作输出一个 `json` 对象。

#### 必需字段

| 名称         | 类型                 | 说明                                      |
|--------------|----------------------|-------------------------------------------|
| `pc`         | 数字                 | 程序计数器                                |
| `op`         | 数字                 | 操作码                                    |
| `gas`        | 十六进制数字         | 执行此操作前剩余的 gas                    |
| `gasCost`    | 十六进制数字         | 此操作的 gas 成本                         |
| `memSize`    | 数字                 | 内存数组的大小                            |
| `stack`      | 十六进制数字数组     | 堆栈上所有值的数组                        |
| `depth`      | 数字                 | 调用堆栈的深度                            |
| `returnData` | 十六进制字符串       | 函数调用返回的数据                        |
| `refund`     | 十六进制数字         | 退还的 **全局** gas 数量                  |

#### 可选字段

| 名称          | 类型                 | 说明                                                         |
|---------------|----------------------|--------------------------------------------------------------|
| `opName`      | 字符串               | 操作的名称                                                   |
| `error`       | 十六进制字符串       | 错误的描述（如果支持，应包含回退原因）                       |
| `memory`      | 十六进制字符串数组   | 所有分配值的数组                                           |
| `storage`     | 键值对               | 所有存储值的数组                                           |

*示例：*

```
{"pc":0,"op":96,"gas":"0x2540be400","gasCost":"0x3","memory":"0x","memSize":0,"stack":[],"depth":1,"error":null,"opName":"PUSH1"}
```

- `stack`、`memory` 和 `memSize` 是操作执行 *之前* 的值。
- 所有数组属性（`stack`、`memory`）必须初始化为空数组（`"stack":[]`），而不是 null。
- 如果 CUT 不会输出 `memory` 或 `storage` 的值，则省略 `memory` 和 `storage` 字段。
  这可能是因为 CUT 不支持跟踪这些字段，或者已配置为不跟踪它。
- `memSize` 字段必须存在，无论是否支持 `memory`。
- 客户端应实现一种方法来禁用记录存储，因为状态根包含所有存储更新。
- 客户端应按本 EIP 中列出的顺序输出字段。

如果发生错误，CUT 不得为 `STOP` 操作输出一行：

*示例：*

```
{"pc":2,"op":0,"gas":"0x2540be3fd","gasCost":"0x0","memory":"0x","memSize":0,"stack":["0x40"],"depth":1,"error":null,"opName":"STOP"}
```

### 摘要和错误处理

在执行结束时，CUT 必须打印摘要信息；此信息应包含以下字段。
摘要应为单个 `jsonl` 对象。

#### 必需字段

| 名称        | 类型       | 说明                                            |
|-------------|------------|--------------------------------------------------|
| `stateRoot` | 十六进制字符串 | 执行交易后状态树的根                          |
| `output`    |            | 函数的返回值                                    |
| `gasUsed`   | 十六进制数字 | 交易使用的所有 gas                              |
| `pass`      | 布尔值    | 交易是否成功执行的布尔值                        |

#### 可选字段

| 名称   | 类型   | 说明                                           |
|--------|--------|-------------------------------------------------|
| `time` | 数字   | 执行交易所需的时间（以纳秒为单位）            |
| `fork` | 字符串 | 执行中使用的分叉规则的名称                    |

*示例*：

```
{"stateRoot":"0xd4c577737f5d20207d338c360c42d3af78de54812720e3339f7b27293ef195b7","output":"","gasUsed":"0x3","pass":"true","time":141485}
```

## 理由

此 EIP 在很大程度上基于先前非官方的 EVM 跟踪文档。
它试图涵盖尽可能多的边界情况，以实现真正的客户端兼容性。
数据类型以及字段是否可选的选择旨在与当前实现尽可能兼容。

## 向后兼容性

此 EIP 与以太坊完全向后兼容，因为它仅引入了可选的更好跟踪基础设施供客户端实现。

### 客户端

此 EIP 与 Go-Ethereum 完全向后兼容。OpenEthereum、Besu 和 Nethermind 客户端需要稍微更改其 `openethereum-evm`、`evmtool` 和
`nethtest` 的 JSON 输出，以遵循新的更严格的规范。新客户端需要实现此更改，如果他们希望成为差异模糊测试组的一部分。
## 测试用例

```bash
${BESU_HOME}/bin/evmtool --code 0x604080536040604055604060006040600060025afa6040f3 {"pc":0,"op":96,"gas":"0x2540be400","gasCost":"0x3","memSize":0,"stack":[],"depth":1,"refund":0,"opName":"PUSH1"}
{"pc":2,"op":128,"gas":"0x2540be3fd","gasCost":"0x3","memSize":0,"stack":["0x40"],"depth":1,"refund":0,"opName":"DUP1"}
{"pc":3,"op":83,"gas":"0x2540be3fa","gasCost":"0xc","memSize":0,"stack":["0x40","0x40"],"depth":1,"refund":0,"opName":"MSTORE8"}
{"pc":4,"op":96,"gas":"0x2540be3ee","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":[],"depth":1,"refund":0,"opName":"PUSH1"}
{"pc":6,"op":96,"gas":"0x2540be3eb","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40"],"depth":1,"refund":0,"opName":"PUSH1"}
{"pc":8,"op":85,"gas":"0x2540be3e8","gasCost":"0x4e20","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x40"],"depth":1,"refund":0,"opName":"SSTORE"}
{"pc":9,"op":96,"gas":"0x2540b95c8","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":[],"depth":1,"refund":0,"opName":"PUSH1"}
{"pc":11,"op":96,"gas":"0x2540b95c5","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40"],"depth":1,"refund":0,"opName":"PUSH1"}
{"pc":13,"op":96,"gas":"0x2540b95c2","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x0"],"depth":1,"refund":0,"opName":"PUSH1"}
{"pc":15,"op":96,"gas":"0x2540b95bf","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x0","0x40"],"depth":1,"refund":0,"opName":"PUSH1"}
{"pc":17,"op":96,"gas":"0x2540b95bc","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x0","0x40","0x0"],"depth":1,"refund":0,"opName":"PUSH1"}
{"pc":19,"op":90,"gas":"0x2540b95b9","gasCost":"0x2","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x0","0x40","0x0","0x2"],"depth":1,"refund":0,"opName":"GAS"}
{"pc":20,"op":250,"gas":"0x2540b95b7","gasCost":"0x24abb676c","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x0","0x40","0x0","0x2","0x2540b95b7"],"depth":1,"refund":0,"opName":"STATICCALL"}
{"pc":21,"op":96,"gas":"0x2540b92a7","gasCost":"0x3","memory":"0xf5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a92759fb4b00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x1"],"returnData":"0xf5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a92759fb4b","depth":1,"refund":0,"opName":"PUSH1"}
{"pc":23,"op":243,"gas":"0x2540b92a4","gasCost":"0x0","memory":"0xf5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a92759fb4b00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x1","0x40"],"returnData":"0xf5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a92759fb4b","depth":1,"refund":0,"opName":"RETURN"}
{"stateRoot":"0x8fa0dcc7f1d2383c89e5737c2843632db881c0946e80b71fe7175365e6538797","output":"0x40","gasUsed":"0x515c","pass":true,"fork":"Istanbul"}
```

## 安全考虑

追踪是昂贵的。

公开暴露用于创建追踪的端点可能会打开拒绝服务的攻击向量。

客户端应考虑将追踪端点放在与其他端点不同的标志后面。

## 版权

通过 [CC0](../LICENSE.md) 放弃版权及相关权利。