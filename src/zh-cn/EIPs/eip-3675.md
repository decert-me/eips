---
eip: 3675
title: 升级共识至权益证明
description: 以太坊主网上共识机制升级的规范，引入权益证明
author: Mikhail Kalinin (@mkalinin), Danny Ryan (@djrtwo), Vitalik Buterin (@vbuterin)
discussions-to: https://ethereum-magicians.org/t/eip-3675-upgrade-consensus-to-proof-of-stake/6706
status: 最终
type: 标准跟踪
category: 核心
created: 2021-07-22
requires: 2124
---


## 摘要

本 EIP 废弃了工作量证明（PoW），并用新的权益证明共识机制（PoS）取而代之，该机制由信标链驱动。有关新共识机制引导的详细信息记录在 [EIP-2982](./eip-2982.md) 中。信标链的完整规范可以在 `ethereum/consensus-specs` 仓库中找到。

本文档指定了共识升级所引入的区块结构、区块处理、分叉选择规则和网络接口的更改集。


## 动机

信标链网络自 2020 年 12 月以来一直在运行。在此期间未检测到安全性或活跃性故障。这段长时间的无故障运行证明了信标链系统的可持续性及其作为以太坊主网安全提供者的准备。

要了解引入权益证明共识的动机，请参见 [EIP-2982](./eip-2982.md#motivation) 的动机部分。


## 规范

### 定义

* **PoW 区块**：由现有的工作量证明机制构建和验证的区块。换句话说，是共识升级之前以太坊网络的区块。
* **PoS 区块**：由新的权益证明机制构建和验证的区块。
* **终端 PoW 区块**：满足以下条件的 PoW 区块 --
`pow_block.total_difficulty >= TERMINAL_TOTAL_DIFFICULTY` *且* `pow_block.parent_block.total_difficulty < TERMINAL_TOTAL_DIFFICULTY`。
网络中可以有多个终端 PoW 区块，例如同一预终端区块的多个子区块。
* **`TERMINAL_TOTAL_DIFFICULTY`** 网络达到的总难度，触发共识升级。以太坊主网配置 **必须** 将此参数设置为 `58750000000000000000000`。
* **`TRANSITION_BLOCK`** 规范链的最早 PoS 区块，即具有最低区块高度的 PoS 区块。
* **`POS_FORKCHOICE_UPDATED`** 当权益证明分叉选择的状态更新时发生的事件。
* **`FORK_NEXT_VALUE`** 为即将到来的共识升级设置的 `FORK_NEXT` 参数的区块号。
* **`TERMINAL_BLOCK_HASH`** 指定终端 PoW 区块的哈希（如果设置），即如果未用 `0x0000000000000000000000000000000000000000000000000000000000000000` 进行占位。
* **`TERMINAL_BLOCK_NUMBER`** 如果设置了 `TERMINAL_BLOCK_HASH`，则指定终端 PoW 区块的编号。

#### PoS 事件

名称以 `POS_` 前缀的事件（PoS 事件）由新的权益证明共识机制发出。它们表示对事件指定的区块所做的相应断言。PoS 事件的基本逻辑可以在信标链规范中找到。每当发生 PoS 事件时，必须采取本 EIP 指定的相应行动。

在阅读涉及 PoS 事件的规范部分时，必须考虑以下细节：
* PoS 事件中包含的区块的引用以区块哈希的形式提供，除非另有明确说明。
* `POS_FORKCHOICE_UPDATED` 事件包含对规范链头和最近最终区块的引用。在系统中首次发生最终区块之前，此事件提供的最终区块哈希用 `0x0000000000000000000000000000000000000000000000000000000000000000` 进行占位。
* **`FIRST_FINALIZED_BLOCK`** 由 `POS_FORKCHOICE_UPDATED` 事件指定的第一个最终区块，其哈希与占位符不同。


### 客户端软件配置

以下参数集是客户端软件配置的一部分，**必须**包含在其二进制分发中：
* `TERMINAL_TOTAL_DIFFICULTY`
* `FORK_NEXT_VALUE`
* `TERMINAL_BLOCK_HASH`
* `TERMINAL_BLOCK_NUMBER`

*注意*：如果 `TERMINAL_BLOCK_HASH` 用 `0x0000000000000000000000000000000000000000000000000000000000000000` 进行占位，则 `TERMINAL_BLOCK_HASH` 和 `TERMINAL_BLOCK_NUMBER` 参数 **不得** 生效。


### PoW 区块处理

任何终端 PoW 区块的后代 PoW 区块 **不得** 被导入。这意味着终端 PoW 区块将是规范链中的最后一个 PoW 区块。


### 常量

| 名称 | 值 |
|-|-|
| **`MAX_EXTRA_DATA_BYTES`** | `32` |

### 区块结构

从 `TRANSITION_BLOCK` 开始，多个之前动态的区块字段通过强制这些值为常量而被废弃。下表中列出的每个区块字段 **必须** 被相应的常量值替换。

| 字段 | 常量值 | 注释 |
|-|-|-|
| **`ommersHash`** | `0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347` | `= Keccak256(RLP([]))` |
| **`difficulty`** | `0` |  |
| **`mixHash`** | `0x0000000000000000000000000000000000000000000000000000000000000000` |  |
| **`nonce`** | `0x0000000000000000` |  |
| **`ommers`** | `[]` | `RLP([]) = 0xc0`  |

从 `TRANSITION_BLOCK` 开始，区块的 **`extraData`** 字段的验证发生变化：区块的 **`extraData`** 的长度 **必须** 小于或等于 **`MAX_EXTRA_DATA_BYTES`** 字节。

*注意*：未在此处指定的区块字段的逻辑和有效性条件 **必须** 保持不变。此外，整体区块格式 **必须** 保持不变。

*注意*：后续的 EIP 可能会覆盖上述指定的常量值以提供额外功能。有关示例，请参见 [EIP-4399](./eip-4399.md)。


### 区块有效性

从 `TRANSITION_BLOCK` 开始，区块有效性条件 **必须** 通过以下方式进行更改：
* 移除对区块 **`difficulty`** 值与难度公式的验证。
* 移除对区块 **`nonce`** 和 **`mixHash`** 值与 Ethash 函数的验证。
* 移除对 ommers 列表及其每个成员的所有验证规则。
* 添加对 [区块结构](#block-structure) 部分中提到的字段的验证。

*注意*：如果新的规则之一失败，则区块 **必须** 被视为无效。

*注意*：未在上述列表中指定的有效性规则 **必须** 保持不变。

#### 过渡区块有效性

除了满足上述条件外，`TRANSITION_BLOCK` **必须** 是终端 PoW 区块的子区块。也就是说，`TRANSITION_BLOCK` 的父区块 **必须** 满足终端 PoW 区块条件。


### 区块和 ommer 奖励

从 `TRANSITION_BLOCK` 开始，区块和 ommer 奖励被废弃。具体而言，必须采取以下行动：
* 移除通过区块奖励增加区块 **`beneficiary`** 账户余额的操作。
* 移除通过每个 ommer 的 ommer 包含奖励增加区块 **`beneficiary`** 账户余额的操作。
* 移除通过每个 ommer 的 ommer 区块奖励增加 ommer 的 **`beneficiary`** 账户余额的操作。
*注意*: 影响区块 `beneficiary` 账户的交易费用机制 **必须** 保持不变。

### 分叉选择规则

如果设置，`TERMINAL_BLOCK_HASH` 参数将以以下方式影响 PoW 最重链规则：
* 规范区块链 **必须** 包含一个在 `TERMINAL_BLOCK_NUMBER` 参数定义的高度上，哈希值由 `TERMINAL_BLOCK_HASH` 参数定义的区块。

*注意*: 该规则类似于客户端软件实现中已经存在的区块哈希白名单功能。

从第一次 `POS_FORKCHOICE_UPDATED` 事件开始，分叉选择规则 **必须** 以以下方式进行更改：
* 移除现有的 PoW 最重链规则。
* 遵循新的 PoS LMD-GHOST 规则。

新的 PoS LMD-GHOST 分叉选择规则如下所示。在每次发生 `POS_FORKCHOICE_UPDATED` 事件时，包括第一次事件，必须采取以下行动：
* 将从创世区块开始到事件指定的头区块结束的链视为规范区块链。
* 将规范区块链的头设置为事件指定的相应区块。
* 从 `FIRST_FINALIZED_BLOCK` 开始，将最近的已最终确定区块设置为事件指定的相应区块。

与上述操作相关的区块树存储的更改 **必须** 以原子方式应用。

*注意*: 该规则 **必须** 严格执行。“乐观”更新头 **不得** 进行。也就是说——如果在当前头区块之上处理了一个新区块，只有在伴随的 `POS_FORKCHOICE_UPDATED` 事件发生时，这个新区块才会成为新的头。

### 网络

#### 分叉标识符

为了 [EIP-2124](./eip-2124.md) 分叉标识符的目的，实施此 EIP 的节点 **必须** 将 `FORK_NEXT` 参数设置为 `FORK_NEXT_VALUE`。

#### devp2p

如果它们宣传任何终端 PoW 区块的后代，网络堆栈 **不应** 发送以下消息：
* `NewBlockHashes (0x01)`
* `NewBlock (0x07)`

从接收 `FIRST_FINALIZED_BLOCK` 开始，网络堆栈 **必须** 丢弃以下入口消息：
* `NewBlockHashes (0x01)`
* `NewBlock (0x07)`

从接收紧接在 `FIRST_FINALIZED_BLOCK` 之后的已最终确定区块开始，网络堆栈 **必须** 移除与以下消息对应的处理程序：
* `NewBlockHashes (0x01)`
* `NewBlock (0x07)`

在处理程序被移除后，继续发送这些消息的对等方 **应** 被断开连接。

*注意*: 不受本节影响的消息处理程序的逻辑 **必须** 保持不变。

## 理由

本 EIP 中指定的更改旨在针对最小的共识和客户端软件修改集，以安全地用新的权益证明共识替换现有的工作量证明共识算法，该算法已在生产中的信标链上实现。

此 EIP 的设计旨在最小化热插拔以太坊网络实时共识的复杂性。操作的安全性和生产时间都被考虑在内。此外，最小的更改集有助于确保 *大多数* 智能合约和服务在过渡期间及之后能够继续按预期运行，几乎不需要干预。

### 触发升级的总难度

请参见 [安全考虑](#terminal-total-difficulty-vs-block-number)。

### 参数化终端区块哈希

请参见 [安全考虑](#terminal-pow-block-overriding)。

### 停止导入 PoW 区块

请参见 [安全考虑](#halt-the-importing-of-pow-blocks)。

### 用常量替换区块字段

已弃用的区块字段用常量值替换，以确保区块格式保持向后兼容。保留区块格式有助于现有智能合约和服务在此过渡期间及之后提供不间断的服务。

特别是，对于那些通过验证外部提供的区块头哈希与 `BLOCKHASH` 操作返回的相应值来验证交易/收据包含和状态的默克尔证明的智能合约，这一点尤为重要。

此更改引入了一条额外的有效性规则，强制替换已弃用的区块字段。

### 将 `difficulty` 替换为 `0`

在弃用工作量证明后，难度的概念不再存在，将区块头 **`difficulty`** 字段替换为 `0` 常量在语义上是合理的。

### 更改区块有效性规则

强制 PoW 密封有效性的规则集被相应的 PoS 规则替换，作为此更改背后的理由。

由于本规范引入的区块格式更改，要求对一组已弃用的区块字段进行额外的验证规则。

### 移除区块奖励

现有的区块生产和密封奖励与 PoW 机制一起被弃用。新的 PoS 共识在本规范生效后，既负责密封区块，也负责发放区块奖励。

### 取代分叉选择规则

PoW 机制的分叉选择规则在升级后完全无关紧要，并被新的 PoS 共识机制的相应规则所取代。

### 移除 `POS_CONSENSUS_VALIDATED`

在本 EIP 的早期草稿版本中，额外的 POS 事件——`POS_CONSENSUS_VALIDATED`——被要求作为区块的验证条件。该事件发出信号以完全合并或从区块树中修剪区块。

此事件被移除有两个原因：
1. 此事件是一个不必要的优化，允许从区块树中修剪“坏”区块。此优化是不必要的，因为 PoS 共识永远不会为任何此类坏区块或其后代发送 `POS_FORKCHOICE_UPDATED`，最终任何此类区块都可以在区块树中替代分支的 PoS 最终事件后被修剪。
2. 在某些情况下，此事件是危险的，因为一个区块可能被两个 *不同* 和冲突的 PoS 分支引用。因此，在某些情况下，对于同一个区块，可能会发送 `POS_CONSENSUS_VALIDATED == TRUE` 和 `POS_CONSENSUS_VALIDATED == FALSE` 事件，从而完全否定安全执行 (1) 中优化的能力。

### EIP-2124 分叉标识符

EIP-2124 中的 `FORK_NEXT` 值指的是给定节点已知的下一个分叉的区块号，若未知则为 `0`。

`TRANSITION_BLOCK` 的数量无法提前知道，因为过渡触发条件的动态性质。由于区块不会事先知道，节点无法将其编号用于 `FORK_NEXT`，因此使用显式设置的 `FORK_NEXT_VALUE`。

### 移除区块传播

在共识机制升级后，只有信标链网络将拥有足够的信息来验证区块。因此，由 `eth` 网络协议提供的区块传播将变得不安全，并被信标链网络中现有的区块传播所弃用。

建议客户端软件不要传播任何终端 PoW 区块的后代，以减少处理 P2P 组件的负担，并停止在具有未知安全属性的环境中操作。

### 限制 `extraData` 的长度
`extraData` 字段在黄皮书中定义为最大 `32` 字节。因此，主网和大多数 PoW 测试网将该值限制为 `32` 字节。较长的 `extraData` 字段被 clique 测试网和其他网络用于承载特殊的签名/共识方案。此 EIP 将 `extraData` 的长度限制为 `32` 字节，因为任何从其他共识机制过渡到信标链 PoS 共识机制的网络不再需要扩展或不受限制的 `extraData`。

## 向后兼容性

此 EIP 在区块有效性、区块奖励和分叉选择规则方面引入了向后不兼容性。

本文件所指定的共识升级设计不会对建立在以太坊之上的现有应用程序和服务引入向后不兼容性，除非这些应用程序和服务在下面的 [EVM](#evm) 部分中描述或以其他方式严重依赖 PoW 共识。

### EVM

尽管此 EIP 并未对 EVM 引入任何显式更改，但在某些地方可能会影响现有智能合约的逻辑。

#### DIFFICULTY

在此 EIP 生效后，`DIFFICULTY` 操作将始终返回 `0`，并通过将 **`difficulty`** 字段替换为 `0` 常量来弃用该字段。

*注意：* 修改 `DIFFICULTY` 语义以返回信标链累积的随机性正在考虑中，但将通过单独的 EIP 引入。

#### BLOCKHASH

在此 EIP 生效后，作为 `BLOCKHASH` 操作输出获得的伪随机数变得更加不安全，因为 PoW 机制（它减少了区块哈希的可变性）被 PoS 取代。

## 测试用例

* 区块有效性
	* 从 `TRANSITION_BLOCK` 开始，如果以下任何条件为真，则区块无效：
		* `ommersHash != Keccak256(RLP([]))`
		* `difficulty != 0`
		* `nonce != 0x0000000000000000`
		* `len(extraData) > MAX_EXTRA_DATA_BYTES`
  * 从 `TRANSITION_BLOCK` 开始，区块奖励不会添加到 `beneficiary` 账户
* 客户端软件遵循 PoS LMD-GHOST 规则
  * 头部和已最终确定的区块根据最近的 `POS_FORKCHOICE_UPDATED` 事件进行设置
  * 除非收到 `POS_FORKCHOICE_UPDATED` 事件，否则不会更新分叉选择状态
* 过渡过程
  * 客户端软件不处理任何超出终端 PoW 区块的 PoW 区块
  * 从 `TRANSITION_BLOCK` 开始，客户端软件应用新的区块有效性规则
  * 从第一次 `POS_FORKCHOICE_UPDATED` 开始，客户端软件将其分叉选择规则切换到 PoS LMD-GHOST
  * `TRANSITION_BLOCK` 必须是终端 PoW 区块的子区块
  * 在接收到 `FIRST_FINALIZED_BLOCK` 后，`NewBlockHashes (0x01)` 和 `NewBlock (0x07)` 网络消息将被丢弃

## 安全考虑

### 信标链

请参见 [EIP-2982](./eip-2982.md#security-considerations) 的安全考虑部分。

### 过渡过程

用于使本规范生效的过渡过程是硬分叉的更复杂版本——在以太坊网络中应用向后不兼容更改的常规程序。该过程有多个连续步骤，而不是简单硬分叉的正常区块高度点条件。

此升级过程的复杂性源于此分叉针对的是底层共识机制，而不是共识机制内的执行层。尽管设计尽可能寻求简单性，但在此过渡期间，安全性和活跃性考虑被优先考虑。

#### 终端总难度与区块编号

在此上下文中，使用预定义的区块编号进行硬分叉是不安全的，因为 PoS 分叉选择在过渡期间优先。

攻击者可能利用少数的哈希算力构建一个恶意链分叉，以满足区块高度要求。然后，可能会在此对抗性分叉的 PoW 区块上恶意提议第一个 PoS 区块，从而成为头部并颠覆过渡的安全性。

为了保护网络免受此攻击场景，使用链上累积的难度（总难度）来触发升级。

#### 在终端 PoW 区块之间跳转的能力

可能会出现终端 PoW 区块未被大多数网络参与者观察到的情况，这可能是由于（暂时的）网络分区。在这种情况下，这部分少数将其分叉选择切换到基于他们观察到的少数终端 PoW 区块的新规则。

过渡过程允许网络在具有不同终端 PoW 区块的分叉之间重新组织，只要 (a) 这些区块满足终端 PoW 区块条件，并且 (b) 尚未收到 `FIRST_FINALIZED_BLOCK`。这为过渡过程中的不利网络条件提供了弹性，并防止不可逆的分叉/分区。

#### 停止导入 PoW 区块

假设连接到信标链网络的客户端软件部分在以太坊网络达到 `TERMINAL_TOTAL_DIFFICULTY` 之前下线，并在网络达到此阈值时保持离线。这种事件使客户端软件无法切换到 PoS，并允许其继续跟随 PoW 链，如果该链在终端 PoW 区块之后继续构建。根据信标链部分离线的时间长短，可能会导致不同的不利影响，例如：
* 客户端没有终端 PoW 区块的后状态（状态已被修剪），这使其无法重新组织到 PoS 链，并将从头开始同步作为唯一的恢复选项。
* 应用程序、用户或服务使用来自错误分叉（持续构建的 PoW 链）的数据，这可能会导致他们那边的安全问题。

不导入超出终端 PoW 区块的 PoW 区块可以防止在软件或配置故障的情况下对安全性/重新组织造成的不利影响，*以支持* 活跃性故障。

#### 终端 PoW 区块覆盖

有一种机制允许在紧急情况下加速共识升级。
此 EIP 考虑以下紧急情况场景以加速生效：
* 网络哈希率下降，显著延迟升级。
* 升级前对 PoW 网络的攻击。

第一种情况可以通过更新以下参数安全地加速：
* `TERMINAL_TOTAL_DIFFICULTY` -- 重置为比原始值更接近的值。
* `FORK_NEXT_VALUE` -- 相应调整。

第二种更严重的攻击场景需要更具侵入性的覆盖：
* `TERMINAL_BLOCK_HASH` -- 设置为某个区块的哈希，以成为终端 PoW 区块。
* `TERMINAL_BLOCK_NUMBER` -- 设置为由 `TERMINAL_BLOCK_HASH` 指定的区块编号。
* `TERMINAL_TOTAL_DIFFICULTY` -- 设置为由 `TERMINAL_BLOCK_HASH` 指定的区块的总难度值。
* `FORK_NEXT_VALUE` -- 相应调整。

*注意：* 在第二种情况下的加速被认为是针对最极端的场景，因为这将导致以太坊主网出现非平凡的活跃性故障。

### 古老区块不再是网络安全的必要条件

在 PoW 网络中，从创世开始保留历史区块是至关重要的。每个属于特定链的区块的头部是证明该链相对于 PoW 密封的有效性的必要条件。
验证整个链的历史并不是新 PoS 机制所要求的。相反，PoS 网络中的同步过程依赖于弱主观性检查点，这些检查点是网络中节点共享的历史快照。这意味着超出弱主观性检查点的历史区块不再是确定规范区块链的必要条件。

弱主观性检查点的规范可以在 `ethereum/consensus-specs` 仓库中找到。


## 版权
通过 [CC0](../LICENSE.md) 放弃版权及相关权利。