---
eip: 140
title: REVERT 指令
author: Alex Beregszaszi (@axic), Nikolai Mushegian <nikolai@nexusdev.us>
type: Standards Track
category: Core
status: Final
created: 2017-02-06
---

## 简单总结

`REVERT` 指令提供了一种停止执行并撤销状态更改的方法，而不会消耗所有提供的 gas，并且能够返回一个原因。

## 摘要

`REVERT` 指令将停止执行，回滚到目前为止所做的所有状态更改，并提供一个指向内存部分的指针，该部分可以被解释为错误代码或消息。在此过程中，它不会消耗所有剩余的 gas。

## 动机

目前这是不可能的。从合约内部撤销交易有两种实际方法：耗尽 gas 或执行无效指令。这两种选项都会消耗所有剩余的 gas。此外，撤销 EVM 执行意味着所有更改，包括 LOG，都将丢失，并且没有办法传达中止 EVM 执行的原因。

## 规范

在 `block.number >= BYZANTIUM_FORK_BLKNUM` 的区块上，`REVERT` 指令被引入到 `0xfd`。它期望两个栈项，顶部项是 `memory_offset`，后面是 `memory_length`。它不产生任何栈元素，因为它停止执行。

`REVERT` 在内存和内存成本方面的语义与 `RETURN` 相同。由 `memory_offset` 和 `memory_length` 给出的字节序列在以下内容中称为“错误消息”。

`REVERT` 的效果是执行被中止，视为失败，状态更改被回滚。错误消息将可在返回数据缓冲区中提供给调用者，并且也将被复制到输出区域，即以与常规返回数据相同的方式处理。

`REVERT` 指令的成本等于 `RETURN` 指令的成本，即回滚本身不会消耗所有 gas，合约只需支付内存费用。

如果剩余的 gas 不足以覆盖 `REVERT` 的成本或发生栈下溢，则 `REVERT` 指令的效果将等同于常规的耗尽 gas 异常，即它将消耗所有 gas。

与所有其他失败情况一样，调用操作码在被调用者的 `REVERT` 操作码之后返回 `0` 到栈中。

如果在 `CREATE` 或 `CREATE2` 调用的上下文中使用 `REVERT`，则不会部署代码，`0` 被放入栈中，错误消息可在返回数据缓冲区中获得。

可选提供的内存部分的内容未由此 EIP 定义，但可以作为另一个信息性 EIP 的候选。

## 向后兼容性

此更改对过去创建的合约没有影响，除非它们包含 `0xfd` 作为指令。

## 测试用例

```
6c726576657274656420646174616000557f726576657274206d657373616765000000000000000000000000000000000000600052600e6000fd
```

应该：
- 返回 `0x726576657274206d657373616765` 作为 `REVERT` 数据，
- 键 `0x0` 的存储应保持未设置状态，并且
- 总共使用 20024 gas。

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。