---
eip: 3541
title: 拒绝以 0xEF 字节开头的新合约代码
author: Alex Beregszaszi (@axic), Paweł Bylica (@chfast), Andrei Maiboroda (@gumb0), Alexey Akhunov (@AlexeyAkhunov), Christian Reitwiessner (@chriseth), Martin Swende (@holiman)
discussions-to: https://ethereum-magicians.org/t/evm-object-format-eof/5727
status: Final
type: Standards Track
category: Core
created: 2021-03-16
---

## 摘要

不允许以 `0xEF` 字节开头的新代码被部署。已经存在于账户默克尔树中以 `0xEF` 字节开头的代码不受此更改的语义影响。

## 动机

符合 EVM 对象格式（EOF）的合约将在部署时进行验证。为了保证状态中的每个 EOF 格式合约都是有效的，我们需要防止已经部署（且未验证）的合约被识别为此格式。这将通过选择一个在任何已部署合约中不存在的 *magic* 字节序列来实现。为了防止搜索空间的增长并将分析限制在此分叉之前存在的合约中，我们不允许格式的起始字节（magic 的第一个字节）。

如果未来不部署 EVM 对象格式提案，*magic* 可以被其他依赖版本控制的功能使用。如果版本控制变得过时，可以通过允许以 `0xEF` 字节开头的合约再次被部署来简单地回滚此更改。

## 规范

在 `block.number == HF_BLOCK` 之后，新合约创建（通过创建交易、`CREATE` 或 `CREATE2` 指令）如果 _code_ 的第一个字节是 `0xEF`，将导致异常中止。

### 备注

*initcode* 是在 *create* 交易、`CREATE` 或 `CREATE2` 指令的上下文中执行的代码。*initcode* 通过 `RETURN` 指令返回 *code*，该代码被插入到账户中。有关更多信息，请参见黄皮书第 7 节（“合约创建”）。

操作码 `0xEF` 目前是一个未定义的指令，因此：*它不弹出任何栈项，也不推送任何栈项，并且在执行时会导致异常中止。* 这意味着以此指令开头的 *initcode* 或已部署的 *code* 将继续中止执行。

由于以 `0xEF` 开头的 *code* 导致的异常中止与在 *initcode* 执行期间可能发生的任何其他异常中止的行为完全相同，即在中止的情况下，提供给 `CREATE*` 或创建交易的所有 gas 都会被消耗。

## 理由

选择 `0xEF` 字节是因为它类似于 **E**xecutable **F**ormat。

使用未分配操作码的合约通常被认为存在语义变化的风险。因此，使用未分配的 `0xEF` 应该比选择已分配的操作码（如 `0xFD`（`REVERT`）、`0xFE`（`INVALID`）或 `0xFF`（`SELFDESTRUCT`））影响更小。可以说，虽然这样的合约可能不是很有用，但它们仍然使用有效的操作码。

2021 年 5 月对状态中 `18084433` 个合约的分析显示，没有以 `0xEF` 字节开头的现有合约，而以 `0xFD`、`0xFE` 和 `0xFF` 开头的合约分别有 1、4 和 12 个。

## 测试用例

以下每个测试用例可以在 3 种不同的上下文中执行：
- 创建交易（没有账户代码）
- `CREATE`，账户代码：`0x6000356000523660006000f0151560165760006000fd5b`（Yul 代码：`mstore(0, calldataload(0)) if iszero(create(0, 0, calldatasize())) { revert(0, 0) }`），
- `CREATE2`，账户代码：`0x60003560005260003660006000f5151560185760006000fd5b`（Yul 代码：`mstore(0, calldataload(0)) if iszero(create2(0, 0, calldatasize(), 0)) { revert(0, 0) }`）

| 案例  | Calldata | 预期结果 |
| -------- | -------- | -------- |
| 部署一个字节 `ef` | `0x60ef60005360016000f3` | 新合约未部署，交易失败 |
| 部署两个字节 `ef00` | `0x60ef60005360026000f3` | 新合约未部署，交易失败 |
| 部署三个字节 `ef0000` | `0x60ef60005360036000f3` | 新合约未部署，交易失败 |
| 部署 32 字节 `ef00...00` | `0x60ef60005360206000f3` | 新合约未部署，交易失败 |
| 部署一个字节 `fe` | `0x60fe60005360016000f3` | 新合约已部署，交易成功 |

## 向后兼容性

这是一个破坏性更改，因为以 `0xEF` 字节开头的新代码将无法部署，合约创建将导致失败。然而，由于字节码是从其第一个字节开始执行的，因此以 `0xEF` 作为第一个字节的代码本身是不可执行的。

虽然这意味着没有当前可执行的合约受到影响，但它确实拒绝了以 `0xEF` 字节开头的新数据合约的部署。

## 安全考虑

作者未意识到此更改带来的任何安全或拒绝服务风险。

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。