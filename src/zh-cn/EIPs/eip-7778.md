---
eip: 7778
title: 防止区块 gas 走私
description: 排除区块 gas 限制执行中的折扣和退款
author: Ben Adams (@benaadams)
discussions-to: https://ethereum-magicians.org/t/eip-7778-prevent-block-gas-smuggling/21234
status: 草案
type: 标准跟踪
category: 核心
created: 2024-10-01
---

通过排除某些 gas 折扣和退款来防止规避区块 gas 限制，除了那些反映实际计算工作减少的情况。

该提案旨在使区块 gas 使用与以太坊虚拟机（EVM）的实际工作负载保持一致，防止“区块 gas 走私”。它补充了 [EIP-7623](./eip-7623)，进一步减少最大区块大小及其方差，增强网络的稳定性和效率。

示例区块 `20878522` “使用” 28.5 MGas，但在该净值中还有 4.01 MGas 的退款，总计 32.51 MGas 毛；这比当前主网区块 gas 限制高出 2.51 MGas。

## **摘要**

该 EIP 修改了 gas 记账机制，以防止区块 gas 走私——即由于 gas 折扣和退款，交易中包含的消耗 gas 的操作超过了区块 gas 限制的情况。

通过排除这些折扣和退款在区块 gas 限制计算中的影响，除了那些对应于实际工作负载减少的情况（例如，热存储访问，`SSTORE` 恢复到原始值），该提案确保区块 gas 限制准确反映 EVM 的计算和存储工作负载。

它补充了 [EIP-7623](./eip-7623)，该提案提高了数据可用性（DA）交易的 calldata 成本，通过进一步减少最大区块大小和传输数据。

## **动机**

### **防止区块 gas 走私**

- **当前问题：**
  - gas 折扣和退款可以被利用，以在区块中包含比区块 gas 限制允许的更多操作。
  - 这种“走私”导致超大区块，从而导致网络不稳定和潜在的拒绝服务（DoS）向量。

- **变更的必要性：**
  - 使区块 gas 记账与实际 EVM 工作负载对齐。
  - 防止区块超出预期的计算限制。
  - 在不影响网络性能的情况下，保持用户对高效行为的激励。

### **补充 EIP-7623**

- **EIP-7623 目标：**
  - 提高 DA 密集型交易的 calldata 成本，以减少最大区块大小和方差。
  - 鼓励采用更高效的数据可用性解决方案（例如，来自 [EIP-4844](./eip-4844) 的 blobs）。

- **互补方法：**
  - 通过防止区块 gas 走私，我们进一步减少最大区块大小和传输数据。
  - 确保区块 gas 使用准确反映计算工作负载，增强 [EIP-7623](./eip-7623) 的有效性。

## **规范**

### **Gas 成本调整**

1. **用户 gas 成本：**

   - **`SSTORE` 操作：**
     - 用户在将存储重置为零或恢复到原始值时获得 gas 退款。
   - **热存储与冷存储访问成本：**
     - 用户在热存储访问时享受较低的 gas 成本。

2. **区块 gas 记账：**

   - **`SSTORE` 操作：**
     - **设置存储为零：**
       - 在区块 gas 记账中按全额收费，不减去退款。
     - **恢复存储到原始值：**
       - 在区块 gas 记账中获得折扣，反映工作负载减少（没有实际写入存储）。
   - **热存储与冷存储访问：**
     - 热存储访问的折扣在区块 gas 记账中保留，因为它们对应于减少的计算工作。
   - **其他折扣和退款：**
     - 排除与实际计算工作负载减少无关的任何折扣和退款在区块 gas 记账中。

### **交易 gas 计算（调整后）**

对于 [EIP-7623](./eip-7623) 的交易，使用的 gas (`tx.gasUsed`) 计算为：

```python
tx.gasUsed = {
    21000 \ 
    + 
    max (
        STANDARD_TOKEN_COST * tokens_in_calldata \
           + evm_gas_used \
           + isContractCreation * (32000 + InitCodeWordGas * words(calldata)),
        TOTAL_COST_FLOOR_PER_TOKEN * tokens_in_calldata
    )
```

对于 `evm_gas_used` 的这个 EIP，用户交易价格的 gas 使用保持不变：

```

tx.evm_gas_used = evm_gas_used - evm_gas_refund

```

但是在计算区块使用的 gas 时，不考虑退款

```

block.evm_gas_used += evm_gas_used

```

- **对于用户成本：**
  - 用户根据上述公式支付，反映出 DA 密集型交易的成本增加。
- **对于区块 gas 记账：**
  - 应用相同的计算，但排除与实际工作负载减少无关的折扣和退款。

### **区块 gas 限制执行**

- **区块 gas 使用：**
  - 所有交易使用的 gas 总和，按照调整后的规则计算，必须不超过区块 gas 限制。

### **实施**

- **客户端更新：**
  - 调整 gas 记账机制，以整合 [EIP-7623](./eip-7623) 和修改后的区块 gas 记账规则。
- **交易处理：**
  - 更新交易验证，以应用调整后的 calldata 成本和区块 gas 记账。

## **理由**

### **防止区块 gas 走私**

- **使工作负载与区块 gas 限制对齐：**
  - 排除某些折扣和退款确保区块 gas 限制反映实际的计算和存储工作负载。
- **减少最大区块大小和方差：**
  - 防止超大区块对网络造成负担。
- **维护用户激励：**
  - 用户继续受益于与实际工作负载减少相对应的折扣。
- **增强网络稳定性：**
  - 准确的 gas 记账减少了网络拥堵和 DoS 攻击的风险。

### **补充 EIP-7623**

- **增强减少区块大小和传输数据：**
  - 通过将提高的 calldata 成本与调整后的区块 gas 记账结合，我们有效减少最大区块大小。
- **鼓励高效数据使用：**
  - DA 密集型交易面临更高的成本，激励采用高效的数据可用性方法（例如 blobs）。
- **对普通用户的影响最小：**
  - 普通交易在成本和包含方面基本不受影响。

### **向后兼容性**

- **需要硬分叉：**
  - 这些更改不向后兼容，需要计划中的网络升级。
- **对用户和开发者的影响：**
  - 普通用户和开发者可能需要进行最小调整。
  - DA 密集型应用可能需要优化数据使用或采用替代解决方案。

## **测试用例**

1. **DA 密集型交易：**

   - 使用大量 calldata 的 DA 交易被收取更高的成本。
   - 验证此类交易不能导致区块 gas 使用超过限制。

2. **普通交易：**

   - 使用典型 calldata 和 EVM 的交易照常处理。
   - 确保用户成本和区块 gas 记账反映出最小变化。

3. **`SSTORE` 操作：**

   - **重置为零：**
     - 用户获得退款，但区块 gas 记账按全额收费。
     - 验证包含遵循区块 gas 限制。
   - **恢复到原始值：**
     - 折扣适用于用户成本和区块 gas 记账。
     - 确保区块 gas 使用反映出工作负载减少。

4. **热存储与冷存储访问：**

   - 热访问的折扣在用户成本和区块 gas 记账中保留。
   - 验证计算工作量的准确表示。

5. **接近 gas 限制的区块：**

   - 构建区块以测试新的 gas 限制执行。
   - 确保正确处理而不超过限制。
## **安全考虑**

- **网络稳定性：**
  - 确保区块 gas 限制准确反映工作负载，防止网络过载。
- **减轻 DoS 风险：**
  - 减少利用 gas 折扣来过载网络的攻击向量。


## **版权**

通过 CC0 1.0 Universal 放弃版权及相关权利。