---
eip: 1681
title: 时间重放保护
author: Martin Holst Swende (@holiman)
discussions-to: https://ethereum-magicians.org/t/temporal-replay-protection/2355
status: Stagnant
type: Standards Track
category: Core
created: 2019-01-08
---

## 简单总结

该 EIP 提议为交易添加“时间”重放保护，形式为 `valid-until` 时间戳。 
该 EIP 与 Nick Johnson 和 Konrad Feldmeier 的 https://github.com/ethereum/EIPs/pull/599 非常相似，主要区别在于该 EIP 基于时钟时间 / 实时时间，而不是区块号。 


## 动机

引入基于时间的交易有效性有几个不同的动机。

- 如果引入任何形式的灰尘账户清理，例如 (https://github.com/ethereum/EIPs/issues/168)，则有必要引入重放保护，例如 https://github.com/ethereum/EIPs/issues/169。拥有时间重放保护消除了在状态中更改 nonce 行为的需要，因为交易不会在用户明确设置的日期之后被重放。 
- 在许多情况下，例如在 ICO 期间，很多人希望他们的交易要么尽快被包含（在几个小时内），要么根本不被包含。目前，交易被排队，可能需要几天才能执行，这对用户（最终为失败的购买支付 gas）和网络（处理大量交易队列）都造成了成本。  
- 节点实现没有共同认可的标准来决定哪些交易保留、丢弃或传播。对交易设置 TTL 将更容易从系统中删除过时的交易。 

## 规范

推出将分为两个阶段，`X`（硬分叉）和 `Y`（软分叉）。

在区块 `X`，

- 向 RLP 编码的交易添加一个可选字段 `valid-until`，定义为 `uint64`（与 `nonce` 相同）。 
- 如果交易 `t` 中存在该字段，则
  - 仅当 `block.timestamp` < `t.valid-until` 时，`t` 才有资格被包含在区块中。 

在区块 `Y`， 
- 使 `valid-until` 成为强制性字段，并将任何没有 `valid-until` 的交易视为无效。 

## 理由

### 本 EIP 的理由

对于灰尘账户清理用例， 
- 此更改对共识引擎的影响小得多。 
  - 无需维护“最高已知 nonce”的共识字段或限制区块中来自发送者的交易数量。 
  - 仅涉及共识引擎的交易验证部分
  - 其他使用 `nonce` 的方案可能会产生意想不到的副作用， 
    - 例如无法在某些地址创建合约。
    - 与离线签名者集成更困难，因为更复杂的 nonce 方案需要状态访问来确定。 
    - 像“最高 nonce”这样的更复杂方案要困难得多，因为最高已知 nonce 将是一个在交易执行期间递增并可能回滚的共识结构，需要一个额外的日志字段。  


### 使用实时时间的理由
 
为什么使用实时时间而不是区块号，如 https://github.com/ethereum/EIPs/pull/599 中提议的？ 

- UTC 时间在大多数设置中通常可用，即使在离线计算机上也是如此。这意味着即使在区块链信息不可用的情况下，签署交易的一方也可以生成具有所需属性的交易。 
- 时间与区块号之间的关联并不是固定的；尽管“期望”的区块时间为 14 秒，但由于网络哈希率和难度炸弹的进展，这一时间会有所变化。 
- 对于测试网和私有网络，区块号作为时间戳的可靠性更差。
- UTC 时间对用户更友好，用户可以更容易地决定交易的合理结束日期，而不是适合的有效区块数量。


## 向后兼容性

该 EIP 意味着所有创建交易的软件/硬件需要向交易添加时间戳，否则在区块 `Y` 之后将无法签署交易。注意：该 EIP 不引入任何最大 `valid-until` 日期，因此仍然可以创建近乎无限有效性的交易。 

## 测试用例

待办事项

## 实现

尚无

## 安全考虑

最显著的安全影响是，存储在纸质备份上的预签名交易将在区块 `Y` 之后失效。有几种情况可能会使用此功能
   - 预生成的一次性“引导”交易，例如将用户引入以太坊。与其给用户一张实际以太币的礼品卡，不如给他们一笔一次性预生成的交易，该交易仅在用户主动希望开始使用时将以太币发送到卡上。
   - 如果用户有离线纸钱包，他可能会预生成交易以将价值发送到例如交易所。这有时是为了能够将以太币发送到交易所，而不必经历将纸钱包“复活”的所有麻烦。 

次要安全影响是，添加时间戳会使交易稍微增大。 

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。