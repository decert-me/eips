---
eip: 6046
title: 用 DEACTIVATE 替换 SELFDESTRUCT
description: 将 SELFDESTRUCT 更改为不删除存储键，并使用特殊值在账户 nonce 中表示停用
author: Alex Beregszaszi (@axic)
discussions-to: https://ethereum-magicians.org/t/almost-self-destructing-selfdestruct-deactivate/11886
status: Stagnant
type: Standards Track
category: Core
created: 2022-11-25
requires: 2681, 2929, 3529
---

## 摘要

将 `SELFDESTRUCT` 更改为不删除所有存储键，并在账户 nonce 中使用特殊值来表示*停用*账户。由于复活的语义发生变化（存储键可能存在），我们还将指令重命名为 `DEACTIVATE`。

## 动机

`SELFDESTRUCT` 指令目前有一个固定的价格，但在执行多少存储/账户更改方面没有上限（它需要删除所有键）。这已经是一个长期存在的问题。

此外，随着*Verkle 树*的出现，账户将以不同的方式组织：账户属性，包括存储，将具有单独的键。将无法遍历并找到所有使用的键。这使得在 Verkle 树中支持 `SELFDESTRUCT` 变得非常具有挑战性。

## 规范

1. 更改 [EIP-2681](./eip-2681.md) 引入的规则，使常规 nonce 增加的上限为 `2^64-2` 而不是 `2^64-1`。这适用于创世区块。

2. 更改 `SELFDESTRUCT` 的行为，使其：

  - 不删除任何存储键，并且保留账户。
  - 将账户余额转移到目标**并**将账户余额设置为 `0`。
  - 将账户 nonce 设置为 `2^64-1`。
  - 注意，由于 [EIP-3529](./eip-3529.md)，不提供退款。
  - 注意，关于 `SELFDESTRUCT` 的 [EIP-2929](./eip-2929.md) 规则保持不变。

2. 修改账户执行（通过外部交易或 CALL* 指令触发），使得如果 nonce 等于 `2^64-1`，则执行成功并返回一个空缓冲区。

  - 注意，账户仍然可以接收不可执行的价值转移（例如 coinbase 交易或其他 `SELFDESTRUCT`）。

3. 修改 `CREATE2`，使其允许在 nonce 等于 `2^64-1` 时创建账户。

  - 注意，账户（尤其是代码和存储）在 `CREATE2` 之前可能并不为空。
  - 注意，成功的 `CREATE2` 将更改账户代码、nonce 和可能的余额。

4. 将 `SELFDESTRUCT` 指令重命名为 `DEACTIVATE`，因为“账户复活”的语义发生了变化：旧的存储项将保留，且新部署的代码必须对此有所了解。

## 理由

有各种提案建议删除 `SELFDESTRUCT`，许多提案只是直接删除删除能力。这打破了某些使用模式，而*停用*选项则保持不变，尽管有一些小的变化。这仅影响*新*部署的代码，而不影响现有代码。

所有提案都将数据保留在状态中，但该提案提供了灵活性，可以逐个重用或删除存储槽，前提是复活的合约选择这样做。

## 向后兼容性

该 EIP 需要协议升级，因为它修改了共识规则。nonce 的进一步限制不应对账户产生影响，因为 `2^64-2` 是一个不切实际的高限制。

使用复活模式的合约仍然可以工作，但在复活期间部署的代码可能需要意识到存储键可能已经存在于账户中。

## 安全考虑

保留存储的新行为可能对安全性产生影响。合约作者必须对此有所了解并相应设计合约。现有的执行自主销毁和复活的代码可能会受到影响。

## 版权

通过 [CC0](../LICENSE.md) 放弃版权及相关权利。