---
eip: 234
title: 将 `blockHash` 添加到 JSON-RPC 过滤器选项中
author: Micah Zoltu (@MicahZoltu)
discussions-to: https://github.com/ethereum/EIPs/issues/234
type: Standards Track
category: Interface
status: Final
created: 2017-03-24
requires: 1474
---

## 简单总结

在 JSON-RPC 过滤器选项中添加一个选项（用于 `eth_newFilter` 和 `eth_getLogs`），允许指定应包含在结果中的区块哈希。此选项将作为 `fromBlock`/`toBlock` 选项的替代。

## 摘要

此添加将允许客户端获取特定区块的日志，无论这些区块是否在当前主链上。这解决了一些由于链重组、不可靠的网络连接以及结果集在空情况下缺乏足够细节而使得编写健壮客户端变得困难/昂贵的问题。

## 规范

`eth_newFilter` 使用的过滤器选项将有一个名为 `blockHash` 的额外可选参数，其值为单个区块哈希。响应请求的以太坊节点将返回一个错误（如果未找到区块哈希），或者返回与过滤器匹配的结果（按正常操作）并限制在提供的区块内。从内部来看，这将（假设）类似于 `fromBlock` 和 `toBlock` 过滤器选项的功能。

## 理由

需要可靠通知日志添加（在新块上）和日志移除（在链重组上）的客户端（dApp）无法仅依赖于订阅和过滤器来实现。这是因为在重组期间，网络或远程节点故障的组合可能导致客户端与现实不同步。一个可能发生这种情况的例子是，当客户端打开一个 WebSocket 连接，设置日志过滤器订阅，收到一些新日志的通知，然后失去 WebSocket 连接，随后（在断开连接时）发生重组，然后客户端重新连接并建立一个新的日志过滤器。在这种情况下，他们将不会收到来自节点的日志移除通知，因为他们在移除被广播时已断开连接，连接的丢失导致节点忘记了他们的存在。对于 HTTP 客户端也可以构造类似的场景，在更新轮询之间，节点宕机并恢复（导致过滤器状态丢失），并且在同两个轮询之间也发生了重组。

为了在仍然提供内部区块/日志添加/移除的健壮机制的同时处理此问题，客户端可以在内部维护一个区块链（最后 `n` 个区块），并仅订阅/轮询新块。当接收到新块时，客户端可以将其内部模型与新块进行对账，可能回填父块或回滚/移除其内部模型中的块，以与节点同步。这可以考虑任何类型的断开连接/重组/停机场景，并且还允许客户端（作为附加好处）与一组以太坊节点进行通信（例如，通过轮询）而不是紧密耦合到单个节点。

一旦用户拥有可靠的区块流，他们可以查看新块的布隆过滤器，如果该块 *可能* 有感兴趣的日志，他们可以从节点获取该块的过滤日志。出现的问题是，在客户端接收到块和客户端获取该块的日志之间可能发生重组。根据当前的过滤器选项，客户端只能按块号请求日志。在这种情况下，他们收到的日志将是针对一个 *不是* 他们想要日志的块，而是针对一个被重组进来的块（并且可能与内部客户端状态不完全对账）。这可以通过查看结果日志本身并识别它们是否是请求的块哈希来部分解决。然而，如果结果集是一个空数组（未获取到日志），那么客户端就处于一种不知道结果属于哪个块的情况。结果可能在相关块上合法为空（布隆过滤器可能产生假阳性），或者他们可能正在接收一个他们不知道的块的空日志。在这一点上，客户端无法做出任何保证恢复的决定。他们可以假设空日志是针对正确的块，但如果不是，他们将永远不会再尝试获取。这会造成问题，如果该块只是暂时被重组出，因为它可能在下一个块轮询之前恢复，因此客户端将永远不会见证重组。他们可以假设空日志是针对错误的块，并重新获取它们，但他们可能会继续收到空结果，使他们回到同样的情况。

通过添加按哈希获取日志的能力，客户端可以确保如果他们获得结果集，则它是针对相关块的。如果他们收到错误，则可以采取适当的措施（例如，客户端回滚该块并重新获取最新的）。

## 向后兼容性

唯一的潜在问题是 `fromBlock` 和 `toBlock` 字段。包含哈希和数字似乎没有意义，因此 `fromBlock`/`toBlock` 应该与 `blockHash` 互斥。

## 测试用例

`{ "jsonrpc": "2.0", "id": 1, "method": "eth_getLogs", params: [{"blockHash": "0xbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0c"}] }` 应该返回哈希为 `0xbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0c` 的块的所有日志。如果在过滤器选项中添加了 `topics` 字段，则应返回该块的过滤日志集。如果不存在具有该哈希的块，则应返回一个错误，`code` 为 `-32000`，`message` 为 `"Block not found."`，`data` 为 `"0xbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0cbl0c"`。

## 实现

- [x] [Geth](https://github.com/ethereum/go-ethereum/pull/16734)

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。