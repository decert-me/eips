---
eip: 867
title: 标准化以太坊恢复提案
author: Dan Phifer <dp@musiconomi.com>, James Levy <james@taptrust.com>, Reuben Youngblom <reuben@taptrust.com>
discussions-to: https://ethereum-magicians.org/t/eip-867-standardized-ethereum-recovery-proposals-erps/139
type: Meta
status: Stagnant
created: 2018-02-02
---

## 简单总结
提供一个标准化的以太坊恢复提案（ERP）格式，涉及某些类别的丢失资金的恢复。个别 ERP 将遵循与任何 EIP 相同的流程，但将以标准方式格式化和评估，以确保一致性和透明度。

**本 EIP 不主张接受或反对任何特定的恢复提案，其接受本身也不会导致区块链的任何状态变化。**

## 摘要
本提案确定了一种可以用于解决以太坊区块链上某些类别丢失资金的共同解决方法。特别是，它旨在解决直接受影响方之间对正确结果没有分歧的情况，从而为许多已经发生或可能再次发生的问题提供及时且低风险的解决方案。

解决方法分为三个部分：

1. 任何后续 ERP 需要满足的标准，以便被考虑批准。
2. 对 ERP 使用的通用格式的建议，以指定一组可以被客户端解释的纠正措施。
3. 客户端团队实施代码的指南，以便在特定区块读取、解释和应用纠正措施。可能的纠正措施集故意有限，以最小化与任何 ERP 相关的风险。

## 动机
以太坊区块链上的资金恢复问题通常具有争议性。由于此类请求的相对临时性质以及评估优点时通常需要的主观性，冻结资金恢复提案几乎从未成功。此 EIP 试图通过提供资金恢复 EIP 的标准化格式和一个客观标准来消除这些障碍，以衡量未来的提案。

## 规范
本 EIP 描述了一种用于子类 EIP 的通用格式，称为以太坊恢复提案（ERP），该提案提出了需要进行不规则状态变化的资金恢复场景，这些场景无法使用标准协议解决。每个引用本 EIP 的 ERP 将遵循此处设定的指南。

每个 ERP 的目的是 (a) 清楚地描述需要纠正的问题，(b) 描述为什么不规则状态变化是必要且合理的，以及 (c) 证明所提议的行动将实现 ERP 的目标。

每个 ERP 将被要求使用标准格式表示提议的状态变化集，并必须包括一个可以可靠生成这些变化的验证脚本。不满足（至少）这些要求的 ERP 将不被考虑批准。

每个 ERP 应包含以下项目：

- **前言**：包含关于 ERP 的元数据的 EIP（RFC 822）头，包括 EIP 编号、简短标题（最多 44 个字符）和每位作者的真实姓名（及可选的联系信息）。
- **简单总结**：对 ERP 的简化和通俗易懂的解释。
- **详细描述**：对提议的纠正措施及用于确定提议行动的标准的可读描述。
- **理由**：简明描述为什么纠正措施既合理又不太可能受到任何直接受影响方的挑战。
- **验证脚本**：输出一个状态变化对象的机器可读脚本。该脚本应清楚地实现描述中概述的选择和行动生成逻辑，以便审阅者可以独立重新生成相同的状态变化对象。
- **状态变化对象**：验证脚本的输出和以太坊客户端的输入。主要指定提议的完整状态变化行动集。
- **附录（可选）**：附带支持证据。附录中的附件可以包括验证恢复提案描述中指定细节的文件。

以下部分对理由、验证脚本和状态变化对象格式的期望进行了更详细的描述。

### 理由
简明描述为什么此行动既合理（无法在没有不规则状态变化的情况下完成）且不太可能受到*直接*受影响方的挑战。

**充分示例**（简明，包含支持证据，无负面影响）：
*XYZ 进行的众筹在其众筹开始时于 2018 年 1 月 19 日错误地在其公共网站上发布了其众筹合约的测试网地址。501 ETH 在区块 4,235,987 和 4,236,050 之间由 328 名用户发送到错误地址。请查看测试网合约，查看主网同一地址的交易。请查看 XYZ 在其网站上发布的声明。由于在测试网上该地址存在合约，并且创建者地址的相应 nonce 已在主网上使用，因此被认为任何人偶然持有私钥是几乎不可能的。我们已验证所有交易均来自没有关联代码的地址，因此将 eth 退还给发送者应该没有问题。*

**不足示例**（细节不足，无支持证据）：
*我们不小心在网站上放错了合约地址。请将发送到 0x1234 的任何 eth 退还给发送者。谢谢。*

**不可接受示例**（不客观，一个人的话与另一个人的话相对）：
*我把代币发送给 X 以换取服务，但他做得很糟糕。我想要我的钱，但他不愿意退款。请帮忙！！*

### 验证脚本
输出单个状态变化对象的机器可读脚本。该脚本应实现得易于审计。验证脚本应为可以使用 [web3.js](https://github.com/ethereum/web3.js/) 库的 JavaScript 文件。

验证脚本有一些指导原则：

- 脚本应始终尽可能简洁地编写，任何执行验证脚本的人在执行前应先审查，以验证其不包含任何不安全的操作。
- 任何验证脚本都不应要求解锁的以太坊钱包。
- 脚本应硬编码执行期间包含的最高区块（否则结果可能在不同运行之间有所不同）。

ERP 验证脚本的目的是通过代码明确指定用于计算状态变化行动集的标准。上述描述的脚本输出将是所有以太坊客户端使用的输入。客户端团队应避免手动预处理工件或仅使用工件来指导代码中的更改。相反，工件应与客户端捆绑，并在指定区块由客户端直接处理。这将最小化每个 ERP 所需的客户端工作量，并有助于确保客户端之间的兼容性。我们预计某些 ERP 验证脚本可能是微不足道的，但我们建议其包含以保持一致性。
### 状态变更对象
状态变更对象是一个标准格式，所有以太坊客户端都可以解释。

它是一个包含以下字段的单一 JSON 对象：
- **erpId**：此 ERP 的字符串标识符（可能是相关的 EIP 编号，例如“EIP-1234”）。这将从 ascii 转换为十六进制字符串，然后作为额外数据添加到目标区块中。
- **targetBlock**：状态变更应应用的区块。客户端将使用此信息来确定一组状态变更何时应发生。
- **actions**：状态变更操作的数组。
- **metadata**
  - **sourceBlock**：脚本运行时考虑的最高区块。
  - **version**：脚本运行时的验证脚本版本。

### 状态变更操作
状态变更操作是一个 JSON 对象，包含一个“type”字段和一组“data”字段，其中数据字段的内容取决于类型，并且必须遵循为该类型定义的模式。这允许客户端最初支持有限的操作集，并根据后续的 EIP 添加更多操作。客户端在采用此 EIP 时应实现对以下操作类型的支持：

#### weiTransfer
`weiTransfer` 操作将 ETH 从一个地址转移到另一个地址。

*数据字段*

- **type** (*string*)：`weiTransfer`
- **fromAddress** (*hex string*)：应从中转移 ETH 的地址
- **toAddress** (*hex string*)：应发送 ETH 的地址
- **value** (*decimal string*)：要转移的 ETH 数量，以 wei 为单位。该值必须是大于零的整数。

#### storeCode
`storeCode` 操作在给定地址存储指定代码。

*数据字段*

- **type** (*string*)：`storeCode`
- **toAddress** (*hex string*)：应恢复合约的地址。
- **expectedCodeHash** (*hex string*)：在 toAddress 上已经存在的代码的预期哈希。如果在 toAddress 上不期望有代码，则应使用空字符串。在所有其他情况下，“0x”前缀是可选的。
- **code** (*hex string*)：与合约关联的新字节码

### 附录（可选）
附录可以包括额外的支持证据或附件，以帮助审阅者理解或验证在 ERP 中提出的主张。

对于 storeCode 操作，它应包括提议的合约源代码（例如 Solidity）以及其他所需的详细信息，以便审阅者可以编译源代码并生成相同的字节码。如果可能/适用，还应包括最初存储在该地址的源代码。如果两个合约不相同，应注明更改。如果它们相同，作者应说明为何不需要更改（这不太可能）。此外，任何相关的审查、审计和测试用例应包括在内，以解决与原始合约相关的问题。

如果被接受，ERP 可以轻松编译在变更发生时的区块，以及操作的源（这将是脚本的输出，以标准化对象输出形式）。这些可以与客户端捆绑以实现无缝执行。

## ERP 批准流程
ERP 是 EIP 的子类，因此将遵循相同的批准流程。

### 测试
*ERP 作者目前正在寻求客户端团队对适当测试程序的反馈*

## 以太坊客户端实现
选择采用此 EIP 中概述的提案的客户端将实现一个模块，该模块扫描指定目录中的 SCO 文件（每次客户端进程启动时）以构建目标区块与 SCO 文件名之间的映射。当开始处理新区块时，客户端应首先咨询发现的 SCO 目标区块集，并确定当前区块是否需要任何恢复操作。

例如，在此示例中，`erpsByTargetBlock` 是与每个 ERP 的状态变更对象关联的目标区块编号与实际数据资源的引用（即文件名）之间的映射。

```
if (erpsByTargetBlock.get(currentBlock) != null) {
    try {
        applyRecoveryActions(erpsByTargetBlock.get(currentBlock));
     }
     catch (e) {
        // recovery actions should be treated as a batch.  
        // If one fails, they all fail.
     }
}


// continue with normal block processing...
```

`applyRecoveryActions` 方法必须按照存储在 SCO 文件中的顺序应用恢复操作。客户端负责确保没有状态变更操作会导致账户转移超过其当前余额的金额。`weiTransfer` 和 `storeCode` 的 `toAddress` 应始终是有效地址（即永远不是 `0x0`）。

此外，每个受 ERP 影响的区块应包括额外数据，以指示状态变更已发生。区块中包含的额外数据应为在 SCO 文件中找到的 erpId，转换为十六进制（即 `hexStringToBytes(asciiToHex(erpId))`）。客户端还应验证如果区块是从对等方接收的，则目标区块中是否出现预期的头部。

ERP 应链接到每个客户端存储库的拉取请求，这些拉取请求应链接回 ERP，并包含其 EIP 前言和摘要。

与 ERP 相关的每个 PR 应由一个文件（SCO 文件）组成，添加到客户端指定的 SCO 目录中。不应需要额外的客户端代码。

### 此 EIP 的限制

此 EIP 旨在标准化恢复提案的格式，以优化可读性并尽可能消除或最小化错误或恶意滥用的潜在可能性。

以下内容被视为此 EIP 的范围之外：
- 哪些资金恢复提案（如果有）应被接受实施。
- 常见的恢复提案原告可能如何组织代表个体团体的 ERP。

## 理由
上述方法的主要考虑是最小化与恢复操作相关的风险，这些操作在其他情况下将没有可行的解决方案。次要考虑是标准化用于恢复操作提案的格式。

首先，包含验证脚本确保了确定恢复操作的方式是明确的。这并不意味着恢复操作一定是正确的，只是说用于确定它们的逻辑是完全指定和可审计的。

其次，要求验证脚本的输出可以被客户端程序直接解释，最小化了每个客户端采用特定 ERP 所需的工作量。这也减少了两个客户端在实施特定 ERP 时做出不同决策的风险。

第三，操作类型故意有限且不灵活，这减少了意外后果或恶意构造文件影响区块链状态的可能性。该格式可以轻松扩展以添加新的操作类型，但这需要单独的 EIP。

## 实现
已为 EthereumJ 平台编写了参考实现。请参见 [此处](https://github.com/ethereum/ethereumj/pull/1004#commits-pushed-1105610) 的拉取请求。

## ERP 示例

本节将包括示例和 SCO 资源文件，以及关于如何使用私有测试网进行测试的简要教程。

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。