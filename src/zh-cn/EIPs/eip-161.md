---
eip: 161
title: 状态树清理（保持不变的替代方案）
author: Gavin Wood (@gavofyork)
type: 标准跟踪
category: 核心
status: 最终
created: 2016-10-24
---

### 硬分叉
[Spurious Dragon](./eip-607.md)

### 参数
- `FORK_BLKNUM`: 2,675,000
- `CHAIN_ID`: 1 (主网)

### 规范

a. 账户创建交易和 `CREATE` 操作在执行初始化代码之前，**应**将 **nonce** 在其正常起始值的基础上 **增加** **1**（对于正常网络，这将简单地是 1，然而具有非零默认起始 nonce 的测试网络将会有所不同）。

b. 而 `CALL` 和 `SUICIDE` 在目标不存在时会收取 25,000 gas，现在只有在操作转移 **超过零值** 且目标账户是 *死* 的情况下，才会收取费用。

c. 任何账户不得从不存在状态变为存在但 *空* 的状态。如果某个操作会这样做，则该账户应保持不存在状态。

d. *在交易结束时*，任何在该交易执行过程中被 *触及* 的账户如果现在是 *空* 的，应变为不存在（即 **删除**）。

其中：

当账户参与任何可能的 *状态改变* 操作时，视为被 *触及*。这包括但不限于，作为 **零值转移** 的接收者。

当账户 **没有代码** 和 **零 nonce** 和 **零余额** 时，视为 *空*。

当账户要么不存在，要么是 *空* 的时候，视为 *死*。

*在交易结束时* 是指在自杀列表执行后，确定状态树根以进行收据填充之前的时刻。

当账户 *改变状态* 时：
- 它是 `SUICIDE` 操作的目标或退款，转移 **零或更多** 值；
- 它是 `CALL` 操作或消息调用交易的源或目标，转移 **零或更多** 值；
- 它是 `CREATE` 操作或合约创建交易的源或创建，赋予 **零或更多** 值；
- 作为区块作者（“矿工”），它是区块奖励或交易费用的接收者，转移 **零或更多** 值。

#### 备注

在当前以太坊协议中，值得注意的是，最终导致账户在交易执行后为空的状态变化非常少。实际上，当前实现需要跟踪的上下文只有四种：
- 一个空账户通过 `CALL` 转移了零值；
- 一个空账户通过 `SUICIDE` 转移了零值；
- 一个空账户通过消息调用交易转移了零值；
- 一个空账户通过零 gas 费用转移了零值。

### 理由

与 #158 相同，除了避免了几个边缘情况，因为我们没有破坏不变性：
- ~~一个账户可以在交易执行过程中从有代码和存储变为没有代码或存储；~~ [已更正]
- 新创建的账户在被部署之前不能被删除。

`CREATE` 避免在 nonce 中使用零，以避免暗示 `CREATE` 的账户在创建过程中被收回的奇怪情况。

### 附录（2017-08-15）

在 2016-11-24，由于两个实现的状态回退行为不同，发生了共识错误。[3] 规范已修订，以澄清当状态回退时，空账户的删除将被回退。

### 参考文献

1. EIP-158 问题和讨论: https://github.com/ethereum/EIPs/issues/158
2. EIP-161 问题和讨论: https://github.com/ethereum/EIPs/issues/161
3. https://blog.ethereum.org/2016/11/25/security-alert-11242016-consensus-bug-geth-v1-4-19-v1-5-2/
> 详情：Geth 在导致空账户删除的交易以超出 gas 异常结束时未能回退空账户的删除。在 Parity 中发现了一个额外的问题，其中 Parity 客户端在涉及对预编译合约的超出 gas 调用的更有限上下文中错误地未能回退空账户的删除；新的 Geth 行为与 Parity 的一致，空账户在状态清理过程完成后大约一周内将不再成为关注点。