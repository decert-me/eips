---
eip: 7667
title: 提高哈希函数的 gas 成本
description: 提高哈希函数操作码和预编译的 gas 成本，以匹配 ZK-EVM 中的证明费用
author: Vitalik Buterin (@vbuterin)
discussions-to: https://ethereum-magicians.org/t/eip-7562-raise-gas-costs-of-hash-functions/19446
status: Draft
type: Standards Track
category: Core
created: 2024-03-31
---

## 摘要

提高涉及哈希函数的操作码和预编译的 gas 成本。

## 动机

哈希函数操作码和预编译的 gas 成本最初是基于在常规 CPU 上执行它们所需的时间设定的。然而，自那时以来，出现了另一个同样重要的执行基础设施：零知识证明（ZK-SNARK）系统。按照这个标准，这些操作码和预编译相对于其他操作是*非常*低估的。

执行哈希函数的区块比平均区块需要更长的时间进行 ZK-SNARK 证明。如今，许多二层协议使用诸如任意限制和由中心化排序器强制执行的规则等变通方法来解决这个问题。这些变通方法通常设计不佳，导致不必要的安全性和中心化问题。

此外，最终使用 ZK-SNARK 证明以太坊一层区块的正确性是一个设计目标。为此，我们需要建立非常严格的界限，以确定生成以太坊执行区块正确性的 ZK-SNARK 证明所需的时间。目前，平均情况证明时间和最坏情况证明时间之间的差异很大，而哈希函数执行是最大原因。

Verkle 树解决了来自 Merkle Patricia 树的 Keccak 哈希的部分问题。目前，理论上的最坏情况是一个区块具有 `30000000 / 2600 = 11538` 次账户访问（减去 EVM 开销的小百分比），每次访问的证明需要证明 `24000` 字节的代码，加上大约 `512 * log(500m) / log(16) = 3712` 字节的 Merkle-Patricia 证明：大约 `305 MB` 的哈希分布在 `83650` 次哈希调用之间。Verkle 树解决了这个问题。然而，使用操作码时，区块执行仍然可能需要大约以下数量的哈希：

| 哈希 | 每字节成本 | 从 3000 万 gas 的最大字节数 |
| - | - | - |
| `KECCAK`（操作码） | 6 | 1.6 亿 |
| `SHA256`（预编译） | 12 | 8000 万 |
| `RIPEMD`（预编译） | 120 | 800 万 |
| `BLAKE2`（预编译） | 3（每 128 字节 12） | 3.2 亿 |
| `LOG*`（哈希数据） | 256（每字节 8） | 375 万 |

这些哈希函数已针对快速 CPU 计算进行了优化，因此 CPU 可以快速计算它们：例如，本文作者的笔记本电脑可以在不到半秒的时间内计算出 1.6 亿字节的 keccak。然而，在 ZK-SNARK 中，这些操作是*非常*耗时和低效的。这在基于小域的新证明系统中得到了缓解，但哈希仍然被低估。

## 规范

| 参数 | 先前值 | 新值 | 
| - | - | - |
| `KECCAK_BASE_COST` | 30 | 300 |
| `KECCAK_WORD_COST` | 6 | 60 |
| `SHA256_BASE_COST` | 60 | 300 |
| `SHA256_WORD_COST` | 12 | 60 |
| `RIPEMD_BASE_COST` | 600 | 600 |
| `RIPEMD_WORD_COST` | 120 | 120 |
| `BLAKE2_GFROUND` | 1 | 10 |
| `GLOGBYTE` | 8 | 10 |

将上述参数更改为其新值。

## 理由

上述内容提高了所有可以在 EVM 中要求大量哈希的操作码和预编译的 gas 成本。所有哈希成本提高到每个哈希 300 加上每字 60（如果它们已经高于此，则保持不变）。

一种可能的替代方法是实现多维 gas 定价（即，哈希的单独浮动基础费用和每区块目标和限制）或类似于 [EIP-7623](eip-7623.md) 对 calldata 的“总 gas 成本下限”。然而，这种方法对于像哈希这样的 EVM gas 成本的实现要比对于 calldata 和 blobs 难得多，因为 EVM gas 限制不仅由用户设定，用户可以轻松添加指定新要求限制、最大基础费用和优先费用的新交易类型，还由合约对其他合约的子调用设定。

## 向后兼容性

对于大多数应用程序，合理的上限是 EVM 中被哈希的数据是作为 calldata 引入的。如果进行的哈希是二进制 Merkle 证明验证，则每 32 字节的数据对应于一个 64 字节（2 字）的哈希。一个字的成本是 512 gas。在新成本下，该情况下每字的哈希将是 `300 + 60 * 2 = 420` gas。因此，这将使该应用程序的这一部分的 gas 消耗增加不到 2 倍。

具体而言，基于 Keccak 的长度为 20 的二进制 Merkle 证明的 gas 成本将从 `(512 + 42) * 20 = 11080` 增加到 `(512 + 420) * 20 = 18640`。这是一个小幅增加，特别是考虑到与此类应用程序相关的其他成本。

## 安全考虑

由于没有引入新操作或降低成本，因此没有提出安全问题。

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。