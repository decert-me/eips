---
eip: 6916
title: 自动重置测试网
description: 一个定期回滚到创世的测试网
author: Mário Havel (@taxmeifyoucan), pk910 (@pk910), Rémy Roy (@remyroy), Holly Atkinson (@atkinsonholly), Tereza Burianova (@T-ess)
discussions-to: https://ethereum-magicians.org/t/automatically-reset-testnet/15825
status: Review
type: Standards Track
category: Core
created: 2023-04-10
---

## 摘要

本 EIP 提出了一个自动重置测试网的规范，这是一种可以在以太坊客户端中实现的新型测试网方法。它使得由短暂网络和确定性参数组成的单一测试基础设施成为可能。每个网络迭代由一个指定的函数创建，该函数确定性地生成创世状态。

## 动机

一个自动重置的测试网可以为应用程序、验证者以及客户端实现中的重大变更提供一个短期测试的替代环境。它避免了长期运行的测试网所面临的状态膨胀、缺乏测试网资金或共识问题。定期将网络重置回创世状态可以清理验证者集，并将资金返回到水龙头，同时保持网络相对较小，以便于启动。

## 规范

测试网设置为在预定义的时间段后始终重置。重置意味着生成下一个创世，丢弃旧的创世并启动一个新网络。这可以通过引入创世生成和客户端重置的函数来实现。

### 创世

要连接到当前的网络实例，客户端必须实现创世函数。该函数定义了客户端如何存储有关测试网的信息并生成当前创世。每次重置时，网络从一个新的创世开始，该创世需要根据给定参数构建，并在 EL 和 CL 客户端中对应。

网络始终从一个基于原始创世确定性创建的创世开始——这个最初的创世是硬编码的，我们可以称之为 `genesis 0`。终止时间，即每个创世的过期时间，是该创世的开始时间 `MIN_GENESIS_TIME` 和测试网生命周期 `period` 的总和，其中 `period` 是定义单个短暂网络运行时间长度的常量。因此，一旦当前插槽时间戳达到短暂网络的终止时间，就必须切换到新的创世。每个新创世迭代的主要变化是 chainId、创世时间和第一个验证者的提取凭证。

客户端应包括硬编码的 `genesis 0`，就像其他在客户端中预定义的网络一样。然而，这个创世应仅在测试网存在的最初阶段，即 `i` 等于 `0` 的第一次迭代中直接使用。之后，在迭代 `i` 等于 `1` 及以上时，客户端不初始化这个创世，而是用它来推导当前的创世。当 `i>0` 时，给定已知的 `period` 和当前插槽时间戳，客户端始终从 `genesis 0` 计算生命周期迭代的数量，并使用最新参数创建一个新的创世。

当客户端以短暂测试网的选项启动时，它检查网络的创世是否存在。如果不存在或当前插槽时间戳早于 `current_genesis.genesis_time + period`，则触发生成新的创世。这个新的创世将从 `genesis 0` 派生，并将写入数据库以运行当前网络。

#### 执行客户端

EL 客户端包括硬编码的 `genesis 0`，作为生成当前创世的前像。变量的迭代如下进行：

* 迭代次数：
  * `i` = `int((current_slot_timestamp` - `genesis_0.genesis_time) / period)`
* 当前创世的创世时间：
  * `current_genesis.genesis_time` = `period` * `i` + `genesis_0.genesis_time`
* 当前 EL ChainId：
  * `chainId` = `genesis_0.chainId` + `i`

#### 共识客户端

CL 客户端中的创世生成包括与 EL 相同的值迭代，但还需要更新的创世状态。SSZ 格式的状态可以由客户端生成或从外部源下载。它包括准备启动合并网络的验证者及其存款，这些验证者由社区内的可信实体创建。

`MIN_GENESIS_TIME` 设置为最新的创世时间，并定义当前周期的开始时间。建议添加一个小的 `GENESIS_DELAY`，例如 15 分钟，以避免基础设施在使用新创世重启时出现问题。

为了确保成功重置，`ForkDigest` 需要在每次迭代中是唯一的。为了保持网络的 `ForkVersions` 静态以便于更好的工具支持，验证者集中的第一个验证者的提取凭证需要被一个计算值覆盖。

* `genesis.validators[0].withdrawal_credentials` = `0x0100000000000000000000000000000000000000000000000000000000000000` + `i`
* `genesis.genesis_validators_root` =  `hash_tree_root(genesis.validators)`

更新 `genesis.validators[0]` 会改变状态，因此，客户端必须能够生成或下载最新的创世状态。生成创世 ssz 并不被视为标准客户端功能，添加此功能可以在一定复杂性代价下无信任地创建最新的创世状态。另一种解决方案是从第三方获取它，可以通过从服务器下载 ssz 文件或使用提供创世状态的端点的检查点同步功能。这在 Holešky 测试网中已成为一种被接受的做法，现有功能可用于获取自动重置测试网的创世状态。它还允许维护者在不需要新的客户端发布的情况下更新创世验证者集。获取最新 CL 状态的推荐实践的完整实现应如下所示：

* 当提供测试网标志且客户端支持创世的检查点同步时，自动使用硬编码的检查点端点下载最新的创世状态，使用检查点同步功能
  * 如果用户提供自定义检查点同步标志，覆盖默认选项并使用用户提供的端点
* 包含一个备份下载选项，指向最新测试网发布的 URL，一个公开分发的 ssz 文件，并在检查点状态同步失败时触发此选项，或者如果客户端不支持创世检查点同步，则将其设为默认
* 如果客户端包含生成创世的功能，使用它来验证下载状态中的参数，并在值或校验和不对应时发出错误

需要注意的是，`genesis_validators_root` 通常在客户端中预定义，但在这种情况下，它事先并不知道，这可能会破坏某些架构。例如，依赖硬编码 `genesis_validators_root` 的轻客户端将无法工作。

### 重置

重置函数定义了一个自动丢弃旧数据并以新创世开始的过程。它依赖于之前定义的创世生成函数，客户端必须实现该函数以能够自动跟随最新的网络迭代。

对于重置函数，我们可以引入 `terminal_timestamp` 值，该值定义了一个迭代的网络过期时间。它可以与下一个迭代的创世时间相同（不包括创世延迟），或者可以简单地计算为 `terminal_timestamp = current_genesis.genesis_time + period`。
当网络达到时间戳 `>= terminal_timestamp` 的插槽时：

* 客户端停止接受/创建新块
  * 关闭运行网络的客户端服务，例如 p2p 通信、信标服务、执行环境
  * 此功能应与创世一起实现，即使没有进一步的重置功能，也要创建一个始终安全的基本支持，避免分叉
* 客户端调用一个函数，丢弃当前创世、所有链或信标数据
  * 客户端已经包含数据库工具，包括用于清除数据库的工具，可以在这里使用
  * 包含一个额外标志可能是有益的，例如 `--retain-ephemeral-data`，该标志将在删除数据库之前首先以标准格式导出现有数据
* 客户端触发创世函数（如上所定义）：
  * 在创世不存在时表现得像常规客户端启动
  * 新创世被写入数据库并初始化
* 主网络服务再次启动，指向更新后的创世
* 在达到新的创世时间后，网络从新的创世重新启动

对于完整的重置实现，客户端应能够执行上述操作，而无需手动重启，完全独立地操作网络，并且停机时间最小。

请注意，根据客户端架构，可能无法完全实现这样的内部重置机制，例如，如果客户端不支持优雅关闭。重置功能被视为高级支持，主要由基础设施提供者和创世验证者所需。假设即使客户端不实现重置，高级用户也可以通过系统工具处理客户端的外部脚本实现类似的行为。

## 理由

具有确定性参数的短期测试网提供了传统测试网的可持续替代方案，使用相同的基础设施。在每次重置时，验证者集被清除，水龙头再次填充，数据库保持较小。

在重置时，整个状态被清除，这一方面保持了网络的小巧和易于引导，但对测试长期/高级应用程序引入了问题。然而，任何用户都可以在每次重置后自动部署基本合约基础设施。一般来说，建议使用该网络进行短期测试，部署不需要长期保留在长期测试网的 `Hello World` 类型的合约。然而，可以有一个链下机制，在每次重置后自动部署标准合约原语，以便应用程序开发者也能更好地利用该网络。

通过为创世和重置定义两种机制，该 EIP 使客户端实现支持测试网的两种级别成为可能；

* 基本支持要求客户端确定当前网络规格，仅允许连接到网络。
  * 这意味着支持上述定义的创世机制
  * 足以参与短期测试的网络
  * 为了跟随最新迭代，用户必须手动关闭客户端并删除数据库
  * 仍然建议添加一个终止网络的功能
* 完全支持使客户端能够遵循重置过程，并始终同步最新的链迭代
  * 这也要求客户端实现内在的重置功能
  * 需要用于运行持久基础设施、创世验证者和引导节点
  * 由于客户端架构的原因，可能更复杂实现

该设计也与由外部工具管理的节点兼容，即使客户端不实现这些功能，它也可以在与其他由脚本自动重置的节点相同的网络上运行。任何支持自定义网络的客户端都可以用于测试网。

### 网络参数

定义测试网属性的常量和变量是任意的，但需要考虑以下某些限制和安全属性。

#### 重置周期

`period` 是一个常量，硬编码在客户端中，定义网络重置后的时间周期。

它可以根据用户的需求进行定义，但出于安全原因，它还取决于创世中的验证者数量。考虑到激活验证者的时间，可信验证者的数量应该足够高，以便网络无法被恶意行为者控制。

```sh
Genesis Validators => Epochs until < 66% majority
10k  => 1289 Epochs (5,7 days)
50k  => 6441 Epochs (28,6 days)
75k  => 9660 Epochs (42,9 days)
100k => 12877 Epochs (57,2 days)
150k => 19323 Epochs (85,9 days)
200k => 25764 Epochs (114,5 days)
```

#### ChainId

ChainId 是一个变量，因为它需要在每个新创世中不断变化，以避免重放攻击。新 ChainId 值的函数是简单的递增 (+1)。`genesis 0` 中的 ChainId 是一个硬编码常量。此常量在每个新创世中由客户端使用，以推导出该网络迭代的新 ChainId。

新的 ChainIds 不应与任何其他现有公共 EVM 链发生冲突，即使经过多次迭代。因此，不鼓励使用低 ChainId 值。

## 安全考虑

网络本身提供了一个安全的环境，得益于定期重置。即使某种漏洞被利用，它也将在下次重置时被清除。这也是保持周期相对较短（周/月而不是月/年）的原因，并且创世验证者集足够大，以保持诚实的多数。

由于实现重置网络功能而导致的客户端更改需要与标准安全程序一起进行审查。特别是触发重置的机制必须与未配置为短期的其他网络分开。

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。