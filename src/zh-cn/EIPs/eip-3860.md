---
eip: 3860
title: 限制和计量初始化代码
description: 将初始化代码的最大大小限制为 49152，并对每 32 字节的初始化代码施加额外的 2 gas 成本
author: Martin Holst Swende (@holiman), Paweł Bylica (@chfast), Alex Beregszaszi (@axic), Andrei Maiboroda (@gumb0)
discussions-to: https://ethereum-magicians.org/t/eip-3860-limit-and-meter-initcode/7018
status: Final
type: Standards Track
category: Core
created: 2021-07-16
requires: 170
---

## 摘要

我们通过引入 `initcode` 的最大大小限制（`MAX_INITCODE_SIZE = 2 * MAX_CODE_SIZE = 49152`）来扩展 [EIP-170](./eip-170.md)。

此外，我们对每 32 字节的 `initcode` 收取 `2` gas 的费用，以表示跳转目标分析的成本。

最后，大小限制带来了一个附加的好处，即 EVM 代码大小、代码偏移量（`PC`）和跳转偏移量适合 16 位值。

## 动机

在合约创建期间，客户端必须在执行之前对 `initcode` 执行跳转目标分析。所执行的工作与 `initcode` 的大小成线性关系。当前这项工作没有计量，也没有强制执行的大小上限。

目前收取三种费用：

1. calldata（即 `initcode`）的费用：值为零的字节为 4 gas，其他值为 16 gas。
2. 部署代码的费用：每字节 200 gas。
3. 地址计算的费用（仅在 `CREATE2` 的情况下，代码的哈希）：每字为 6 gas。

只有第一种费用适用于 `initcode`，但仅在合约创建交易的情况下。对于 `CREATE`/`CREATE2` 的情况，没有这样的费用，并且可以以相对便宜的方式程序化生成 `initcode` 的变体。在过去，由于 2017 年通过 geth 1.6.5 修复的漏洞，曾经可以构造恶意的 `initcode`。

此外，缺乏限制导致了一些 EVM 提案的冗长讨论，影响了设计，甚至导致功能的延迟或取消。

我们有三个动机：

1. 确保 `initcode` 的费用合理（最重要的是费用与 `initcode` 的长度成正比），以最小化未来的风险。
2. 拥有一个可在未来扩展的费用系统。
3. 通过明确的限制（代码大小、代码偏移量（`PC`）和跳转偏移量适合 16 位）来简化 EVM 引擎。

## 规范

### 参数

| 常量                  | 值                   |
| --------------------- | -------------------- |
| `INITCODE_WORD_COST`  | `2`                  |
| `MAX_INITCODE_SIZE`   | `2 * MAX_CODE_SIZE`  |

其中 `MAX_CODE_SIZE` 由 [EIP-170](./eip-170.md) 定义为 `24576`。

我们定义 `initcode_cost(initcode)` 等于 `INITCODE_WORD_COST * ceil(len(initcode) / 32)`。

### 规则

1. 如果创建交易中的交易数据（`initcode`）的长度超过 `MAX_INITCODE_SIZE`，则交易无效。（*请注意，这与因未满足内在 gas 成本要求而被视为无效的交易类似。*）
2. 对于创建交易，扩展交易数据成本公式以包括 `initcode_cost(initcode)`。（*请注意，这包含在交易的内在成本中，即交易中没有足够的 gas 来覆盖 `initcode` 成本是无效的。*）
3. 如果 `CREATE` 或 `CREATE2` 指令的 `initcode` 长度超过 `MAX_INITCODE_SIZE`，则指令执行异常中止（就像它耗尽了 gas 一样）。
4. 对于 `CREATE` 和 `CREATE2` 指令，收取额外的 gas 成本，等于 `initcode_cost(initcode)`。此费用在计算结果合约地址和执行 `initcode` 之前扣除。（*请注意，这意味着在 `CREATE2` 中应用哈希成本之前或同时应用。*）

## 理由

### gas 成本常量

`INITCODE_WORD_COST` 的值是根据不同实现的性能基准测试中的最坏情况选择的。基准测试的基线是 geth 1.10.9 中 `KECCAK256` 哈希的性能，符合 4.0 GHz x86_64 CPU 上的 70 Mgas/s gas 限制目标。

| EVM             | 版本   | MB/s | B/CPUcycle | CPUcycle/B | 1 B 的成本 | 32 B 的成本 |
| --------------- | ------ | ---- | ---- | ---- | ---- | ---- |
| geth/KECCAK256  | 1.10.9 |  357 |  1.8 |  0.6 |  0.2 |  6.0 |
| geth            | 1.10.9 | 1091 |  5.5 |  0.2 |  0.1 |  2.0 |
| evmone/基线     | 0.8.2  |  727 |  3.7 |  0.3 |  0.1 |  2.9 |
| evmone/高级     | 0.8.2  |  155 |  0.8 |  1.3 |  0.4 | 13.8 |

### 每字（32 字节块）的 gas 成本

我们选择每字 2 gas 的成本是基于 Geth 的实现，并与 `KECCAK256` 性能进行比较。这意味着每字节的成本为 `0.0625`。虽然 EVM 中不允许分数 gas 成本，但我们可以通过按字收费来近似。

此外，按字计算 gas 与 `CREATE2` 的 *hashcost* 的计算兼容，参见 [EIP-1014](./eip-1014.md)。因此，可以使用相同的实现用于 `CREATE` 和 `CREATE2`，但成本常量不同：激活前 `CREATE` 为 `0`，`CREATE2` 为 `6`，激活后 `CREATE` 为 `2`，`CREATE2` 为 `6 + 2`。

### 初始化代码大小限制的原因

在设定上限的情况下，估算和创建最坏情况场景更容易，因为搜索的一个参数大大减少。这允许选择更乐观的每字节 gas。

如果没有上限，成本需要更高，以考虑未知的未知。鉴于大多数 *initcode*（*TODO: 在此处说明导致在主网部署的最大 initcode 大小*）不超过提议的限制，因过于保守的成本惩罚合约似乎是不必要的。

### 初始化代码大小限制的影响

在创建新合约时，在大多数情况下，结果运行时代码是从初始化代码本身复制的。对于基本情况，`2 * MAX_CODE_SIZE` 的限制允许 `MAX_CODE_SIZE` 用于运行时代码，另一个 `MAX_CODE_SIZE` 用于合约构造函数代码。然而，该限制可能对在单个创建交易中部署多个合约的情况产生实际影响。

### 创建交易的初始化代码成本

创建交易数据的初始化代码成本（每字节 0.0625 gas）与交易数据成本（每字节 4 或 16 gas）相比是微不足道的。尽管如此，我们决定将其包含在规范中以保持一致性，更重要的是为了向前兼容。

### 如何报告初始化代码限制违规？

我们规定，`CREATE`/`CREATE2` 的初始化代码大小限制违规会导致执行异常中止。这将其置于早期耗尽 gas 检查的组中，包括：堆栈下溢、内存扩展、静态调用违规、初始化代码哈希成本，以及本 EIP 引入的初始化代码成本。它们在后续的“轻”检查之前：调用深度和余额。这个选择为检查的顺序提供了一致性，并降低了实现复杂性（耗尽 gas 检查可以以任何顺序执行）。

## 向后兼容性

此 EIP 需要“网络升级”，因为它修改了共识规则。

已经部署的合约不应受到影响，但某些交易（`initcode` 超过提议限制的交易）仍然可以包含在区块中，但会导致异常中止。

## 测试用例

测试应包括以下情况：

- 创建交易，gas 限制足以覆盖初始化代码成本
- 创建交易，gas 限制足以覆盖内在成本，但不包括初始化代码成本
- `CREATE`/`CREATE2`/创建交易，`len(initcode)` 为 `MAX_INITCODE_SIZE`
- `CREATE`/`CREATE2`/创建交易，`len(initcode)` 为 `MAX_INITCODE_SIZE+1`
## 安全考虑

对于客户端实现，这个 EIP 使基于 jumpdest 分析的攻击变得不那么问题，因此应该提高客户端的稳健性。

对于第二层，这个 EIP 引入了之前不存在的故障模式。可能存在工厂合约，它们部署多层合约层次结构，使得多个合约的代码包含在第一个合约的初始化代码中。该 EIP 的作者并不知道有任何这样的合约。

目前，在伦敦，使用 `30M` gas 限制，可以触发总计 `~1.3GB` 的初始化代码的 jumpdest 分析。通过这个 EIP，这种攻击的成本将增加大约 `80M` gas。

## 版权

通过 [CC0](../LICENSE.md) 放弃版权及相关权利。