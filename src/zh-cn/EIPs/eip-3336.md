---
eip: 3336
title: EVM 的分页内存分配
author: Nick Johnson (@arachnid)
discussions-to: https://ethereum-magicians.org/t/eips-3336-and-3337-improving-the-evms-memory-model/5482
status: Stagnant
type: Standards Track
category: Core
created: 2021-03-06
---

## 简单总结
更改 EVM 的内存模型以使用分页。

## 摘要
目前，EVM 将内存按线性数组收费，从地址 0 开始，延伸到已读取或写入的最高地址。这对于简单的使用情况是足够的，但意味着编译器必须生成紧凑使用内存的程序，这导致内存元素的重新分配浪费了 gas，并使某些内存模型（如单独的堆和栈区域）变得不切实际。该 EIP 提议更改为基于页面的计费模型，这为实现增加了最小的复杂性，同时为 EVM 程序提供了更大的灵活性。

## 动机
大多数现代计算机为用户空间程序实现“虚拟内存”，程序可以访问一个大的地址空间，操作系统根据需要分配 RAM 页。这使得它们能够以最小化重新分配和复制的方式在内存中分配数据，并允许对具有不同生命周期的数据灵活使用内存。在 EVM 内部实现一个简单版本的分页内存将为针对 EVM 的编译器提供相同的灵活性。

## 规范
### 参数

| 常量 | 值 |
| - | - |
| `FORK_BLOCK` | 待定 |
| `PAGE_BITS` | 10 |
| `PAGE_BASE_COST` | 96 |

对于 `block.number >= FORK_BLOCK` 的区块，适用以下更改。

### EVM 实现中的内存分配变化
内存现在以每页 `2**PAGE_BITS` 字节的方式分配。每个内存地址的最高 `256 - PAGE_BITS` 位表示页码，而最低 `PAGE_BITS` 位表示页内位置。页面初始化为包含所有零字节，并在从页面读取或写入第一个字节时分配。

鼓励 EVM 实现将页表存储为一个关联数组（例如，哈希表或字典），映射从页码到页面的字节数组。

### 内存扩展 gas 成本的变化
目前，将内存扩展到 `a` 个字的总成本为 `Cmem(a) = 3 * a + floor(a ** 2 / 512)`。如果内存已经是 `b` 个字，则增量成本为 `Cmem(a) - Cmem(b)`。`a` 是覆盖从内存地址 0 到 EVM 已读取或写入的最后一个字的所需字数。

根据该 EIP，我们定义一个新的内存成本函数，基于已分配的页面数量。该函数为 `Cmem'(p) = max(PAGE_BASE_COST * (p - 1) + floor(2 * (p - 1) ** 2), 0)`。如上所述，如果内存已经包含 `q` 页，则增量成本为 `Cmem'(p) - Cmem'(q)`。

### `MLOAD` 和 `MSTORE` 的变化
从内存加载一个字或将一个字存储到内存需要实例化它接触的任何尚不存在的页面，结果的 gas 成本如上所述。如果加载或存储的字位于单个页面中，gas 成本保持不变为 3 gas。如果加载的字跨越两个页面，则成本为 6 gas。

### 其他内存接触操作码的变化
`CALLDATACOPY`、`CODECOPY`、`EXTCODECOPY`、`CALL`、`CALLCODE`、`DELEGATECALL`、`STATICCALL`、`CREATE`、`MSTORE8` 以及任何其他读取或写入内存的操作码修改如下：
 - 任何它们接触的用于读取或写入的页面如果尚不存在，则实例化。
 - 按上述方式收取内存扩展 gas。

## 理由
### 内存扩展 gas 成本
新的 gas 成本遵循与之前相同的曲线，同时确保新的 gas 成本始终小于或等于之前的成本。这防止了对内存分配 gas 成本做出假设的现有程序出现错误，而不会过度降低内存成本。直观上，使用到页面边界的程序支付的费用比旧模型少一页，而使用比页面边界多一个字的程序支付的费用比旧模型少一个字。

我们认为这种增量减少不会对有效的 gas 限制产生重大影响，因为随着程序使用更多 RAM，比例上会变得更小。

### 跨越两个页面的 MLOAD 和 MSTORE 的额外成本
加载或存储跨越两个内存页面的数据需要 EVM 实现做更多工作，必须在页面边界处拆分字并更新两个（可能不相交的）页面。由于我们无法保证现有 EVM 程序中的加载和存储是页面对齐的，因此无法出于效率考虑禁止这种行为。相反，我们建议将每个视为两个加载或存储进行 gas 计算。这会抑制对该功能的使用，并考虑到额外的执行成本，而不完全禁止它。

这将导致任何执行这些操作的程序产生额外的 gas 成本。我们认为这很小，并希望进行未来的分析以确认这一点。

## 向后兼容性
新的内存扩展 gas 成本函数专门设计以避免向后兼容性问题，始终收取的费用小于或等于当前 EVM 收取的费用。在某些情况下，现有程序将因跨越页面边界的 MLOAD 和 MSTORE 而被收取更多费用；我们认为这些更改将影响最少的程序，并对它们的 gas 消耗产生小的影响。

## 测试用例
待定

## 安全考虑
由于在新模型下进行的额外工作可能引发 CPU DoS 问题，通过对非页面对齐的读取和写入收取更多费用来缓解。内存扩展的收费渐近于当前的收费，因此此更改不会允许程序分配比今天多得多的内存。

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。