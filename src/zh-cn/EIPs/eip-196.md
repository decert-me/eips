---
eip: 196
title: 针对椭圆曲线 alt_bn128 的加法和标量乘法的预编译合约
author: Christian Reitwiessner <chris@ethereum.org>
type: Standards Track
category: Core
status: Final
created: 2017-02-02
---

## 简单总结

为了在区块 gas 限制内执行 zkSNARK 验证，需要椭圆曲线操作的预编译合约。

## 摘要

本 EIP 建议为特定的配对友好椭圆曲线添加加法和标量乘法的预编译合约。这可以与 [EIP-197](./eip-197.md) 结合，以在以太坊智能合约中验证 zkSNARK。zkSNARK 对以太坊的总体好处在于，它将增加用户的隐私（由于零知识属性），并可能成为一种可扩展性解决方案（由于简洁性和高效可验证性属性）。

## 动机

当前以太坊上的智能合约执行是完全透明的，这使得它们不适合涉及私人信息的多个用例，例如位置、身份或过去交易的历史。zkSNARK 技术可能是解决此问题的方案。虽然以太坊虚拟机理论上可以利用 zkSNARK，但目前它们的成本过高，无法适应区块 gas 限制。因此，本 EIP 提议为某些基本原语指定特定参数，以启用 zkSNARK，从而使其能够更高效地实现并降低 gas 成本。

请注意，虽然固定这些参数可能看起来限制了 zkSNARK 的使用案例，但这些原语是如此基本，以至于可以以灵活的方式组合，从而甚至可以在不需要进一步硬分叉的情况下允许 zkSNARK 研究的未来进展。

## 规范

如果 `block.number >= BYZANTIUM_FORK_BLKNUM`，则为椭圆曲线 "alt_bn128" 添加点加法（ADD）和标量乘法（MUL）的预编译合约。

ADD 的地址：0x6  
MUL 的地址：0x7

该曲线由以下定义：
```
Y^2 = X^3 + 3
over the field F_p with
p = 21888242871839275222246405745257275088696311157297823662689037894645226208583
```

### 编码

字段元素和标量编码为 32 字节大端数字。曲线点编码为两个字段元素 `(x, y)`，其中无穷远点编码为 `(0, 0)`。

对象的元组编码为它们的连接。

对于这两个预编译合约，如果输入短于预期，则假定在末尾虚拟填充零（即与 `CALLDATALOAD` 操作码的语义兼容）。如果输入长于预期，则末尾的多余字节将被忽略。

返回数据的长度始终如所指定（即不是“未填充”）。

### 精确语义

无效输入：对于两个合约，如果任何输入点不在曲线上或任何字段元素（点坐标）等于或大于字段模数 p，则合约失败。标量可以是 `0` 和 `2**256-1` 之间的任何数字。

#### ADD
输入：两个曲线点 `(x, y)`。  
输出：曲线点 `x + y`，其中 `+` 是上述椭圆曲线 `alt_bn128` 上的点加法。  
在无效输入时失败并消耗提供的所有 gas。

#### MUL
输入：曲线点和标量 `(x, s)`。  
输出：曲线点 `s * x`，其中 `*` 是上述椭圆曲线 `alt_bn128` 上的标量乘法。  
在无效输入时失败并消耗所有 gas。

### Gas 成本

 - ``ECADD`` 的 Gas 成本：500
 - ``ECMUL`` 的 Gas 成本：40000

## 理由

特定曲线 `alt_bn128` 被选择是因为它特别适合 zkSNARK，或者更具体地说，它们的验证构建块配对函数。此外，通过选择这条曲线，我们可以利用与 ZCash 的协同效应，并重用他们的一些组件和工件。

考虑过将曲线和字段参数添加到输入的特性，但最终被拒绝，因为这会使规范复杂化：Gas 成本更难确定，并且可能会在不是实际椭圆曲线的东西上调用合约。

选择了非紧凑点编码，因为它仍然允许在智能合约中执行某些操作（包括完整的 y 坐标），并且可以比较两个编码点的相等性（没有第三个射影坐标）。

## 向后兼容性

与任何预编译合约的引入一样，已经使用给定地址的合约将改变其语义。因此，这些地址取自 256 以下的“保留范围”。

## 测试用例

测试输入：

 - 如果数字取模 p，则曲线点是有效的（应失败）。
 - 两个合约在空输入时应成功。
 - 截断输入导致有效曲线点。
 - 不在曲线上的点（但其他方面有效）。
 - 用于标量乘法的点，其值在群体的阶和字段之间（应成功）。
 - 用于标量乘法的点，其值大于字段阶（应成功）。

## 实现

这些原语的实现可在此处找到：

 - [libff](https://github.com/scipr-lab/libff/blob/master/libff/algebra/curves/alt_bn128/alt_bn128_g1.cpp) (C++)
 - [bn](https://github.com/zcash/bn/blob/master/src/groups/mod.rs) (Rust)

在这两个代码库中，使用了曲线 alt_bn128 上的特定群体，称为 G1。

 - [Python](https://github.com/ethereum/py_pairing/blob/master/py_ecc/bn128/bn128_curve.py) - 可能是最自包含和可读性最好的。

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。