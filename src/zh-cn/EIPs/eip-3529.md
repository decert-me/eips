---
eip: 3529
title: 退款减少
author: Vitalik Buterin (@vbuterin), Martin Swende (@holiman)
discussions-to: https://ethereum-magicians.org/t/eip-3529-reduction-in-refunds-alternative-to-eip-3298-and-3403-that-better-preserves-existing-clearing-incentives/6097
status: Final
type: Standards Track
category: Core
created: 2021-04-22
requires: 2200, 2929, 2930
---

## 简单总结

移除 `SELFDESTRUCT` 的 gas 退款，并将 `SSTORE` 的 gas 退款减少到一个较低的水平，使退款仍然可观，但不再足够高以使当前的退款机制“利用”变得可行。

## 动机

`SSTORE` 和 `SELFDESTRUCT` 的 gas 退款最初是为了激励应用开发者编写“良好状态卫生”的应用程序，清理不再需要的存储槽和合约。然而，这种技术的好处证明远低于预期，且 gas 退款带来了多种意想不到的有害后果：

* 退款导致了 GasToken 的产生。GasToken 在将 gas 空间从低费用时期转移到高费用时期方面有好处，但也对网络产生了负面影响，特别是在加剧状态大小（因为状态槽实际上被用作“电池”来储存 gas）和低效地堵塞区块链 gas 使用方面
* 退款增加了区块大小的方差。区块中实际消耗的 gas 的理论最大值几乎是纸面 gas 限制的两倍（因为退款为区块中的后续交易增加了 gas 空间，尽管退款被限制为交易使用 gas 的 50%）。这并不是致命的，但仍然不理想，尤其是考虑到退款可以用于维持 2 倍的使用峰值，远远超过 EIP-1559 的能力。

## 规范

### 参数

| 常量 | 值 |
| - | - |
| `FORK_BLOCK` | 待定 |
| `MAX_REFUND_QUOTIENT` | 5 |

对于 `block.number >= FORK_BLOCK` 的区块，适用以下更改。

1. 移除 `SELFDESTRUCT` 退款。
2. 将 `SSTORE_CLEARS_SCHEDULE`（如 [EIP-2200](./eip-2200.md) 中定义）替换为 `SSTORE_RESET_GAS + ACCESS_LIST_STORAGE_KEY_COST`（根据 [EIP-2929](./eip-2929.md) + [EIP-2930](./eip-2930.md) 为 4,800 gas）
3. 将交易后的最大退款 gas 减少为 `gas_used // MAX_REFUND_QUOTIENT`

备注：之前的 _最大退款 gas_ 定义为 `gas_used // 2`。在这里我们将常量 `2` 命名为 `MAX_REFUND_QUOTIENT` 并将其值更改为 `5`。

## 理由

在 [EIP-2200](./eip-2200.md#specification) 中，引入了三种退款情况：

1. 如果原始值非零，且新值为零，则向退款计数器添加 `SSTORE_CLEARS_SCHEDULE`（当前为 15,000） gas
2. 如果原始值为零，当前值非零，且新值为零，则向退款计数器添加 `SSTORE_SET_GAS - SLOAD_GAS`（当前为 19,900） gas
3. 如果原始值非零，当前值为不同的非零值，且新值等于原始值，则向退款计数器添加 `SSTORE_RESET_GAS - SLOAD_GAS`（当前为 4,900） gas

在这三种情况下，只有 (1) 使 gastokens 成为可能，并允许一个区块在执行时消耗更多的 gas 超过区块 gas 限制。（2）没有这个特性，因为要获得 19,900 的退款，_同一个存储槽_ 必须先从零更改为非零，耗费 20,000 gas。无法从清除一个存储槽中获得 gas 并用于编辑另一个存储槽，这意味着它不能用于 gas 代币。此外，获得退款需要 _撤销_ 存储写入和扩展的效果，因此退款的 gas 不会对客户端处理区块的负担产生贡献。（3）的行为类似：4,900 的退款只能在同一个存储槽上先花费 5,000 gas 时获得。

此 EIP 处理情况 (1)。我们可以通过使用类似的“配对”论证，映射每个退款到同一交易中对同一存储槽的先前支出，来确定在什么条件下 gastoken 是不可行的（即你不能从一个存储槽中获得比你投入的更多的 gas）。如果一个存储槽在其原始值为非零时被更改为零，则有两种可能性：

1. 这可能是第一次将存储槽设置为零。在这种情况下，我们可以将此事件与 `SSTORE_RESET_GAS + ACCESS_LIST_STORAGE_KEY_COST` 读取和编辑存储槽的最低成本配对。
2. 这可能是第二次或更晚的将存储槽设置为零。在这种情况下，我们可以将此事件与最近一次将值设置为非零的时间配对，在此情况下 `SSTORE_CLEARS_SCHEDULE` gas 被 _移除_。

对于第二次及以后的事件，`SSTORE_CLEARS_SCHEDULE` 的值无关紧要，因为每个该大小的退款都与相同大小的退款 _移除_ 配对。这留下了第一次事件。为了确保在槽上支出的总 gas 为正，我们需要 `SSTORE_CLEARS_SCHEDULE <= SSTORE_RESET_GAS + ACCESS_LIST_STORAGE_KEY_COST`。因此，此 EIP 只是将 `SSTORE_CLEARS_SCHEDULE` 减少到这两个成本的总和。

此 EIP 的另一种直观理解是，对于清除尚未读取的数据（通常是“无用”数据），不会有净退款，但对于清除已读取的数据（可能是“有用”数据），将继续有净退款。

## 向后兼容性

退款目前仅在交易执行 _后_ 应用，因此它们不会影响在执行期间任何特定调用帧可用的 gas 量。因此，移除它们不会破坏任何代码的执行能力，尽管这将使某些应用在经济上不可行。

Gas 代币将变得毫无价值。DeFi 套利机器人，今天经常使用既定的 gas 代币方案或自定义替代方案来降低链上成本，将受益于重写其代码以移除对这些不再有效的 gas 存储机制的调用。

然而，在 `new = original = 0 != current` 的情况下完全保留退款，并在其他 `nonzero -> zero` 情况下保留 _一些_ 退款，确保一些关键用例获得（并应得）有利的 gas 成本待遇继续如此。例如，`zero -> nonzero -> zero` 存储设置模式继续仅花费 ~100 gas。这些模式的两个重要示例包括：

* 防重入锁（通常在子调用开始前从 0 翻转到 1，然后在子调用结束时翻转回 0）
* ERC20 授权并发送（“授权值”在授权代币转移时从零变为非零，然后在代币转移处理时再次变为零）

### 对存储清除激励的影响

早期退款移除 EIP 的一个批评（[EIP-3298](./eip-3298.md) 和 [EIP-3403](./eip-3403.md)）是这些 EIP 完全移除了将值设置为零的激励，鼓励用户在期望再次使用该存储槽的情况下不完全清除存储槽。

例如，如果你有 1 个 ERC20 代币并且你要赠送或出售你的全部余额，你可以选择只赠送 0.999999 个单位并留下剩余部分。如果你将来决定用同一账户重新获取更多该代币，你只需支付 5000 gas（2100 用于读取 + 2900 用于非零到非零设置）进行 `SSTORE`，而不是 22100（20000 用于零到非零设置）。今天，这被 15000 的清除退款所抵消，因此你只有在超过 `15000 / 17100 = 87.7%` 确定会再次使用该槽时才有激励去这样做；而在 EIP-3298 或 EIP-3403 中，抵消激励将不存在，因此如果你再次使用该槽的机会 _任何_ 大于 0% 的值，设置为非零将更好。
退款的 4800 gas 仍然存在，因此只有在你预计再次使用该存储槽的概率超过 `4800 / 17100 = 28.1%` 时，保持存储槽非零才有激励。这并不完美，但可能高于一般人清空其全部余额后再次获取同一地址代币的期望。

退款上限为已支出的 gas 的 1/5，这意味着此退款只能用于最多增加处理区块所需的存储写操作数量的 25%，限制了利用此机制进行以存储写为重点的拒绝服务攻击的能力。

## 测试用例

### EIP-2929 Gas 成本

请注意，“热”槽和“冷”槽之间存在差异。此表显示截至 [EIP-2929](./eip-2929.md) 的值，假设所有触及的存储槽已经是“热”的（差异为一次性成本 `2100` gas）。

| 代码 | 使用的 Gas | 退款 | 原始 | 第 1 次 | 第 2 次 | 第 3 次 | 退款后的有效 gas |
| -- | -- | -- | -- | -- | -- | -- | -- |
| `0x60006000556000600055` | 212 | 0| 0 | 0 |  0 |  |  212 |
| `0x60006000556001600055` | 20112 | 0| 0 | 0 |  1 |  |  20112 |
| `0x60016000556000600055` | 20112 | 19900| 0 | 1 |  0 |  |  212 |
| `0x60016000556002600055` | 20112 | 0| 0 | 1 |  2 |  |  20112 |
| `0x60016000556001600055` | 20112 | 0| 0 | 1 |  1 |  |  20112 |
| `0x60006000556000600055` | 3012 | 15000| 1 | 0 |  0 |  |  -11988 |
| `0x60006000556001600055` | 3012 | 2800| 1 | 0 |  1 |  |  212 |
| `0x60006000556002600055` | 3012 | 0| 1 | 0 |  2 |  |  3012 |
| `0x60026000556000600055` | 3012 | 15000| 1 | 2 |  0 |  |  -11988 |
| `0x60026000556003600055` | 3012 | 0| 1 | 2 |  3 |  |  3012 |
| `0x60026000556001600055` | 3012 | 2800| 1 | 2 |  1 |  |  212 |
| `0x60026000556002600055` | 3012 | 0| 1 | 2 |  2 |  |  3012 |
| `0x60016000556000600055` | 3012 | 15000| 1 | 1 |  0 |  |  -11988 |
| `0x60016000556002600055` | 3012 | 0| 1 | 1 |  2 |  |  3012 |
| `0x60016000556001600055` | 212 | 0| 1 | 1 |  1 |  |  212 |
| `0x600160005560006000556001600055` | 40118 | 19900| 0 | 1 |  0 |  1 |  20218 |
| `0x600060005560016000556000600055` | 5918 | 17800| 1 | 0 |  1 |  0 |  -11882 |

### 减少退款的情况

如果通过将 `SSTORE_CLEARS_SCHEDULE` 从 15000 更改为 4800（并移除自毁退款）来部分移除退款，则比较表如下。

| 代码 | 使用的 Gas | 退款 | 原始 | 第 1 次 | 第 2 次 | 第 3 次 | 退款后的有效 gas |
| -- | -- | -- | -- | -- | -- | -- | -- |
| `0x60006000556000600055` | 212 | 0| 0 | 0 |  0 |  |  212 |
| `0x60006000556001600055` | 20112 | 0| 0 | 0 |  1 |  |  20112 |
| `0x60016000556000600055` | 20112 | 19900| 0 | 1 |  0 |  |  212 |
| `0x60016000556002600055` | 20112 | 0| 0 | 1 |  2 |  |  20112 |
| `0x60016000556001600055` | 20112 | 0| 0 | 1 |  1 |  |  20112 |
| `0x60006000556000600055` | 3012 | 4800| 1 | 0 |  0 |  |  -1788 |
| `0x60006000556001600055` | 3012 | 2800| 1 | 0 |  1 |  |  212 |
| `0x60006000556002600055` | 3012 | 0| 1 | 0 |  2 |  |  3012 |
| `0x60026000556000600055` | 3012 | 4800| 1 | 2 |  0 |  |  -1788 |
| `0x60026000556003600055` | 3012 | 0| 1 | 2 |  3 |  |  3012 |
| `0x60026000556001600055` | 3012 | 2800| 1 | 2 |  1 |  |  212 |
| `0x60026000556002600055` | 3012 | 0| 1 | 2 |  2 |  |  3012 |
| `0x60016000556000600055` | 3012 | 4800| 1 | 1 |  0 |  |  -1788 |
| `0x60016000556002600055` | 3012 | 0| 1 | 1 |  2 |  |  3012 |
| `0x60016000556001600055` | 212 | 0| 1 | 1 |  1 |  |  212 |
| `0x600160005560006000556001600055` | 40118 | 19900| 0 | 1 |  0 |  1 |  20218 |
| `0x600060005560016000556000600055` | 5918 | 7600| 1 | 0 |  1 |  0 |  -1682 |

## 安全考虑

退款对交易执行不可见，因此这不应对交易执行逻辑产生任何影响。

在一个区块中，执行所能消耗的最大 gas 限制为 gas 限制，如果我们不计算后续重置为零的零到非零的 `SSTORE`。不计算这些是可以的，因为如果这样的 `SSTORE` 被重置，存储不会扩展，客户端也不需要实际调整默克尔树；gas 消耗会被退款，但客户端通常需要处理这些操作码的工作量也会被取消。**客户端应确保在 `new_value = original_value` 时不进行存储写入；这是自以太坊开始以来的一个明智优化，但现在变得更加重要。**

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。