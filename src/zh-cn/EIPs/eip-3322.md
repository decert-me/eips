---
eip: 3322
title: 账户 gas 存储操作码
author: William Morriss (@wjmelements)
discussions-to: https://ethereum-magicians.org/t/eip-3322-efficient-gas-storage/5470
status: Stagnant
type: Standards Track
category: Core
created: 2020-03-04
---

## 简单总结
允许合约账户存储可以转移到退款计数器的 gas。

## 摘要
合约可以持久化 gas，以便稍后转移到退款计数器。
引入了三个操作码来读取、增加和使用此 gas 计数器。

## 动机
退款机制目前被 gas 代币用于套利 gas 价格。
这通过将 gas 从需求较少的区块转移到需求较多的区块，带来了 gas 供应的弹性和价格的稳定性。
不幸的是，这奖励了不必要的状态增长。
通过引入更优的 gas 存储机制，gas 市场将需要更少的存储和计算。

## 规范
合约账户获得一个无符号的 gas 退款计数器，初始值为零。

引入了三个新的操作码来管理此状态。

* `SELFGAS` (`0x49`): 将当前账户的 gas 退款计数器推送到栈上。
与 `SELFBALANCE` 共享 gas 定价。
* `USEGAS` (`0x4a`): 从栈中弹出 `amount`。
将 `amount` 和当前账户的 gas 退款计数器中的最小值转移到执行上下文的退款计数器。
消耗 `5000` gas。
* `STOREGAS` (`0x4b`): 从栈中弹出 `amount`。
消耗 `5000 + amount` gas。
将当前账户的 gas 退款计数器增加 `amount`。

## 理由
通过重用执行上下文的退款计数器，我们可以重用其 50% 的 DoS 保护，这将其区块弹性贡献限制为 2 倍。

gas 成本基于类似的操作码 `SELFBALANCE` 和 `SSTORE`。

大多数账户将不会存储任何 gas，因此每个账户的存储开销在正常情况下应该是最小的甚至为零。

所选择的操作码编号与 `SELFBALANCE` 和 `GASLIMIT` 在同一 `0x4X` 范围内。

## 向后兼容性
由于 gas 被添加到退款计数器，因此预计不会出现兼容性问题。

## 测试用例
| 代码             | 使用的 Gas | 退款 | 原始 | 最终 |
|------------------|----------|--------|----------|-------|
| 0x60004900       |     5003 |      0 |        0 |     0 |
| 0x60034900       |     5003 |      2 |        2 |     0 |
| 0x60034900       |     5003 |      3 |        3 |     0 |
| 0x60034900       |     5003 |      3 |        4 |     1 |
| 0x60034960034900 |    10006 |      4 |        4 |     0 |
| 0x60034960034900 |    10006 |      6 |        6 |     0 |
| 0x484900         |     5010 | 100000 |   100000 |     0 |
| 0x61ffff4a00     |    70538 |      0 |        0 | 65535 |


## 安全考虑
DoS 已经通过 50% 的退款限制得到了限制。

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。