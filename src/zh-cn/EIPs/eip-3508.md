---
eip: 3508
title: 交易数据操作码
author: Alex Papageorgiou (@alex-ppg)
discussions-to: https://ethereum-magicians.org/t/eip-draft-transaction-data-opcodes/6017
status: Stagnant
type: Standards Track
category: Core
created: 2021-04-16
---

## 简单总结

提供对原始交易数据的访问。

## 摘要

本 EIP 引入了以下三个 EVM 指令：`ORIGINDATALOAD`、`ORIGINDATASIZE` 和 `ORIGINDATACOPY`。

这三个指令旨在提供对原始交易的 `data` 负载的访问，从而在跨合约调用中以节省 gas 的方式访问大型数据负载。

## 动机

随着以太坊开发场景的成熟，越来越多雄心勃勃和复杂的功能被引入到智能合约中，这往往需要利用复杂且有时较大的数据结构。然而，考虑到 EVM 的固有限制，在合约之间传输大型数据结构是一项昂贵的任务，有时甚至会导致无效的场景，即此类操作的 gas 消耗无法在 gas 限制范围内执行，同时又不得不牺牲大量 ETH 来支付其 gas 成本。

本 EIP 的目的是通过引入一种方式，使多合约系统能够访问相同的内存数据源，而不必在它们之间传输完整的负载，从而使这些功能变得可行。

本 EIP 使复杂的智能合约功能能够成为更大调用链的一部分，通过有效地从原始交易负载中读取数据，而不是要求将数据作为调用级数据传递。其包含将主要使先进的无信任方案得以实现，例如有效验证默克尔帕特里夏树以验证特定以太坊区块的存储值或基于 EVM 的二层解决方案。

此更改的一个副作用是，完全依赖原始数据的智能合约系统本质上保证它们接收到的数据没有被中间智能合约调用篡改。

## 规范

### ORIGINDATALOAD (`0x47`)、ORIGINDATASIZE (`0x48`) 和 ORIGINDATACOPY (`0x49`)

这些指令的操作方式与其调用前缀的对应指令类似，唯一的区别是它们操作的是交易的原始 `data`，而不是当前调用的数据。具体来说：

- ORIGINDATALOAD (`0x47`) 的功能类似于 CALLDATALOAD (`0x35`)
- ORIGINDATASIZE (`0x48`) 的功能类似于 CALLDATASIZE (`0x36`)
- ORIGINDATACOPY (`0x49`) 的功能类似于 CALLDATACOPY (`0x37`)

由于数据是从执行环境中再次检索的，因此这三个指令的成本将分别为 `G_verylow`、`G_base` 和 `G_base + G_verylow * (复制的字数，向上取整)`。

`ORIGINDATA*` 操作码操作的交易数据将等同于在堆栈中最近的 `AUTHCALL` (`0xf7`) 的 `args*` 参数中指定的 `calldata`。如果堆栈中没有 `AUTHCALL`，则 `ORIGINDATA*` 将操作交易的原始 `data` 字段。

这种交互确保与 [EIP-3074](./eip-3074.md) 完全兼容，并确保本 EIP 不会在系统中引入任何形式的歧视，例如完全依赖 `ORIGINDATA*` 的合约，从而仅允许 EOA 向其提供数据。

## 理由

### AUTHCALL (`0xf7`) 交互

将作为伦敦分叉一部分的 [EIP-3074](./eip-3074.md) 引入了一种新的调用指令 `AUTHCALL` (`0xf7`)，它将交易的 `ORIGIN` (`0x32`) 替换为上下文变量 `authorized`。`AUTHCALL` 的意图是防止智能合约和 EOA 之间的歧视，而 `ORIGIN` 最初促进了这种歧视，因此，替换 `ORIGINDATA*` 操作码检索的值为 `AUTHCALL` 中使用的值也是合理的。

### 命名约定

以 `ORIGIN` 为前缀的指令试图遵循现有的以 `CALL` 为前缀的指令的命名约定，因为存在与原始交易上下文等效的 `ORIGIN` (`0x32`) 指令。

### 指令地址空间

`0x30-0x3f` 的指令地址空间已被提供有关调用执行上下文的信息的调用耗尽，因此必须识别一个适合本 EIP 目的的新范围。

鉴于 [EIP-1344](./eip-1344.md) 的 `CHAINID` 操作码被包含在 `0x46`，因此在其之后包含额外的与交易相关的数据是合理的，因为链 ID 也包含在交易负载中，而不仅仅是区块本身，从而将 `0x46-0x4f` 地址空间保留用于未来可能需要的更多与交易相关的数据，例如 EOA 的 nonce。

### Gas 成本

操作码 ORIGINDATALOAD (`0x47`)、ORIGINDATASIZE (`0x48`) 和 ORIGINDATACOPY (`0x49`) 本质上执行与操作码 CALLDATALOAD (`0x35`)、CALLDATASIZE (`0x36`) 和 CALLDATACOPY (`0x37`) 相同的操作，因此共享完全相同的 gas 成本。

### 指令空间污染

有人可能会争辩说，多个新的 EVM 指令污染了 EVM 指令地址空间，并可能导致为未来指令分配合理指令代码时出现问题。对此特定问题进行了评估，并构思了一种方法，通过该方法，原始 RLP 编码的交易可以被 EVM 访问。这将使新的指令集具有 _未来保障_，因为它将可用于未来可能希望在链上访问的交易的其他成员，但这也会导致 `ORIGIN` 操作码的冗余。

## 向后兼容性

本 EIP 不会更改或调整 EVM 提供的现有功能，因此不存在已知问题。

## 测试用例

TODO.

## 安全考虑

### 反思合约

原子地，`ORIGINDATALOAD` 和 `ORIGINDATACOPY` 的值应被视为不安全，因为它们可以通过创建具有适当函数签名和参数的入口智能合约轻松伪造，从而在调用链中调用其他合约。简而言之，应该始终假设 `tx.data != calldata`，并且这些指令不应单独用作反思工具。

### 拒绝服务攻击

本 EIP 可能引发的一个初步担忧是，必须在节点的软件级别向 EVM 提供额外的上下文数据，以便它能够通过 `ORIGINDATALOAD` 和 `ORIGINDATACOPY` 指令访问所需的数据。

这将导致内存消耗的增加，然而，如果存在的话，这种增加应该是微不足道的，因为交易的数据应该已经作为其执行过程的一部分存在于内存中；这是交易包含在区块中的整体步骤。

### 多合约系统 Gas 减少

鉴于目前在以太坊上部署的大多数复杂智能合约系统依赖于跨合约交互，通过函数调用将值从一个合约传递到另一个合约，`ORIGIN` 前缀的指令集将为智能合约系统提供一种在调用链执行的任何步骤中获取原始交易数据的方式，这可能导致跨合约调用最终消耗更少的 gas，因为由于此更改而减少了它们之间传递的数据。
然而，gas 的减少将是基于实现的优化，这也仅适用于基本的内存参数，而不是基于存储的数据，后者在这些类型的调用中最常被使用。因此，这一变化所观察到的整体 gas 减少对于大多数实现来说将是微不足道的。

## 版权

通过 [CC0](../LICENSE.md) 放弃版权及相关权利。