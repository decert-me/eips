---
eip: 6189
title: 别名合约
description: 允许创建将调用转发到其他合约的合约
author: Gavin John (@Pandapip1)
discussions-to: https://ethereum-magicians.org/t/eip-6190-functional-selfdestruct/12232
status: 停滞
type: 标准跟踪
category: 核心
created: 2022-12-20
requires: 2929, 6188
---

## 摘要

此 EIP 允许使用魔法 nonce 将合约转换为“别名合约”。别名合约会自动将调用转发到其他合约。

## 动机

此 EIP 本身并不是特别有用，因为它增加了额外的计算和 gas 成本，而没有任何有用的副作用。然而，结合 [EIP-6190](./eip-6190.md)，它可以用于使 SELFDESTRUCT 与 Verkle 树兼容。

## 规范

本文档中的关键字“必须”、“必须不”、“要求”、“应”、“应不”、“应该”、“应该不”、“推荐”、“可以”和“可选”应按 RFC 2119 和 RFC 8174 中的描述进行解释。

### 定义

如果合约的 nonce 为 `2^64-1`，并且其合约代码等于 `0x1`，则该合约为别名合约。

### 先决条件

必须使用 [EIP-6188](./eip-6188.md) 来保护魔法 nonce 值 `2^64-1`。

### 操作码更改

#### `CALL`、`CALLCODE`、`DELEGATECALL`、`STATICCALL`、`PAY` 和 EOA 交易

“被调用者”指的是正在被调用或被支付的账户。

如果被调用者的 nonce 为 `2^64-1`，则调用必须转发到被调用者的 `0` 号存储槽中存储的地址（就好像被调用者是存储在被调用者的 `0` 号存储槽中的地址）。这必须重复，直到达到非别名合约。`CALLER` 必须保持不变。

如果链中有多个别名合约，则原始被调用者和所有后续被调用者（除了最后一个）必须将其 `0` 号存储槽设置为最终非别名合约的地址。然后，调用必须照常转发。**即使在像 `STATICCALL` 这样的只读上下文中，这也必须发生。**

例如，如果 `A` 是一个别名合约，它将调用转发到 `B`，而 `B` 是一个别名合约，它将调用转发到 `C`，那么 `A` 的 `0` 号存储槽将设置为 `C` 的地址。然后，调用被转发到 `C`。

最后，操作码必须照常进行，使用最终的非别名合约。

`CALL`、`CALLCODE`、`DELEGATECALL` 和 `STATICCALL` 操作码以及 EOA 交易必须每访问一个账户消耗 `25` gas（包括最终的账户，以及如果没有使用别名账户），此外还要加上访问账户所产生的所有常规费用（见 [EIP-2929](./eip-2929.md)）。对于每个更新了 `0` 号存储槽的账户，这些操作码还必须额外消耗 `5000` gas。

如果发生无限循环，交易必须耗尽 gas 并回滚。

#### `EXTCODEHASH`、`EXTCODECOPY`、`EXTCODESIZE` 和 `BALANCE`

“被访问账户”指的是正在被访问的账户（即正在被访问其代码的账户，或正在被访问其余额的账户）。

与 `CALL` 系列操作码类似，如果被访问账户的 nonce 为 `2^64-1`，则被访问账户的地址必须替换为存储在被访问账户的 `0` 号存储槽中的地址。这必须重复，直到达到非别名合约。

如果链中有多个别名合约，则原始被访问账户和所有后续被访问账户（除了最后一个）必须将其 `0` 号存储槽设置为最终非别名合约的地址。然后，被访问账户必须照常替换。**即使在像 `STATICCALL` 这样的只读上下文中，这也必须发生。**

最后，操作码必须照常进行，使用最终的非别名合约。

`EXTCODEHASH`、`EXTCODECOPY`、`EXTCODESIZE` 和 `BALANCE` 操作码必须每访问一个账户消耗 `25` gas（包括最终的账户，以及如果没有使用别名账户），此外还要加上访问账户所产生的所有常规费用（见 [EIP-2929](./eip-2929.md)）。对于每个更新了 `0` 号存储槽的账户，这些操作码还必须额外消耗 `5000` gas。

如果发生无限循环，交易必须耗尽 gas 并回滚。

#### `CREATE` 和 `CREATE2`

如果 `CREATE` 或 `CREATE2` 会在某个地址创建（或未能创建，具体取决于使用的 EIP）一个账户，并且该账户的代码为 `0x1`，且其 nonce 为 `2^64-1`，则必须尝试在现有账户的 `0` 号存储槽中存储的地址创建合约，而不是回滚。这必须重复，直到达到非别名合约。

如果链中有多个别名合约，则原始被访问账户和所有后续被访问账户（除了最后一个）必须将其 `0` 号存储槽设置为最终非别名合约的地址。

最后，操作码必须照常进行，返回新创建合约的地址。

`CREATE` 和 `CREATE2` 操作码必须每访问一个账户消耗 `25` gas（包括最终的账户，以及如果没有使用别名账户），此外还要加上访问账户所产生的所有常规费用（见 [EIP-2929](./eip-2929.md)）。对于每个更新了 `0` 号存储槽的账户，这些操作码还必须额外消耗 `5000` gas。

如果发生无限循环，交易耗尽 gas 并回滚。

#### `ADDRESS`

此操作码保持不变；`ADDRESS` 指向没有 nonce 为 `2^64-1` 的地址。

### 转账到零地址

转账到零地址继续具有与 `CREATE` 操作码相同的效果，并将如 [`CREATE` 和 `CREATE2`](#create-and-create2) 部分所述消耗额外的 gas。

### 交易有效性

“来源”指的是发送交易以进行验证的账户。

如果来源的 nonce 为 `2^64-1`，则必须将来源更新为当前来源的 `0` 号存储槽中存储的地址（就好像来源是存储在当前来源的 `0` 号存储槽中的地址）。这必须重复，直到达到非别名合约。

如果链中有多个别名合约，则原始来源和所有后续来源（除了最后一个）必须将其 `0` 号存储槽设置为最终非别名合约的地址。然后，调用必须照常转发。

每访问一个账户消耗额外的 `25` gas（包括最终的账户，以及如果没有使用别名账户），此外还要加上访问账户所产生的所有常规费用（见 [EIP-2929](./eip-2929.md)），这将增加验证成本。对于每个更新了 `0` 号存储槽的账户，还需额外消耗 `5000` gas。

最后，验证照常进行。

### RPC 端点更改

#### `eth_getStorageAt`

如果目标合约的合约代码为 `0x1` 且 nonce 为 `2^64-1`，则 `eth_getStorageAt` RPC 端点必须返回错误。

## 理由

额外的 `25` gas 成本代表获取 nonce 并将其与给定值进行比较的成本。

`eth_getStorageAt` 被修改为抛出错误是因为别名合约的特殊行为。

选择 `2^64-1` 作为 nonce 是因为它是由 [EIP-6188](./eip-6188.md) 保护的 nonce。

选择 `0x1` 作为合约代码是任意的。选择非零代码是为了防止某个 nonce 为 `2^64-1` 的非别名合约以某种方式将其代码设置为 `0x0`，或者某个 EOA 将其 nonce 设置为 `2^64-1`。
## 向后兼容性

此 EIP 需要协议升级，因为它修改了共识规则。现有合约不应受到影响，因为它们不会有 `2^64-1` 的 nonce，也不会有合约代码 `0x1`。

## 安全考虑

额外的 gas 成本可能会导致潜在的 DoS 攻击，如果它们访问任意合约的数据或频繁进行合约停用。合约作者必须意识到这一点并相应地设计合约。现有已部署代码执行自主销毁和复活可能会受到影响。

## 版权

通过 [CC0](../LICENSE.md) 放弃版权及相关权利。