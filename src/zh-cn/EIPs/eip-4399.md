---
eip: 4399
title: 用 PREVRANDAO 替代 DIFFICULTY 操作码
description: 通过替代 DIFFICULTY 操作码语义在 EVM 中暴露信标链随机性
author: Mikhail Kalinin (@mkalinin), Danny Ryan (@djrtwo)
discussions-to: https://ethereum-magicians.org/t/eip-4399-supplant-difficulty-opcode-with-random/7368
status: Final
type: Standards Track
category: Core
created: 2021-10-30
requires: 3675
---

## 摘要

本 EIP 替代现有 `DIFFICULTY (0x44)` 操作码的返回值语义，并将该操作码重命名为 `PREVRANDAO (0x44)`。

在此更改后，`DIFFICULTY (0x44)` 指令的返回值为信标链提供的随机性信标的输出。


## 动机

应用程序可以从信标链累积的随机性中受益。因此，信标链生成的随机性输出应该在 EVM 中可访问。

在 [EIP-3675](./eip-3675.md) 中描述的权益证明（PoS）升级的 `TRANSITION_BLOCK` 时点，`difficulty` 区块字段 **MUST** 在此之后为 `0`，因为区块上不再有任何工作量证明（PoW）印章。这意味着 `DIFFICULTY (0x44)` 指令不再具有其先前的语义含义，也没有明确的“正确”返回值。

根据对 `DIFFICULTY` 使用情况的先前分析，该指令返回的值与其他值混合是智能合约获取随机性的常见模式。与 `DIFFICULTY` 操作码具有相同编号的指令返回信标链 RANDAO 实现的输出，使得现有智能合约从 `DIFFICULTY` 指令获取随机性的升级与 PoS 向后兼容。

此外，本 EIP 提出的更改允许智能合约确定 PoS 升级是否已经发生。这可以通过分析 `DIFFICULTY` 指令的返回值来完成。返回值大于 `2**64` 表示交易在 PoS 区块中执行。如果可用的区块数据包括相关交易，反编译器和其他类似工具也可以使用此技巧来识别指令的新语义。


## 规范

### 定义

* **`TRANSITION_BLOCK`** 此区块的定义可以在 [EIP-3675](./eip-3675.md#definitions) 的定义部分找到。

### 区块结构

从 `TRANSITION_BLOCK` 开始，客户端软件 **MUST** 将 `mixHash` 的值，即区块头中编号为 `13`（0 索引）的字段，设置为前一个区块后信标状态的最新 RANDAO 混合值。

### EVM

从 `TRANSITION_BLOCK` 开始，`DIFFICULTY (0x44)` 指令 **MUST** 返回 `mixHash` 字段的值。

*注意*: `DIFFICULTY (0x44)` 操作码的 gas 成本保持不变。

### 重命名

`mixHash` 字段 **SHOULD** 进一步重命名为 `prevRandao`。

`DIFFICULTY (0x44)` 操作码 **SHOULD** 进一步重命名为 `PREVRANDAO (0x44)`。


## 理由

### 在区块头中包含 RANDAO 输出

在区块头中包含 RANDAO 输出提供了一种直接的方法，可以从 EVM 内部访问，因为区块头数据在 EVM 上下文中已经可用。

此外，这确保执行层可以仅通过区块本身完全执行，而无需从 PoS 共识层获取额外输入。

将随机性混合到区块头中可能有助于在其他区块头字段的值与另一个区块的头部相应值匹配时，区块哈希的唯一性。

### 使用 `mixHash` 字段而不是 `difficulty`

使用 `mixHash` 头字段而不是 `difficulty` 是为了避免在 PoS 升级后出现一类隐藏的分叉选择错误。

实现 EIP-3675 之前逻辑的客户端软件严重依赖于 `difficulty` 值，因为总难度计算是 PoW 分叉选择规则的基础。在 PoS 升级时将 `difficulty` 字段设置为 `0` 旨在减少与升级后总难度值增长相关的错误表面。

此外，PoS 升级后任何潜在的总难度计算如果随机性输出替代了 `difficulty` 字段的值，将变得容易溢出。

### 重用现有字段而不是附加新字段

在 PoS 升级时，`mixHash` 字段被弃用，并在此后设置为零字节数组。重用现有字段作为随机性输出的存放位置每个区块节省 32 字节，并有效消除了由于升级引起的一个字段的弃用。

### 重用 `DIFFICULTY` 操作码而不是引入新操作码

见 [动机](#motivation)。

### 重命名字段和操作码

重命名应当使字段和操作码名称在语义上合理。

### 使用 `TRANSITION_BLOCK` 而不是区块或槽编号

通过利用 `TRANSITION_BLOCK` 来触发本 EIP 中定义的逻辑变化，而不是区块或槽编号，使得本 EIP 与 [EIP-3675](./eip-3675.md) 定义的 PoS 升级紧密耦合。

通过与 PoS 升级紧密耦合，我们确保在使用此操作码获取随机性时没有不连续性——这是重用 `DIFFICULTY` 而不是创建新操作码的主要 [动机](#motivation)。

### 使用 `2**64` 阈值来确定 PoS 区块

RANDAO 值落入 `0` 和 `2**64` 之间的概率，因此与 PoW 难度值混合的概率极低。尽管提议的阈值可能看起来与以太坊主网的难度值（目前约为 `2**54`）距离不足，但要使此阈值不安全，需要将哈希率提高一千倍。这种增加被认为在即将到来的共识升级之前是不可能发生的。


## 向后兼容性

本 EIP 对 EVM 状态转换的执行和验证引入了向后不兼容的更改。如所述，本 EIP 利用 `TRANSITION_BLOCK`，因此与 [EIP-3675](./eip-3675.md) 引入的 PoS 升级紧密耦合。如果要采纳本 EIP，**MUST** 与 EIP-3675 同时安排。

此外，所提议的更改可能对以下类别的应用程序向后不兼容：
* 使用 `DIFFICULTY` 操作码返回值作为 PoW `difficulty` 参数的应用程序
* 逻辑依赖于 `DIFFICULTY` 操作码返回相对于字段的完整 256 位大小的相对较小数字的应用程序。

第一类已经受到将共识机制切换到 PoS 的影响，并且此规范未引入额外的破坏性更改。

第二类由在可能导致溢出或下溢错误的操作中使用 `DIFFICULTY` 操作码返回值的应用程序组成。虽然理论上可以编写一个应用程序，其中此操作码可能返回的值范围的变化可能导致安全漏洞，但这种可能性微乎其微。


## 测试用例

* 在 `TRANSITION_BLOCK` 的一个祖先中部署一个合约，该合约将 `DIFFICULTY (0x44)` 的返回值存储到状态中
* 检查在 `TRANSITION_BLOCK` 的父区块内执行的交易中，`DIFFICULTY (0x44)` 返回的值是否等于 `difficulty` 字段值
* 检查在 `TRANSITION_BLOCK` 内执行的交易中，`PREVRANDAO (0x44)` 返回的值是否等于 `prevRandao` 字段值
## 安全考虑

在 PoS 以太坊中，`PREVRANDAO (0x44)` 操作码（基于信标链 RANDAO 实现）是一个具有不同属性的随机性来源，与 PoW 网络中的 `BLOCKHASH (0x40)` 或 `DIFFICULTY (0x44)` 操作码提供的随机性不同。

### 偏见性

信标链 RANDAO 实现为每个区块提议者在每个时隙提供 1 位影响力。提议者可能故意拒绝在机会成本和交易费用的情况下提议一个区块，以防止信标链随机性（RANDAO 混合）在特定时隙中被更新。

提议者的影响力在时间上是有限的，并持续到之后第一次诚实的 RANDAO 揭示为止。当 `n` 个连续时隙的提议者串通以获得 `n` 位影响力时，这种限制也存在。简单来说，即使在连续几个时隙中存在偏见，只要有一个诚实的区块提议，就足以消除 RANDAO 的偏见。

此外，`PREVRANDAO (0x44)` 指令的语义为提议者提供了另一种在应用程序上获得 1 位影响力的方法。偏见提议者可能会审查一个掷骰子交易，以强制其包含在下一个区块中，从而强制使用提议者事先知道的 RANDAO 混合。在这种情况下，机会成本将是微不足道的。

### 可预测性

显然，任何去中心化预言机提供的历史随机性是 100% 可预测的。相反，未来揭示的随机性在有限范围内是可预测的。

影响信标链未来随机性的输入列表包括但不限于以下项目：
* **累积随机性。** 在纪元 `N` 的最后一个时隙产生的 RANDAO 混合是定义纪元 `N + MIN_SEED_LOOKAHEAD + 1` 每个时隙区块提议者的主要输入，即它是定义未来 RANDAO 揭示者的主要因素。
* **活跃验证者数量。** 在一个纪元内的活跃验证者数量是区块提议者函数的另一个输入。
* **有效余额。** 在其他条件相同的情况下，验证者的有效余额越低，该验证者在某个时隙被指定为提议者的机会就越小。
* **意外错过的提议。** 网络条件和其他因素导致的意外错过提议是影响 RANDAO 混合的高质量熵的来源。主网的常见错过提议率约为 `1%`。

这些输入在短时间范围内可能是可预测和可塑的，但尝试的前瞻时间越长，信标链积累的熵就越多。

### 应用开发者的建议

以下建议旨在减少 `PREVRANDAO (0x44)` 返回的随机性输出的可预测性和偏见性：

1. 让您的应用程序依赖于具有合理高前瞻性的未来随机性。例如，应用程序在纪元 `K` 结束时停止接受出价，并使用在时隙 `K + N + ε` 产生的 RANDAO 混合来掷骰子，其中 `N` 是纪元的前瞻，`ε` 是纪元 `N + 1` 中的几个时隙。
2. 至少四个纪元的前瞻会导致以下结果：
  * 纪元 `N + 1` 的提议者集在纪元 `K` 结束时是未知的，打破了出价者与掷骰者之间的直接联系
  * 活跃验证者的数量在每个纪元结束时更新，影响下一个纪元的提议者集，从而影响应用程序用于掷骰子的 RANDAO 混合
  * 根据主网统计，在此期间网络意外错过提议的概率约为 `100%`，这降低了用于掷骰子的 RANDAO 混合的可预测性。
3. 将 `ε` 设置为一个小数字，例如 2 或 4 个时隙，给第三方一些时间来影响用于掷骰子的未来随机性。这段时间由 `MIN_SEED_LOOKAHEAD` 参数定义，在主网上约为 6 分钟。

在出价和掷骰子之间保持合理的距离，试图降低控制部分验证者的出价者直接利用其影响力的机会。最终，这种机会取决于游戏的类型和控制的验证者数量。例如，单个验证者影响一次性游戏的机会微乎其微，而在重复游戏场景中，多个验证者的机会则会增大。

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。