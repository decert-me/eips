---
eip: 3436
title: 扩展的 Clique 区块选择规则
author: Danno Ferrin (@shemnon)
discussions-to: https://ethereum-magicians.org/t/eip-3436-expanded-clique-block-choice-rule/5809
status: 停滞
type: 标准跟踪
category: 核心
created: 2021-03-25
requires: 225
---

## 简单总结

向 Clique 添加一个四步区块规则，以减少区块生产死锁

## 摘要

当前的 Clique 规范允许来自生产者的多个竞争区块，但没有提供选择区块的策略，除了当前的“最高总难度”规则。该 EIP 提出了一个四步选择规则：最高总难度、最短链、最近的轮到和最低哈希。这将防止在生产系统中发生的死锁。

## 动机

在 Goerli 多客户端 Clique 网络中发生过不止一次死锁。活跃验证者的数量超过了可用验证者的一半，因此不应该发生链停滞。停滞是通过一个不活跃的验证者重新上线来解决的。链的状态处于两种配置之一，8 个验证者可能导致链停滞。四个客户端中的三个观察到的选择序列是最低总难度，随后是首次观察到的区块。Geth 添加了一个额外的规则，优先选择最短链，然后再优先选择首次观察到的区块。这个分叉如果遵循 Geth 的规则将会自行解决，但仍然存在一种配置，链可以在最短链规则下停滞。

## 规范

当 Clique 验证者在两个不同的链头区块之间仲裁规范状态时，他们应根据以下优先级选择规范区块。

1. 选择总难度最高的区块。
2. 然后选择区块号最低的区块。
3. 然后选择最近的轮到区块分配的验证者的区块。
4. 然后选择哈希值最低的区块。

在解决规则 3 时，客户端应使用以下公式，其中 `validator_index` 是按纪元检查排序时签署区块的验证者的整数索引，`header_number` 是头部的编号，`validator_count` 是当前验证者的数量。客户端应选择值**最大的**区块。请注意，轮到区块被视为最近的轮到区块。

```
(header_number - validator_index) % validator_count
```

在解决规则 4 时，哈希应转换为无符号 256 位整数。

## 理由

基于当前的总难度然后首次观察规则，已知有两种链停滞的场景。其中一种场景也对最短链规则具有抵抗力。

对于第一种场景，考虑一个有 8 个验证者的区块，其地址按示例中的顺序排序。存在一个完全有序的链，验证者编号 8 刚刚产生了一个轮到区块，然后验证者 5、7 和 8 下线，留下验证者 1 到 6 来生成区块。形成两个分叉，一个是来自验证者 1 的有序区块，然后是来自验证者 3 的无序区块。第二个分叉由验证者 2、4 和 6 按顺序形成。两者的净总难度比共同祖先多 3。因此，在这种情况下，如果两个分叉都意识到另一个分叉，则两者被视为同样可行，且没有验证者应切换到新观察到的分叉。在这种情况下，添加最短链规则将打破死锁，因为偶数验证者将采用较短的链。

对于第二种场景，验证者集和有序链相同，验证者 7 刚刚产生了一个有序区块，然后验证者 7 和 8 下线。形成两个分叉，1、3、5 在一侧，2、4、6 在另一侧。两个分叉在生成第三个区块后意识到另一个分叉。在这种情况下，两个分叉的总难度和长度相等。因此，Geth 的规则无法打破平局，只有缺失的验证者之一的到来才能修复链。在最坏的情况下，奇数和偶数链将分别为 7 和 8 生成一个区块，链停滞将导致没有选择分叉的验证者。只有手动回滚才能解决此问题。

在制定规则时，一个考虑是区块选择应选择以鼓励最大数量的有序区块。基于最短链选择链隐含地优先选择具有更多有序区块的链。在选择竞争的无序链时，最接近未来生成有序区块的验证者应被拒绝其链，以便他们能够更早地生成有序区块。

至少观察到一个客户端在相同高度生成多个区块且难度相同，因此最低区块哈希的最终补救标准应打破任何剩余的平局。

## 向后兼容性

当前的区块选择规则是最高总难度和最高总难度加上最短链的混合。

只要大多数活跃验证者实施区块选择规则，那么仅实现现有基于难度规则的客户端最终将与这些规则所偏好的链对齐。如果少于一半的验证者实施这些规则，则仍然可能发生死锁，并依赖于问题区块的首次观察，这并不比当前情况更糟。

如果客户端仅部分实现规则，只要每个更高排名的规则也被实现，则情况不会比今天更糟。

## 安全考虑

参与网络的恶意和有动机的攻击者可以通过精心制作的区块生产迫使链停滞。通过完全确定性的选择规则，停滞的机会减少。攻击者仍然有相同的机会向网络洪水攻击多个相同高度的区块。基于最低哈希的确定性规则减少了这种洪水攻击的影响。恶意验证者可能利用这一确定性规则生成替代区块。这种攻击在当前实现中存在，但确定性哈希规则使得这种替代更可能。然而，这种攻击的影响在目前看来似乎低到微不足道。

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。