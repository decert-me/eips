---
eip: 7377
title: 迁移交易
description: 允许外部拥有账户（EOA）发送一次性交易，在其账户上部署代码。
author: lightclient (@lightclient), Sam Wilson (@samwilsn), Ansgar Dietrichs (@adietrichs)
discussions-to: https://ethereum-magicians.org/t/eip-xxxx-migration-transaction/15144
status: 草案
type: 标准跟踪
category: 核心
created: 2023-07-21
requires: 170, 1559, 2200, 2718
---

## 摘要

引入一种新的 [EIP-2718](./eip-2718.md) 交易类型，格式为 `0x04 || rlp([chainId, nonce, maxFeePerGas, maxPriorityFeePerGas, gasLimit, codeAddr, storage, data, value, accessList, yParity, r, s])`，该格式将发送账户的 `code` 字段设置为 `codeAddr` 处的 `code` 值，并将存储元组应用于发送者的存储树。

## 动机

智能合约钱包长期以来被视为解决以太坊用户体验问题的方案。早在 2015 年，就有提案允许智能合约发起交易，希望新用户能够涌向智能合约钱包以存储他们的资产。到目前为止，只有一小部分用户选择这样做。

如今，账户抽象仍然是以太坊的重要目标，许多努力正在尝试实现它。我们离成功越来越近，但不幸的是，多年的失败使许多用户仅依赖于 EOA。

在用户的 EOA 中积累了足够的资产后，将每个单独的资产迁移到新地址是不可行的。这既是由于成本问题，也因为需要手动签署和验证可能数百个交易。

这是一个被忽视的问题。有效地将*现有*用户转换为智能合约钱包将加速采用，并推动对智能合约钱包的更好支持和集成。它们将不再被视为小众用例。

因此，我们必须提供一种机制，嵌入在协议中，以将 EOA 迁移到智能合约。这项 EIP 提出了这样的机制。

## 规范

在分叉区块 `X` 中，引入迁移交易类型。

### 迁移交易

#### 定义

| 字段                    | 类型       |
|------------------------|-----------|
| `chainId`              | `uint256` |
| `nonce`                | `uint64`  |
| `maxFeePerGas`         | `uint256` |
| `maxPriorityFeePerGas` | `uint256` |
| `gasLimit`             | `uint64`  |
| `codeAddr`             | `address` |
| `storage`              | `List[Tuple[uint256, uint256]]` |
| `data`                 | `bytes`   |
| `value`                | `uint256` |
| `accessList`           | `List[Tuple[address, List[uint256]]]` |
| `yParity`              | `uint8`   |
| `r`                    | `uint256` |
| `s`                    | `uint256` |

EIP-2718 的 `TransactionType` 为 `0x04`，`TransactionPayload` 为 `rlp([chainId, nonce, maxFeePerGas, maxPriorityFeePerGas, gasLimit, codeAddr, storage, data, value, accessList, yParity, r, s])`。

交易的签名哈希为 `keccak256(0x04 || rlp([chainId, nonce, maxFeePerGas, maxPriorityFeePerGas, gasLimit, codeAddr, storage, data, value, accessList])`

#### 验证

如果满足以下属性，则迁移交易被视为有效：

* 所有 [EIP-1559](./eip-1559.md) 属性，除非另有说明
* `codeAddr` 处的代码小于 [EIP-170](./eip-170.md) 限制的 `24576`
* `codeAddr` 处的代码大小不得为 `0`

内在 gas 计算从 [EIP-1559](./eip-1559.md) 修改为 `21000 + 16 * 非零 calldata 字节 + 4 * 零 calldata 字节 + 1900 * 访问列表存储键计数 + 2400 * 访问列表地址计数 + 20000 * 存储长度`。

#### 处理

执行迁移交易分为两个部分。

##### 合约部署

与标准合约部署不同，迁移交易直接指定发送者账户应设置的 `code` 值。

作为处理交易的第一步，将发送者的 `code` 设置为 `state[tx.codeAddr].code`。接下来，对于 `tx.storage` 中的每个元组和发送者的存储树，设置 `storage[t.first] = t.second`。

##### 交易执行

现在使用与 [EIP-1559](./eip-1559.md) 相同的规则实例化对发送者账户的 EVM 调用，并将交易的来源设置为 `keccak256(sender)[0..20]`。

## 理由

### 无 `to` 地址字段

此交易仅适用于一次性使用，以将 EOA 迁移到智能合约。它旨在在部署后立即调用部署的合约，该合约位于发送者的地址，以允许发送者进行任何进一步的处理。

### 部署的代码指针

简单地说，可以设计迁移交易使其具有类型为 `bytes` 的 `code` 字段。然而，由于许多用户希望部署完全相同的内容（通常是钱包），因此会有大量的代码 calldata 重复。使用指针而不是代码承认了这一压倒性的用例，并将其作为一种优化。

### 更便宜的存储

由于存储被保证为空，因此无需在写入之前读取。这意味着只需 20,000 gas 来支付 [EIP-2200](./eip-2200.md) 的 `SSTORE_SET_GAS` 值。这是对正常成本 `22,100` 的小折扣，后者是 `SSTORE_SET_GAS` 加上 [EIP-2929](./eip-2929.md) 的 `COLD_SLOAD_COST` 的 `2100`，因为没有加载发生。

### 内在不考虑合约部署

这利用了客户端倾向于存储单个唯一代码副本的事实；无论部署次数多少。因此，这里唯一的操作是将状态树中的指针更改为所需的代码。

此外，EOA 已经存在，因为它有足够的余额使迁移交易被视为有效。因此，我们不需要为将新账户添加到状态树而支付额外费用。

### 操纵交易来源

许多应用程序有安全检查 `caller == origin` 来验证调用者是 EOA。这是为了“保护”资产。虽然这通常更多的是一种权宜之计而不是实际的修复，但我们试图通过修改交易的来源来安抚这些项目，以便检查将继续履行其职责。

### 一次性迁移

没有技术原因我们不能允许 EOA 随时使用此交易类型更改其代码。目前唯一的抑制因素是 [EIP-3607](./eip-3607.md)，这将导致来自已部署代码的账户的迁移交易被视为无效。然而，保留这种行为的一个功能原因是，它使得推理合约及其可升级性变得更简单。

## 向后兼容性

未发现向后兼容性问题。

## 安全考虑

### 盲签名

与所有足够复杂的账户设计一样，如果用户被说服签署任意消息，该消息可能是由恶意行为者拥有的迁移交易，而不是用户。这通常可以避免，如果钱包对这些交易给予*极大的*关注，并在完成签名之前尽可能多地创建摩擦和验证。

### 关于 `ecrecover`

应用程序标准如 [ERC-2612: Permit Extension](./eip-2612.md) 利用了 EOA 地址与其私钥之间的加密关系。许多代币今天支持此扩展，允许 EOA 仅使用签名批准从其账户转移资金。尽管考虑到今天的计算能力，EOA 和合约账户之间的碰撞被认为不太可能且[可能不可能](./eip-3607.md) ，但此 EIP 将使合约账户的私钥存在变得普遍。这里有一些关于安全性的考虑：
* 明显的攻击是一个 DeFi 协议使用这个 EIP 部署他们的一些合约，然后签署一个 [ERC-2612](./eip-2612.md) 消息以窃取合约中累积的资金。这可以通过钱包简单地不允许用户与以这种方式部署的协议进行交互来避免。
* 还值得一提的是，人们对这个 EIP 将如何影响跨链体验存在担忧。最终，用户的私钥可能仍然对账户的资产有一定的控制，具体取决于在以太坊和其他链上使用的确切协议。实际上，不可能在所有链上同时完美迁移 EOA。最好的办法是教育用户，仅仅因为他们的账户已经迁移，并不意味着他们可以安全地公开透露他们的私钥。这似乎是一个合理的请求，特别是因为他们希望保留私钥，以防他们想在任何其他 EVM 类链上使用该地址。

可能在一定程度上缓解这些问题的方法是在 `ecrecover` 中添加一个 `EXTCODEHASH` 检查。如果恢复的账户有代码，则预编译将回退。这将不允许迁移的 EOA 使用像 [ERC-2612](./eip-2612.md) 这样的标准。

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。