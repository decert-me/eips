---
eip: 758
title: 完成交易的订阅和过滤器
author: Jack Peterson <jack@tinybike.net>
type: Standards Track
category: Interface
status: Stagnant
created: 2017-11-09
requires: 1474
---

## 简单总结
提供一种方式，让外部调用者能够被通知已完成的交易，并访问在交易被挖掘时执行的函数的返回数据。

## 摘要
当新的交易成功提交到以太坊节点时，节点会返回交易的哈希。如果该交易涉及执行一个返回数据的合约函数，则数据会被丢弃。如果返回数据依赖于状态，这种情况很常见，调用者没有简单的方法来访问或计算返回数据。该 EIP 提议调用者应该能够订阅（或轮询）已完成的交易。当交易被封存时，以太坊节点会将返回数据发送给调用者。

## 动机
目前，外部调用者无法访问以太坊的返回数据，如果函数是通过`eth_sendTransaction`或`eth_sendRawTransaction` RPC 请求执行的。访问函数返回数据在许多情况下是一个可取的特性。使返回数据对外部调用者可用也解决了内部调用者（在交易上下文中可以访问返回数据）与外部调用者（无法访问返回数据）之间的不一致。目前，一个常见的解决方法是记录返回数据，这在多个方面都是不好的：它会导致链膨胀，给调用者带来额外的 gas 成本，并且如果外部调用的函数涉及其他（内部）函数调用并记录它们的返回数据，可能会导致未使用的日志被写入。在实现该 EIP 的原始版本时，决定稍微扩展此功能，以允许外部调用者在没有*返回数据*的情况下被通知其已完成的交易。这可能是因为调用的方法不返回值，或者因为交易是简单的价值转移。

## 规范

### 订阅
希望在交易完成时被通知的调用者发送一个`eth_subscribe` RPC 请求，首个参数为`"completedTransaction"`：

```json
{"jsonrpc": "2.0", "id": 1, "method": "eth_subscribe", "params": ["completedTransaction", filter]}
```

`filter`参数是一个字典，包含 3 个可选的命名参数：`from`、`to`和`hasReturnData`。`from`和`to`可以是单个地址或地址列表。它们用于过滤掉未从`from`列表中的地址发送或未发送到`to`列表中的地址的交易。`hasReturnData`是一个布尔值——如果指定且为`true`，则仅会收到包含返回数据的已完成交易的通知。

例如，要限制结果为来自两个地址之一的合约创建（0x3f7d39bDBf1f5cE649c194571aEd3D2BbB2F85ce 或 0x7097f41F1C1847D52407C629d0E0ae0fDD24fd58）：

```json
filter = { "from" : ["0x3f7d39bDBf1f5cE649c194571aEd3D2BbB2F85ce",
                      "0x7097f41F1C1847D52407C629d0E0ae0fDD24fd58"],
           "to" : "0x0" 
         }
```

要限制结果为对合约地址 0xD9Cb531aB97A652c8fC60dcF6D263fcA2F5764e9 的函数调用：
```json
filter = { "to" : "0xD9Cb531aB97A652c8fC60dcF6D263fcA2F5764e9", "hasReturnData" : true }
```
或者在没有进一步限制的情况下被通知此 RPC 客户端提交的任何交易完成：
```json
filter = {}
```

在请求被接收后，以太坊节点会返回一个订阅 ID：

```json
{"jsonrpc": "2.0", "id": 1, "result": "0x00000000000000000000000000000b0b"}
```

假设调用者随后通过`eth_sendTransaction`或`eth_sendRawTransaction` RPC 请求提交了一个交易，其交易哈希为`"0x00000000000000000000000000000000000000000000000000000000deadbeef"`。当交易被封存（挖掘）时，以太坊节点会向调用者推送通知。如果交易是对合约的函数调用，这将包括被调用函数的返回值（例如`"0x000000000000000000000000000000000000000000000000000000000000002a"`）：

```json
{
  "jsonrpc": "2.0",
  "method": "eth_subscription",
  "params": {
    "result": {
      "transactionHash": "0x00000000000000000000000000000000000000000000000000000000deadbeef",
      "returnData": "0x000000000000000000000000000000000000000000000000000000000000002a"
    },
    "subscription": "0x00000000000000000000000000000b0b"
  }
}
```

调用者在两种情况下接收关于其交易的通知：第一次是当交易被封存时，第二次（带有额外的`"removed": true`字段）是如果交易受到链重组的影响。通知会发送给所有从客户端提交的在订阅后被封存的交易。如果指定了`from`、`to`或`hasReturnData`，则仅匹配过滤条件的交易会生成通知。与其他订阅一样，调用者可以发送`eth_unsubscribe` RPC 请求以停止接收推送通知：

```json
{"jsonrpc": "2.0", "id": 2, "method": "eth_unsubscribe", "params": ["0x00000000000000000000000000000b0b"]}
```

### 轮询
推送通知需要全双工连接（即，WebSocket 或 IPC）。而不是订阅，使用 HTTP 的调用者发送`eth_newCompletedTransactionFilter`请求：

```json
{"jsonrpc": "2.0", "id": 1, "method": "eth_newCompletedTransactionFilter", "params": [filter] }
```

以太坊节点会返回一个过滤器 ID：

```json
{"jsonrpc": "2.0", "id": 1, "result": "0x1"}
```

当交易被提交时，以太坊节点会将交易通知（包括返回值）推送到一个队列中，该队列在调用者使用`eth_getFilterChanges`轮询时被清空：

```json
{"jsonrpc": "2.0", "id": 2, "method": "eth_getFilterChanges", "params": ["0x1"]}
```

节点会以计算顺序返回一个交易哈希及其对应的返回数据数组：

```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "result": [{
    "transactionHash": "0x00000000000000000000000000000000000000000000000000000000deadbeef",
    "returnData": "0x000000000000000000000000000000000000000000000000000000000000002a"
  }]
}
```

所有在初始`eth_newCompletedTransactionFilter`请求后被封存的交易都包含在此数组中。同样，如果`filter`参数是一个非空字典（包含`from`、`to`或`hasReturnData`），则仅匹配过滤条件的交易会生成通知。请注意，在轮询情况下，以太坊节点无法确保提交交易的 RPC 客户端与创建过滤器的客户端是相同的，因此没有基于交易提交位置的限制。

## 理由
[EIP-658](./eip-658.md)最初提议将返回数据添加到交易收据中。然而，返回数据不收费（因为它不存储在区块链上），因此将其添加到交易收据中可能会导致拒绝服务和垃圾邮件机会。相反，交易收据中添加了一个简单的布尔`status`字段。这个修改版本的 EIP 658 被包含在拜占庭硬分叉中。虽然`status`字段是有用的，但应用程序通常也需要返回数据。

这里所述策略的主要优点是效率：不需要在区块链上存储额外数据，并且对节点施加的额外计算负担最小。尽管不支持事后查找返回值，但这与返回数据的常规使用是一致的，返回数据仅在函数返回时对调用者可访问，并且不会被存储以供后用。

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。