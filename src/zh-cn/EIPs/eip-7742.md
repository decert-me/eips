---
eip: 7742
title: 解耦 CL 和 EL 之间的 blob 计数
description: 让 CL 验证 blob 最大值，并让 EL 从 CL 获取目标值
author: Alex Stokes (@ralexstokes)
discussions-to: https://ethereum-magicians.org/t/eip-7742-uncouple-blob-count-between-cl-and-el/20550
status: Review
type: Standards Track
category: Core
created: 2024-07-12
requires: 4844
---

## 摘要

更新来自 [EIP-4844](./eip-4844.md) 的 blob 最大值和目标验证。

执行层不再验证 blob 最大值，并从共识层动态接收目标值。

## 动机

根据 EIP-4844，执行层 (EL) 维护一个硬编码的 blob 目标值和 blob 最大值。考虑到 EL 和共识层 (CL) 节点软件之间的关系，blob 最大值的验证是多余的，因此可以完全移除，而不会改变安全性。blob 最大值仍然在通过引擎 API 进行区块构建时提供。
该 EIP 还改变了 EL 获取当前 blob 目标值的方式，原因有二：

1) 获得对该值的更多灵活性，而不是 EIP-4844 中静态的 `TARGET == MAX // 2` 关系。

2) 在希望更改 blob 目标值的情况下，解耦 CL 和 EL 层的开发和部署。

### 背景

通过 EIP-4844 引入的数据设施向以太坊区块添加了 blob，这些 blob 只是可以包含在规范链中的固定数据集，但没有执行语义（参见以太坊交易中的 `calldata`）。

该协议规定每个区块允许的最大 blob 数量，以防止通过滥用该数据设施造成的 DoS 向量。
该协议还维护一个类似于 [EIP-1559](./eip-1559.md) 的“目标”值，用于表示每单位时间内预期的 blob 吞吐量的运行平均值。blob 使用情况与该目标进行比较，以影响“blob 基础费用”，以管理该资源的分配给以太坊协议的用户。

在 EIP-4844 之后，这两个值目前在 EL 中是硬编码的，而 blob 最大值在 EIP-4844 之后在 CL 中是单独硬编码的。该 EIP 提出了一系列更改，以解耦 CL 和 EL 之间的这些值，从而使对 blob 计数的更改的开发和部署更容易。

#### 每个区块的最大 blob 数量

blob 最大值在 CL 节点中进行验证，EL 在根据引擎 API 指定的每个 blob 的版本哈希进行一致性检查时继承此验证。因此，EIP-4844 中规定的严格检查是没有必要的。

#### 每个区块的目标 blob 数量

目标目前被指定为与 blob 数量相关的固定值。以太坊社区打算在其扩展策略中增加 blob 参数，并且能够在与 blob 最大值相关的目标值上具有更大的灵活性是希望减少该协议参数的僵化。

即使 EL 保持基于最大值的固定目标值，移除最大值意味着 EL 将不知道目标值应该是什么。为了解决这一信息缺失，该 EIP 提议 CL 在通过引擎 API 提供每个有效负载时将当前目标值发送给 EL。EL 区块头还需要扩展此目标值，以保持乐观同步的安全性。

## 规范

### 区块结构和有效性

在激活该 EIP 后，执行客户端 **必须** 用一个额外的 64 位字段扩展头部架构：`target_blob_count`。该值设置为当前目标 blob 数量。引擎 API 随着该 EIP 进行修改，以便在每个有效负载中提供 `target_blob_count`，实现可以使用该值正确设置区块头字段。

`target_blob_count` 的有效性由共识层保证，类似于如何处理提款。

在验证区块时，执行客户端 **必须** 确保区块头中的目标 blob 数量与共识客户端提供的数量匹配。

对于没有现有父级的创世区块，该值应根据该创世区块的协议规则集所达成的目标 blob 数量的约定规范进行设置。

### 区块处理

在激活该 EIP 后（即在处理任何交易之前），可以跳过 EIP-4844 中给出的 blob 最大值的验证。具体而言，这意味着与 EIP-4844 中给出的 `MAX_BLOB_GAS_PER_BLOCK` 相关的任何逻辑都可以被弃用。
此外，EIP-4844 中的任何对 `TARGET_BLOB_GAS_PER_BLOCK` 的引用都可以通过从 CL 获取 `target_blob_count` 并乘以 EIP-4844 中给出的 `GAS_PER_BLOB` 来推导。

否则，EIP-4844 的规范没有改变。例如，blob 基础费用会计和超额 blob gas 跟踪以完全相同的方式进行。

### 区块构建

引擎 API 被扩展，以便在 CL 请求 EL 构建提案有效负载时提供 `target_blob_count` 和 `maximum_blob_count`。

这些值应被用来确保在任何构建的有效负载中包含正确数量的 blob，并确保 blob 基础费用会计被正确计算。

## 理由

### 为什么不让 CL 也计算 blob 基础费用，并从 EL 处理移除任何 blob 计数的概念？

将完整的计算提升到 CL 是可能的，但这确实违反了协议栈这两层之间的关注点分离。CL 维护一个最大值以应对例如 DoS 风险，而 EL 维护目标值的知识以应对费用会计。
将目标计算放在 CL 中违反了每一层的各自责任。

## 向后兼容性

没有问题。

## 测试用例

N/A

## 参考实现

N/A

## 安全考虑

N/A

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。