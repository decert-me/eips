---
eip: 3403
title: 部分移除退款
author: Vitalik Buterin (@vbuterin), Martin Swende (@holiman)
discussions-to: https://ethereum-magicians.org/t/eip-3298-removal-of-refunds/5430
status: Stagnant
type: Standards Track
category: Core
created: 2021-03-16
---

## 简单总结

移除 SELFDESTRUCT 的 gas 退款，并将 SSTORE 的 gas 退款限制为一个特定情况。

## 动机

SSTORE 和 SELFDESTRUCT 的 gas 退款最初是为了激励应用开发者编写“良好状态卫生”的应用程序，清理不再需要的存储槽和合约。然而，它们并未广泛用于此，糟糕的状态卫生仍然是常态。现在普遍接受的观点是，状态增长的唯一解决方案是某种形式的无状态或状态过期，如果实施了这样的解决方案，则不再使用的存储槽和合约将自动被忽略。

gas 退款还带来了多种有害后果：

* 退款导致了 GasToken 的产生。GasToken 在将 gas 空间从低费用时期转移到高费用时期方面有好处，但它也对网络产生了负面影响，特别是在加剧状态大小方面（因为状态槽实际上被用作“电池”来储存 gas）以及低效地堵塞区块链的 gas 使用
* 退款增加了区块大小的方差。区块中实际消耗的 gas 的理论最大值几乎是纸面上 gas 限制的两倍（因为退款为区块中的后续交易增加了 gas 空间，尽管退款被限制为交易使用 gas 的 50%）。这并不是致命的，但仍然不理想，特别是考虑到退款可以用于维持 2 倍的使用峰值，远远超过 EIP 1559 的能力。

### 互斥锁用例

实现互斥锁有两种典型方式：'0-1-0' 和 '1-2-1'。让我们看看它们的区别

- '0-1-0':
  - Istanbul: 1612
  - Berlin: 212
  - NoRefund: 20112
  - EIP-3403: 1112
- '1-2-1':
  - Istanbul: 1612
  - Berlin: 212
  - NoRefund: 3012
  - EIP-3403: 3012


**注意**：实际上，gas 成本从来不会是负数，因为退款被限制为 0.5 * gasUsed。
然而，这些表格显示了负值，因为更现实的场景可能会将额外的 gas 用于其他操作。

## 规范

### 参数

| 常量 | 值 |
| - | - |
| `FORK_BLOCK` | 待定 |
| `SSTORE_REFUND_GAS` | 19000 |

对于 `block.number >= FORK_BLOCK` 的区块，适用以下更改。

1. 移除 `SELFDESTRUCT` 退款。
2. 移除 `SSTORE` 退款，除了一个特定情况：如果存储槽的 _新值_ 和 _原始值_ 都等于 0，但 _当前值_ 不等于 0（这些术语的定义如 [EIP-1283](https://eips.ethereum.org/EIPS/eip-1283) 中所述），则退款 `SSTORE_REFUND_GAS` gas。

## 理由

在 `new = original = 0 != current` 的情况下保留退款，确保一些关键用例继续获得有利的 gas 成本待遇，特别是：

* 防重入锁（通常在子调用开始前从 0 翻转到 1，然后在子调用结束时翻转回 0）
* ERC20 授权和发送（“授权值”在代币转移被批准时从零变为非零，然后在代币转移处理时再次变为零）

这也保留了 EIP 3298 的两个关键目标：

1. gas 代币继续不可行，因为每个 19000 的退款仅可能是因为在同一交易中将该存储槽从零翻转为非零时支付了 19000 的额外 gas，因此你不能清除一些存储槽并使用节省的 gas 来填充其他槽。
2. 执行中 _花费的总 gas_ 被限制在 gas 限制内。每个将存储槽从零翻转为非零的 19000 退款仅可能是因为在同一交易中将该槽从零翻转为非零时支付了 19000 的额外 gas；该 gas 用于存储写入和扩展，这两者都被回滚，因此实际上不需要应用于默克尔树。因此，这部分额外的 gas 不会增加风险。

## 向后兼容性

退款目前仅在交易执行 _后_ 应用，因此它们不会影响在执行期间任何特定调用帧可用的 gas 量。因此，移除它们不会破坏任何代码的执行能力，尽管这会使某些应用在经济上变得不可行。

gas 代币特别会变得毫无价值。DeFi 套利机器人，今天经常使用既定的 gas 代币方案或自定义替代方案来降低链上成本，将受益于重写其代码以移除对这些不再有效的 gas 存储机制的调用。

## 测试用例

### 2929 gas 成本

注意，“热”槽和“冷”槽之间存在差异。此表显示了根据 [EIP-2929](./eip-2929.md) 的值，假设所有触及的存储槽已经是“热”的（差异为一次性成本 `2100` gas）。

| 代码 | 使用的 gas | 退款 | 原始 | 1st | 2nd | 3rd | 有效 gas（退款后）
| -- | -- | -- | -- | -- | -- | -- | -- | 
| `0x60006000556000600055` | 212 | 0| 0 | 0 |  0 |  |  212 |
| `0x60006000556001600055` | 20112 | 0| 0 | 0 |  1 |  |  20112 |
| `0x60016000556000600055` | 20112 | 19900| 0 | 1 |  0 |  |  212 |
| `0x60016000556002600055` | 20112 | 0| 0 | 1 |  2 |  |  20112 |
| `0x60016000556001600055` | 20112 | 0| 0 | 1 |  1 |  |  20112 |
| `0x60006000556000600055` | 3012 | 15000| 1 | 0 |  0 |  |  -11988 |
| `0x60006000556001600055` | 3012 | 2800| 1 | 0 |  1 |  |  212 |
| `0x60006000556002600055` | 3012 | 0| 1 | 0 |  2 |  |  3012 |
| `0x60026000556000600055` | 3012 | 15000| 1 | 2 |  0 |  |  -11988 |
| `0x60026000556003600055` | 3012 | 0| 1 | 2 |  3 |  |  3012 |
| `0x60026000556001600055` | 3012 | 2800| 1 | 2 |  1 |  |  212 |
| `0x60026000556002600055` | 3012 | 0| 1 | 2 |  2 |  |  3012 |
| `0x60016000556000600055` | 3012 | 15000| 1 | 1 |  0 |  |  -11988 |
| `0x60016000556002600055` | 3012 | 0| 1 | 1 |  2 |  |  3012 |
| `0x60016000556001600055` | 212 | 0| 1 | 1 |  1 |  |  212 |
| `0x600160005560006000556001600055` | 40118 | 19900| 0 | 1 |  0 |  1 |  20218 |
| `0x600060005560016000556000600055` | 5918 | 17800| 1 | 0 |  1 |  0 |  -11882 |

### 使用 EIP-3403 部分退款

如果退款被部分移除，如 [这里](https://github.com/ethereum/EIPs/pull/3403/) 所述，这将是比较表。**此表还假设触及的存储槽已经是“热”的**。

| 代码 | 使用的 gas | 退款 | 原始 | 1st | 2nd | 3rd | 有效 gas（退款后）
| -- | -- | -- | -- | -- | -- | -- | -- | 
| `0x60006000556000600055` | 212 | 0| 0 | 0 |  0 |  |  212 |
| `0x60006000556001600055` | 20112 | 0| 0 | 0 |  1 |  |  20112 |
| `0x60016000556000600055` | 20112 | 19000| 0 | 1 |  0 |  |  1112 |
| `0x60016000556002600055` | 20112 | 0| 0 | 1 |  2 |  |  20112 |
| `0x60016000556001600055` | 20112 | 0| 0 | 1 |  1 |  |  20112 |
| `0x60006000556000600055` | 3012 | 0| 1 | 0 |  0 |  |  3012 |
| `0x60006000556001600055` | 3012 | 0| 1 | 0 |  1 |  |  3012 |
| `0x60006000556002600055` | 3012 | 0| 1 | 0 |  2 |  |  3012 |
| `0x60026000556000600055` | 3012 | 0| 1 | 2 |  0 |  |  3012 |
| `0x60026000556003600055` | 3012 | 0| 1 | 2 |  3 |  |  3012 |
| `0x60026000556001600055` | 3012 | 0| 1 | 2 |  1 |  |  3012 |
| `0x60026000556002600055` | 3012 | 0| 1 | 2 |  2 |  |  3012 |
| `0x60016000556000600055` | 3012 | 0| 1 | 1 |  0 |  |  3012 |
| `0x60016000556002600055` | 3012 | 0| 1 | 1 |  2 |  |  3012 |
| `0x60016000556001600055` | 212 | 0| 1 | 1 |  1 |  |  212 |
| `0x600160005560006000556001600055` | 40118 | 19000| 0 | 1 |  0 |  1 |  21118 |
| `0x600060005560016000556000600055` | 5918 | 0| 1 | 0 |  1 |  0 |  5918 |
## 安全考虑

退款在交易执行中不可见，因此这不应对交易执行逻辑产生任何影响。

在一个区块中，执行所能消耗的最大 gas 量受到 gas 限制的限制，如果不计算那些后来重置回零的零到非零 SSTORE。 不计算这些是可以的，因为如果这样的 SSTORE 被重置，存储不会扩展，客户端也不需要实际调整默克尔树；gas 消耗会被退款，但客户端通常处理这些操作码所需的努力也会被取消。 **客户端应确保在 `new_value = original_value` 时不进行存储写入；自以太坊开始以来，这一直是一个明智的优化，但现在变得更加重要。**

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。