---
eip: 2364
title: "eth/64: forkid-扩展协议握手"
description: 引入在与对等节点握手时对 `forkid` 的验证。
author: Péter Szilágyi <peterke@gmail.com>, Péter Szilágyi (@karalabe), Tim Beiko (@timbeiko)
discussions-to: https://github.com/ethereum/EIPs/issues/2365
status: Final
type: Standards Track
category: Networking
created: 2019-11-08
requires: 2124
---

## 摘要

本 EIP 指定将 `forkid`（最初在 [(EIP-2124)](./eip-2124.md) 中定义）作为以太坊网络协议（`eth`）握手中的新字段进行包含。此更改作为网络协议的新版本 `eth/64` 实施。

## 动机

[`forkid` (EIP-2124)](./eip-2124.md) 的设计目的是允许两个以太坊节点快速且廉价地决定它们是否兼容，不仅在创世/网络层面上，而且从当前通过的网络更新（即分叉）的角度来看。

[EIP-2124](./eip-2124.md) 仅定义了 `forkid` 的计算和验证方式，但未指定 `forkid` 应如何在对等节点之间交换。本 EIP 指定将 `forkid` 作为以太坊网络协议（`eth`）握手中的新字段进行包含（发布新版本 `eth/64`）。

通过在握手期间交叉验证 `forkid`，不兼容的节点可以在进行昂贵的区块交换和验证（PoW 检查、EVM 执行、状态重建）之前断开连接。这进一步防止了不兼容但尚未被检测到的节点占用对等插槽。

从微观角度来看，切断不兼容节点之间的连接确保节点仅将资源用于对其真正有用的任务。我们越早决定远程对等节点是无用的，就越能减少无谓的时间和处理消耗。

从宏观角度来看，保持不兼容节点之间的隔离确保不相交的集群为维护自己的链保留更多资源，从而提高全球所有网络的服务质量。

## 规范

- 根据 [EIP-2124](./eip-2124.md) 实现 `forkid` 的生成和验证。
- 在 `eth/64` 处宣传新的 `eth` 协议能力（版本）。
  - 旧的 `eth/63` 协议应继续并行保留，直到 `eth/64` 被实现者充分采用。
- 重新定义 `eth/64` 的 `Status (0x00)`，以添加一个尾随的 `forkid` 字段：
  - 旧数据包: `[protocolVersion, networkId, td, bestHash, genesisHash]`
  - 新数据包: `[protocolVersion, networkId, td, bestHash, genesisHash, forkid]`，
  其中 `forkid` 为 `[forkHash: [4]byte, forkNext: uint64]`（字段根据 [EIP-2124](./eip-2124.md)）。

每当两个对等节点使用 `eth/64` 协议连接时，必须将更新的 `Status` 消息作为协议握手发送，并且每个对等节点必须验证远程 `forkid`，在检测到不兼容时断开连接。

## 理由

该规范很小，因为大部分内容已经在 EIP-2124 中指定。`eth/63` 并未作为 EIP 指定，但在 [ethereum/devp2p](https://github.com/ethereum/devp2p) GitHub 仓库中维护。

### EIP-2124 提到在发现协议中宣传 `forkid`。这与在 `eth` 协议中宣传有什么比较？为什么需要冗余？

在发现协议中宣传和验证 `forkid` 是一种更优的解决方案，因为它可以帮助避免建立 TCP 连接和加密 RLPx 流的成本，只有在 `eth/64` 拒绝时才会被拆除。

然而，与 `eth` 协议相比，发现有点模糊。其目标是建议潜在的对等节点，而不是万无一失。信息可能过时，节点可能已更改或消失。发现可以进行粗略过滤，但之后仍然需要更精确的处理。

此外，通过发现协议进行 `forkid` 验证需要 ENR 实现（[EIP-778](./eip-778.md)）和 ENR 扩展支持（[EIP-868](./eip-868.md)），而这在以太坊网络中并未强制要求。最后，发现协议只是找到对等节点的一种方式，但无法使用 UDP 或依赖其他机制（例如 DNS 发现）的系统仍然需要一种过滤连接的方法。

### `forkid` 隐含地包含了在 `FORK_HASH` 字段中校验和的创世哈希。为什么这个提案不从 `eth` 握手中移除 `genesisHash` 字段？

最初本 EIP 确实将其移除，作为冗余数据，因为基于 `forkid` 的过滤是基于创世哈希的过滤的超集。撤回该决定的原因是创世哈希可能对其他事情也有用，而不仅仅是连接过滤（网络爬虫目前使用它来在网络之间划分节点）。

尽管 `forkid` 希望接管当前使用的创世哈希的所有角色，但没有理由过于激进地去重数据。现在保留两者并行是可以的，并在未来版本中移除，当第三方基础设施切换过来时。

## 向后兼容性

本 EIP 以向后不兼容的方式扩展了 `eth` 协议握手，并需要推出新版本 `eth/64`。然而，`devp2p` 支持并行运行同一网络协议的多个版本，因此推出 `eth/64` 不需要客户端协调，因为未更新的客户端可以继续使用 `eth/63`。

本 EIP 不改变共识引擎，因此不需要硬分叉。

## 测试用例

有关计算和验证 fork ID 的测试用例，请参见 [EIP-2124](./eip-2124.md) 中的测试用例。

## 安全考虑

无。

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。