---
eip: 2982
title: Serenity Phase 0
description: Serenity 的第 0 阶段，这是对以太坊可扩展的权益证明共识的一系列更新的发布计划
author: Danny Ryan (@djrtwo), Vitalik Buterin (@vbuterin)
discussions-to: https://ethereum-magicians.org/t/serenity-phase-0-eip/4621
status: Final
type: Informational
created: 2020-09-15
---

## 摘要

本 EIP 指定了 Serenity (eth2) 的第 0 阶段，这是对以太坊主网共识机制的多阶段升级。在第 0 阶段，现有的 PoW 链和机制完全不受影响，同时并行构建一个 PoS 链——信标链——作为升级共识的核心。在后续阶段，信标链将增强以支持和保护多个并行分片链的共识，最终将当前的以太坊主网纳入这些分片之一。

信标链的核心是一个名为 Casper the Friendly Finality Gadget (FFG) 的权益证明共识机制和一个名为 Latest Message Driven Greedy Heaviest Observed Sub-Tree (LMD-GHOST) 的选择规则。第 0 阶段主要围绕执行这些算法的验证者的机制和激励。eth2 的详细规范包含在与本 EIP 独立的代码库中，安全性和活跃性证明可以在 [Combining GHOST and Casper](../assets/eip-2982/arxiv-2003.03052-Combining-GHOST-and-Casper.pdf) 论文中找到。为避免重复，本 EIP 仅引用相关的规范文件和发布。

eth2 的早期阶段在当前以太坊主网上执行时没有任何破坏性的共识变化。本 EIP 旨在记录这一共识机制的引导，并指出 eth2 取代以太坊当前的工作量证明 (PoW) 共识的路径。

## 动机

Eth2 旨在实现以太坊的原始愿景，支持一个高效的、全球规模的、通用的交易平台，同时保持高的加密经济安全性和去中心化。

如今，由于对去中心化应用程序的需求不断增加，以太坊区块始终处于满负荷状态。自 2017 年首次出现严重的采用高峰（cryptokitties）以来，以太坊社区一直在持续而明确地要求扩展解决方案。

自以太坊的第 0 天起，扩展解决方案的调查和期望就有两个方面——从 Layer 1 升级和 Layer 2 采用进行扩展。本 EIP 代表了前者多阶段推出的开始。

### 通过分片进行扩展

随着以太坊网络及其上构建的应用在过去 5 年中使用量的增加，区块经常满载，gas 价格市场持续攀升。简单地增加当前以太坊链的区块 gas 限制无法满足系统需求的增加，而不会对消费者节点施加不可持续的高资源负担（以带宽、计算和磁盘资源的形式）。为了在扩展以太坊网络的同时保持去中心化，必须采取另一条路径。

为了为以太坊提供更多的扩展，同时不对消费者和共识节点施加过高的负担，eth2 引入了一种“分片”解决方案，其中多个区块链分片——每个分片的容量与当前以太坊主网相似——在统一的共识机制下并行运行。核心共识（信标链）和少量这些分片可以通过单个消费者机器进行处理，而系统的总和提供了更高的容量。

### 通过权益证明实现去中心化和经济最终性

自以太坊早期以来，权益证明一直是一个期待已久的愿望，原因如下：
* 通过降低参与的门槛和技术要求，增加核心共识的去中心化
* 通过对不当行为的协议内惩罚和经济最终性的增加，提高加密经济安全性
* 消除当前 PoW 共识机制的高能耗挖矿

除了上述原因，PoS 与分片扩展解决方案具有协同效应。由于分片的随机抽样要求，PoS 提供了比 PoW 更简单和直接的“活跃验证者集”的访问，从而允许更直接的分片协议构建。

## 规范

第 0 阶段设计为对现有以太坊主网“无破坏性共识变化”。相反，这是引导一个新的 PoS 共识，一旦稳定，可以取代当前的 PoW 共识。

第 0 阶段的规范保存在与本 EIP 独立的代码库中。`SPEC_RELEASE_VERSION` 版本的规范在 `SPEC_RELEASE_COMMIT` 被视为本 EIP 的权威第 0 阶段规范。

本 EIP 提供了第 0 阶段机制的高层次视图，特别是与以太坊主网（例如存款合约）和用户（例如验证者机制和 eth2 发行）相关的机制。扩展和低层次的细节保留在 `consensus-specs` 代码库中。

### 参数

| 参数 | 值 |
| - | - |
| `SPEC_RELEASE_VERSION` | `v1.0.0` |
| `SPEC_RELEASE_COMMIT` | `579da6d2dc734b269dbf67aa1004b54bb9449784` |
| `DEPOSIT_CONTRACT_ADDRESS` | `0x00000000219ab540356cBB839Cbe05303d7705Fa` |
| `MIN_GENESIS_TIME` | `1606824000` |
| `BASE_REWARD_FACTOR` | `2**6` (64) |
| `INACTIVITY_PENALTY_QUOTIENT` | `2**26` (67,108,864) |
| `PROPORTIONAL_SLASHING_MULTIPLIER` | `1` |
| `MIN_SLASHING_PENALTY_QUOTIENT` | `2**7` (128) |

*注意：* Eth2 还有许多其他第 0 阶段配置参数，但大多数在本 EIP 中省略以简洁。

### 验证者存款合约

在第 0 阶段，eth2 使用部署在以太坊主网的合约——存款合约——在 `DEPOSIT_CONTRACT_ADDRESS` 上将验证者引入信标链的 PoS 共识。

要参与 PoS 共识，用户向存款合约提交验证者存款。信标链就该合约的状态达成共识并处理新的验证者存款。这个单向存款机制是第 0 阶段系统（以太坊主网和信标链）两个组件之间唯一的技术联系。

### 信标链和验证者机制

选择参与 eth2 共识的用户将 ETH 抵押存入存款合约，以便被纳入信标链验证者集。从那里，这些验证者负责构建 **信标链**（请注意，这些 PoS 中的共识参与者类似于 PoW 中的矿工）。

信标链是一个纯 PoS 链，在第 0 阶段主要关注维护其自身的共识和管理验证者注册。共识规则定义了验证者预期参与的 _角色_（例如区块提议、区块证明）；表现良好的验证者将获得奖励，而表现不佳或离线的验证者将受到惩罚。第 0 阶段尚未包括任何 ETH 转移、分片或智能合约/虚拟机执行能力。

在后续阶段，将向信标链添加额外的机制和验证者责任，以管理多个并行分片链的共识（“第 1 阶段”），整合现有的以太坊系统（“第 1.5 阶段”）并为分片智能合约执行提供全面支持（“第 2 阶段”）。
### 发行

为了激励验证者存入以太坊抵押品并参与 eth2 共识，我们建议定期向共识参与者发放奖励（以以太坊的原生资产以太的形式）。由于信标链在 eth2 的早期阶段与现有的 PoW 链并行运行，这种发行是 _在此基础上_ 额外的 PoW 奖励，直到现有链合并到 eth2 作为一个分片。

发放给信标链验证者的以太数量与总存入的以太数量的平方根成正比。选择这种发行曲线是为了提供比两个明显的替代方案——固定总发行量和每个质押以太的固定发行量——更稳定和可持续的曲线。有关此选择的更技术性讨论，请参见 [这里](../assets/eip-2982/ef-Discouragement-Attacks.pdf)。

在 eth2 中，这条曲线由 `BASE_REWARD_FACTOR` 在时隙时间和纪元长度的上下文中进行参数化。下面是以质押的以太为函数的发行曲线，以及一个示例表格以供说明。请注意，所有显示的数字均为年化。

![](../assets/eip-2982/2982-issuance.png)

| 活跃存款 | 最大年化验证者奖励\* | 最大年化发行 ETH\* |
| -------- | -------: | --------: |
| 0.5M ETH | 23.50%   | 117,527   |
| 1M ETH   | 16.60%   | 166,208   |
| 2M ETH   | 11.75%   | 235,052   |
| 4M ETH   |  8.31%   | 332,411   |
| 8M ETH   |  5.88%   | 470,104   |
| 16M ETH  |  4.16%   | 664,801   |
| 32M ETH  |  2.94%   | 940,167   |
| 64M ETH  |  2.08%   | 1,329,603 |
| 128M ETH |  1.47%   | 1,880,334 |

_\*假设验证者 100% 在线并表现良好。次优的验证者行为将导致奖励减少和/或惩罚，从而减少总发行量。_

### 初始惩罚参数

为了使 PoS 协议在加密经济上安全，协议内的惩罚是必需的。小的离线惩罚激励验证者保持在线，而（潜在的）更大惩罚则在尾部风险场景中提供协议安全。

具体而言，存在以下显著惩罚：
* **非活动泄漏**：在没有最终性的延长时间内，对验证者施加的离线惩罚在每个纪元中增加（例如，如果三分之一或更多的验证者离线或不在规范链上）。这确保了即使在灾难性条件下，链也能最终恢复最终性。
* **削减**：对签署 _明确恶意_ 消息的验证者施加的惩罚，这可能导致构建和最终化两个冲突链（例如，在同一时隙中的两个区块或证明）。此惩罚旨在根据同一时间段内可削减的验证者数量成比例增加，以便如果发生了关键数量（相对于链安全）的削减，验证者将受到 _最大_ 惩罚。

在 Phase 0 的初始启动中，定义这些惩罚幅度的参数——`INACTIVITY_PENALTY_QUOTIENT`、`PROPORTIONAL_SLASHING_MULTIPLIER` 和 `MIN_SLASHING_PENALTY_QUOTIENT`——已调整为比其最终预期值更不具惩罚性。这为早期验证者和客户端软件提供了一个更宽容的环境，以鼓励在这个早期的高技术风险阶段进行验证。

_`INACTIVITY_PENALTY_QUOTIENT` 初始配置为其最终值的四倍_。这导致在非最终性期间，非活动泄漏速度较慢，这意味着链对这种事件的响应较慢。如果在 eth2 的早期几个月内出现长时间的非最终性，极有可能是由于客户端软件的技术问题，而不是某种全球性灾难事件。

_`PROPORTIONAL_SLASHING_MULTIPLIER` 初始配置为其最终值的三分之一_。这导致在攻击发生时可问责的安全边际较低。如果在 eth2 的早期几个月内有任何验证者被削减，极有可能是由于用户对密钥的管理不当和/或客户端软件的问题，而不是有组织的攻击。

_`MIN_SLASHING_PENALTY_QUOTIENT` 初始配置为其最终值的四倍_。这导致可削减违规行为的最低保证惩罚较低，从而减少了保持单个验证者系统安全的基本惩罚激励。与 `PROPORTIONAL_SLASHING_MULTIPLIER` 一样，eth2 的早期几个月内的削减更可能是由于用户管理不当或客户端软件问题，而不是有组织的攻击。

## 理由

### 原则

* **简单性**：特别是由于加密经济权益证明和二次分片本质上复杂，协议应尽可能追求最大简单性。这一点很重要，因为它 (i) 最小化开发成本，(ii) 降低不可预见的安全问题风险，以及 (iii) 使协议设计者更容易说服用户参数选择是合理的。当复杂性是实现特定功能水平的不可避免时，复杂性应优先放在：第二层协议 > 客户端实现 > 协议规范。
* **长期稳定性**：协议的低层级应理想地构建为在十年或更长时间内无需更改，任何必要的创新可以在更高层级（客户端实现或第二层协议）上进行。
* **充分性**：在协议之上构建尽可能多的应用程序类别在根本上应该是可能的。
* **深度防御**：协议应在各种可能的安全假设下尽可能良好地工作（例如，关于网络延迟、故障数量、用户动机）。
* **完全轻客户端可验证性**：在某些假设下（例如，网络延迟、攻击者预算的界限、1-of-N 或少数诚实的 N），验证少量固定数据（理想情况下仅信标链）的客户端应能够间接保证整个系统中的所有数据都是可用和有效的，即使在 51% 攻击下（注意：这是一种深度防御，但重要到足以单独列出）。

### 第一层与第二层的权衡

以太坊路线图采用混合的第一层/第二层方法。我们专注于服务特定类型的第二层（汇总），因为这是唯一一种既继承第一层安全性又提供通用应用程序扩展的第二层。然而，汇总是有代价的：它们每个交易都需要一些链上数据，因此具有非常高容量的区块链必须能够处理仍然相当高的数据带宽。因此，为了使这一点更可行，我们正在实施可扩展的数据层技术，特别是数据可用性抽样。

不采取纯第二层方法的原因是，纯第二层扩展只能通过基于信任的解决方案（不理想）或通道或 Plasma（具有固有限制，无法支持完整的 EVM）来实现。

不采取纯第一层方法的原因是为了在执行层中提供更多实验空间，并使基础协议更简单，治理负担更轻。

### 为什么选择权益证明

简而言之：

* **无需消耗大量电力** 来保护区块链（例如，估计比特币和以太坊每天在其共识机制中消耗超过 100 万美元的电力和硬件成本）。
* 由于缺乏高电力消耗，**不需要发行那么多新币** 来激励参与者继续参与网络。理论上甚至可能实现负净发行，其中一部分交易费用被“销毁”，因此供应量随时间减少。
* 权益证明为更广泛的技术打开了大门，利用博弈论机制设计来更好地 **阻止集中化卡特尔** 的形成，并且如果它们形成，阻止其以对网络有害的方式行事（例如，在工作量证明中自私挖矿）。
* **降低中心化风险**，因为规模经济问题要小得多。1000 万美元的代币将为您带来正好是 100 万美元代币的 10 倍回报，而没有任何额外的不成比例收益，因为在更高的层级，您可以负担得起更好的大规模生产设备，这对工作量证明是一个优势。
* 能够使用经济惩罚来 **使各种形式的 51% 攻击的成本大大高于工作量证明**——用 Vlad Zamfir 的话说，“如果您参与了 51% 攻击，就好像您的 ASIC 农场烧毁了一样”。
### 为什么选择 Casper

目前有三种主要的权益证明共识算法：

* **受中本聪启发的**（Peercoin, NXT, Ouroboros...）
* **受 PBFT 启发的**（Tendermint, Casper FFG, Hotstuff...）
* **CBC Casper**

在后两种类型中，还有一个问题是是否以及如何使用安全存款和惩罚机制（受中本聪启发的算法与非平凡的惩罚机制不兼容）。这三种算法都优于工作量证明，但我们希望为自己的方法辩护。

#### 惩罚机制

以太坊 2.0 使用一种 **惩罚** 机制，检测到不当行为的验证者可以受到惩罚，最佳情况下约为 1%，但在最坏情况下可能会失去其全部存款。

我们为使用惩罚机制辩护如下：

1. **提高攻击成本**：我们希望能够明确声称，对权益证明区块链的 51% 攻击会迫使攻击者承担非常高的费用（想想：数亿美元的代币）被销毁，任何攻击都可以迅速恢复。这使得攻击/防御的计算对攻击者非常不利，实际上使攻击可能变得 *适得其反*，因为服务中断的影响被合法代币持有者的价格收益所抵消。
2. **克服验证者的困境**：节点偏离“诚实”行为的最现实的直接方式是 *懒惰*（即不验证应该验证的内容，随便签署所有内容等）。请参见 [验证者的困境论文](../assets/eip-2982/iacr-2015-702-Demystifying-Incentives-in-the-Consensus-Computer.pdf)（Luu 等，CC BY）以获取理论推理，以及比特币 SPV 挖矿分叉的例子，说明这种情况的发生及其在现实中导致的非常有害的后果。对自我矛盾或签署错误内容的惩罚有助于缓解这一问题。

(2) 的一个更微妙的实例如下所示。在 2019 年 7 月，Cosmos 上的一名验证者因签署两个冲突的区块而受到惩罚。调查发现，这是因为该验证者同时运行了一个主节点和一个备份节点（以确保其中一个节点下线不会阻止他们获得奖励），并且这两个节点意外同时开启，导致它们相互矛盾。

如果将主节点和备份节点的做法变为标准做法，那么攻击者可以对网络进行分区，使所有验证者的主节点和备份节点承诺不同的区块，从而导致两个冲突的区块被最终确认。惩罚机制有助于大幅降低这种做法的激励，减少此类情况发生的风险。

#### 共识算法的选择

只有受 BFT 启发和 CBC 学派的共识算法具有最终性概念，其中一个区块以某种方式被确认，以至于大部分（在 BFT 启发中为 1/3，在 CBC 中为 1/4）验证者需要不当行为并受到惩罚，才能使该区块被撤回以支持某个冲突区块；受中本聪启发的（即最长链规则）共识算法在这个意义上无法实现最终性。

请注意，最终性要求大多数验证者在线，但这已经是分片机制的要求，因为它要求随机抽样的验证者委员会中有 2/3 签署跨链链接，才能接受该跨链链接。

我们选择 [Casper FFG](../assets/eip-2982/arxiv-1710.09437-Casper-the-Friendly-Finality-Gadget.pdf) 只是因为在协议最终确定时，这是可用的最简单算法。具体细节仍然可能长期变化；特别是，我们正在积极探索实现单槽最终性的解决方案。

### 分片 - 或者说，我们为什么讨厌超级节点？

层 1 扩展的主要替代方案是使用超级节点 - 简单地要求每个共识节点拥有强大的服务器，以便它可以单独处理每个交易。基于超级节点的扩展方便，因为它的实现简单：它的工作方式与当前的区块链相同，只是需要更多的软件工程工作来以更可并行化的方式构建。

我们对这种方法的主要反对意见如下：

* **池集中化风险**：在基于超级节点的系统中，运行一个节点的固定成本很高，因此参与的用户少得多。这通常被反驳为“好吧，大多数 PoW 和 PoS 币的共识反正是由 5-20 个池主导的，池可以很好地运行节点”。然而，这种回应忽略了即使在能够承担的池之间也存在集中化压力的风险。如果运行验证者的固定成本相对于收益显著，那么较大的池将能够提供比较小的池更低的费用，这可能导致较小的池被挤出或感受到合并的压力。另一方面，在分片系统中，持有更多 ETH 的验证者需要验证更多交易，因此成本不是固定的。
* **AWS 集中化风险**：在基于超级节点的系统中，家庭质押不可行，因此大多数质押更可能发生在云计算环境中，而这些环境的选择很少。这造成了单点故障。
* **降低审查抵抗力**：使得没有高计算和带宽要求就无法参与共识，使得检测和审查验证者变得更容易。
* **可扩展性**：随着交易吞吐量的增加，在基于超级节点的系统中，上述风险增加，而分片系统可以更轻松地处理增加的负载。

这些集中化风险也是我们不试图实现区块链的超低延迟（<1s）的原因，而是选择相对保守的数字。

相反，以太坊采取了一种方法，每个验证者仅被分配处理所有数据的一小部分。只有质押大量 ETH（想想：数万或更多）的验证者才需要处理链中的所有数据。

请注意，在分片设计中存在一个可能的中间地带，其中区块 _生产_ 是集中化的，但 (i) 区块 _验证_ 是去中心化的，并且 (ii) 存在“旁路通道”，用户可以发送交易，区块生产者被迫包含它们，因此即使是垄断生产者也无法进行审查。我们正在积极考虑倾向于这种方向的分片设计，以提高简单性，从而更快地部署扩展，尽管如果需要，即使在这个规范内，也可以运行分布式构建者，避免集中化。

### 安全模型

通常认为区块链依赖于“诚实多数”假设来确保其安全性：即 >=50% 的参与者将忠实地遵循规定的协议，甚至放弃为个人利益而背叛的机会。实际上，(i) 诚实多数模型是不现实的，参与者“懒惰”，签署区块而不验证它们（参见 [验证者的困境论文](../assets/eip-2982/iacr-2015-702-Demystifying-Incentives-in-the-Consensus-Computer.pdf) 和比特币 SPV 挖矿分叉）是一种非常常见的背叛形式，但幸运的是 (ii) 区块链在更严苛的模型下仍然保持许多或所有的安全属性，保持这些额外的保证是非常重要的。
一个常见的更严格模型是*无协调理性多数*模型，该模型指出参与者以自身利益为出发点，但只有不超过某个百分比（例如，在简单的 PoW 链中为 23.21%）的参与者彼此合作。一个更严格的模型是最坏情况模型，其中有一个单一的参与者控制超过 50% 的算力或股份，问题变为：

* 在这种情况下，我们能否迫使攻击者支付非常高的成本来破坏链的保证？
* 我们可以无条件保留哪些保证？

在权益证明链中，惩罚机制实现了第一个目标。在非分片链中，每个节点验证每个区块实现了第二个目标，具体保证为：（i）最长链是有效的，以及（ii）最长链是*可用的*。

分片中的一个主要挑战是如何在不要求每个节点验证完整链的情况下获得这两个属性。我们采用的深度防御方法通过分片实现了这一点。核心思想是结合随机委员会抽样、保管证明、欺诈证明、 [数据可用性抽样 (DAS)](../assets/eip-2982/arxiv-1809.09044-Fraud-and-Data-Availability-Proofs--Maximising-Light-Client-Security-and-Scaling-Blockchains-with-Dishonest-Majorities.pdf) 以及最终的 ZK-SNARKs，使客户端能够在不下载和验证所有数据的情况下检测和拒绝无效或不可用的链，即使无效链得到了大多数权益证明验证者的支持。

交易的审查可能会以保持共识的方式被客户端检测到，但这项研究尚未纳入以太坊路线图。

以下是当前预期的安全属性，以表格形式表示：

| | 网络延迟 <3s | 网络延迟 3s - 6 min | 网络延迟 > 6 min |
|---|---|---|---|
| >2/3 验证者诚实 | 完美操作 | 不完美但可接受的操作。没有严格的活跃性证明，但在实践中预期活跃。 | 可能间歇性活跃失败，没有安全失败 |
| >2/3 验证者理性，<1/3 协调 | 完美操作 | 不完美但可接受的操作，中心化风险加大 | 可能间歇性活跃失败，没有安全失败，中心化风险非常高 |
| 51% 攻击者 | 可以撤回最终性或审查，但成本很高；无法强行通过无效或不可用的链 | 可以撤回最终性或审查，但成本很高；无法强行通过无效或不可用的链 | 可以撤回最终性或审查；无法强行通过无效或不可用的链 |

### 为什么 Casper 激励机制是这样的？

#### 基础奖励

在每个纪元中，每个验证者都需要进行一次“证明”，即一个表达该验证者对链头看法的签名。对于包含自己的证明有奖励，奖励由四个组成部分（称为“职责”）构成：

1. 证明被包含的奖励
2. 证明指定正确的纪元检查点的奖励
3. 证明指定正确的链头的奖励
4. 正确参与同步委员会签名的奖励

还要注意，这些职责中混合了时效性要求：你的证明必须在一定时间内被包含才能有资格获得奖励，而对于“正确头”职责，该时间限制为 1 个时隙。

对于每个职责，实际奖励的计算如下。如果：

* $R = B * \frac{nom}{den}$ 等于基础奖励乘以对应于该特定职责的分数 $\frac{nom}{den}$
* $P$ 是执行所需操作的验证者比例

那么：

* 任何履行职责的验证者获得奖励 $R * P$
* 任何未履行职责的验证者将受到惩罚 $-R$

这种“集体奖励”机制的目的是“如果任何人表现得更好，所有人表现得更好”，以限制干扰因素（参见[这篇论文](../assets/eip-2982/ef-Discouragement-Attacks.pdf)对干扰因素的描述及其重要性）。

基础奖励 $B$ 本身计算为 $k * \frac{D_i}{\sqrt{\sum_{j=1}^{n} D_j}}$，其中 $D_1 ... D_n$ 是存款大小，$k$ 是一个常数；这是一种在两种常见模型之间的折中，（i）固定奖励率，即 $k * D_i$，和（ii）固定总奖励，即 $k * \frac{D_i}{\sum_{j=1}^{n} D_j}$。

反对（i）的主要论点是它对网络施加了两种不确定性：发行总水平的不确定性和存款总水平的不确定性（如果固定奖励率设置得过低，几乎没有人会参与，从而威胁到网络；如果设置得过高，则会有很多验证者参与，导致意外的高发行）。反对（ii）的主要论点是更容易受到干扰攻击（再次参见[干扰攻击论文](../assets/eip-2982/ef-Discouragement-Attacks.pdf) ）。反平方根方法在两者之间折中，避免了每种情况的最坏后果。

当证明获得奖励时，提议者会获得该奖励的一部分。这是为了鼓励提议者认真倾听消息并尽可能多地接受。

还要注意，奖励的设计对经常离线的验证者是宽容的：离线 1% 的时间只会损失大约 1.6% 的奖励。这也是为了促进去中心化：去中心化系统的目标是从不可靠的部分创建一个可靠的整体，因此我们不应试图强迫每个单独的节点都极其可靠。

#### 不活跃泄漏

如果链在 $tsf > 4$ 个纪元内未能最终确定（$tsf$ = “自最终性以来的时间”），则会添加惩罚，使得最大可能奖励为零（表现不佳的验证者会受到惩罚），并添加第二个惩罚组件，与 $tsf$ 成正比（即，链未最终确定的时间越长，离线的每个纪元惩罚就越高）。这确保了如果超过 1/3 的验证者掉线，未在线的验证者会受到更重的惩罚，并且总惩罚会随着时间的推移而平方增加。

这有三个后果：

* 在你离线实际上阻止区块最终确定的情况下，惩罚离线的程度更重
* 服务于反相关惩罚的目标（见下文）
* 确保如果超过 1/3 的验证者确实掉线，最终在线的比例会回升到 2/3，因为离线验证者的存款在减少

在当前参数设置下，如果区块停止最终确定，验证者在 2.6 天后会失去 1% 的存款，8.4 天后失去 10%，21 天后失去 50%。这意味着例如，如果 50% 的验证者掉线，区块将在 21 天后重新开始最终确定。

#### 惩罚和反相关惩罚

如果验证者被发现违反了 Casper FFG 惩罚条件，他们将受到与他们同时被惩罚的验证者比例相等的存款惩罚，惩罚金额为三倍（具体来说，是在他们被惩罚前的 18 天到他们大约提款的时间之间）。这背后有几个目标：

* 验证者的不当行为只有在与许多其他验证者同时发生时对网络才真正有害，因此在这种情况下惩罚他们更为合理
* 它对实际攻击施加了重罚，但对单一孤立失败施加了非常轻的惩罚，这些失败可能是诚实的错误
* 它确保较小的验证者承担的风险低于较大的验证者（在正常情况下，大型验证者可能是唯一一个与自己同时失败的）
* 它对每个人加入最大池子形成了抑制作用
### BLS 签名

BLS 签名因其聚合友好性而被使用：任何两个签名 $S_1$ 和 $S_2$，它们是由密钥 $k_1$ 和 $k_2$ 签署的消息 $M$（对应的公钥为 $K_1 = G * k_1$ 和 $K_2 = G * k_2$，其中 $G$ 是椭圆曲线的生成元），可以通过椭圆曲线点加法简单地聚合：$S_1 + S_2$，这可以通过公钥 $K_1 + K_2$ 进行验证。这允许成千上万的签名被聚合，每个签名的边际成本仅为一位数据（用于表示特定公钥在聚合签名中存在）和一次椭圆曲线加法的计算。

请注意，这种形式的 BLS 签名容易受到 *恶意密钥攻击*：如果你看到其他验证者已经发布了公钥 $K_1 ... K_n$，那么你可以生成一个私钥 $r$ 并发布一个公钥 $G * r - K_1 - ... - K_n$。聚合公钥将简单地是 $G * r$，因此你将能够生成一个可以通过组合公钥验证的签名。解决这个问题的标准方法是要求 *持有证明*：基本上是一个消息的签名（依赖于公钥，通常不会被签署），它可以通过公钥本身进行验证（即 $sign(message=H'(K), key=k)$，其中私钥为 $k$，公钥为 $K$，$H'$ 是一个哈希函数）。这确保你个人控制与发布的公钥相关联的私钥。

我们使用存款消息的签名（该消息指定了签名密钥以及其他重要数据，如提取密钥）作为持有证明。

### 为什么选择 32 ETH 的验证者规模？

任何具有可追溯故障容忍的 BFT 共识算法（即，如果两个冲突的区块被最终确定，你可以识别出哪个 1/3 的节点负责）必须要求所有验证者参与。此外，出于技术原因，你需要每个验证者参与两轮才能最终确定一条消息。

这导致了去中心化/最终性时间/开销的权衡：如果 $n$ 是网络中的验证者数量，$f$ 是最终确定一个区块的时间，$\omega$ 是每秒的消息开销，那么我们有：

$$\omega \ge \frac{2 * n}{f}$$

例如，如果我们可以接受每秒 10 条消息的开销，那么一个 10000 节点的网络的最终确定时间至少为 2000 秒（约 33 分钟）。

在以太坊的情况下，如果我们假设总 ETH 供应量约为 $\approx 2^{27}$ ETH，那么在 32 ETH 的存款规模下，最多有 $2^{22}$ 个验证者（如果每个人都进行验证；一般来说，我们预计验证的 ETH 数量会少约 10 倍）。在 2 个纪元的最终确定时间（2 * 32 * 12 = 768 秒）下，这意味着最大开销为 $\frac{2^{22}}{768} \approx 5461$ 条消息每秒。由于 BLS 聚合将每个签名的边际大小减少到 1 位，边际验证复杂度减少到一次椭圆曲线加法，我们可以容忍如此高的开销。

32 个插槽是一个安全的最小值，另一个原因是：如果攻击者操纵用于提议者选择的随机性，这个数字仍然提供足够的空间，以确保每个纪元至少有一个诚实的提议者，这足以确保区块持续最终确定。我们的计算表明，当前的开销水平是可以接受的，但更高的水平将使运行节点变得过于困难。最后，验证者的存款规模对于分片交叉链接是理想的（见下文）。

### 随机抽样

#### 种子选择

用于随机性的种子在每个区块中通过“混合”（即 `seed <- xor(seed, new_data)`）一个必须由区块的提议者揭示的值进行更新。就像保管证明子密钥一样，一旦验证者存款，他们的值都是预先确定的，第三方无法计算子密钥，但可以验证自愿揭示的子密钥（这个机制有时被称为 RANDAO）。

这确保每个提议者对种子有一个“操控位”：他们可以选择生成一个区块或不生成一个区块。不生成一个区块是昂贵的，因为提议者会错过许多奖励。此外，由于持久委员会和信标委员会的规模（见下文）很大，随机性的操控几乎肯定无法让少数攻击者控制任何委员会的 2/3。

未来，我们计划使用可验证延迟函数（VDFs）进一步增强随机种子对操控的鲁棒性。

#### 洗牌

我们使用 Viet Tung Hoang、Ben Morris 和 Phillip Rogaway 描述的 swap-or-not 洗牌算法来洗牌验证者集并在每个纪元分配责任。该算法确保：

* 由于洗牌是一个排列，每个验证者在每个纪元中被分配为恰好一个委员会的成员（保持他们的负载稳定，减少随机性操控获利的机会）
* 由于洗牌在前向方向上是逐点可评估的，验证者可以在 O(1) 时间内确定自己的责任
* 由于洗牌在反向方向上是逐点可评估的，任何特定委员会的成员或任何特定区块的提议者可以在 O(1) 时间内计算

#### 按插槽洗牌

一个纪元中有 32 个插槽，负责对每个插槽进行证明的验证者是通过洗牌选择的。这确保了拥有显著但仍然较小的总质押比例的攻击者无法接管特定插槽并导致短期重组。

#### 信标委员会

每个插槽的委员会又被分成若干个 *信标委员会*。截至今天（2022 年 1 月），这个设计确实发挥了一个有用的功能，允许不同的证明子集在不同的子网中聚合，从而使 p2p 网络更高效。然而，它并没有发挥任何其他有用的共识相关角色。

在最初的分片设计中，意图是每个信标委员会负责验证一个特定的分片。然而，如果我们切换到单提议者模型，这种方法可能会被弃用。因此，更细粒度的信标委员会可能只是象征性存在，最终可能会被移除或以不同的方式重组，以便专注于促进证明聚合。

#### 同步委员会

每 ~27 小时选择一个由 512 个验证者组成的同步委员会来签署一个区块；该委员会的公钥保存在一个易于访问的列表中，允许超轻客户端轻松验证签名。

### LMD GHOST 分叉选择规则

信标链使用 LMD GHOST 分叉选择规则。

LMD GHOST 分叉选择规则整合了来自所有验证者的信息，每个插槽中有数百个验证者，使得在正常情况下，甚至单个区块被回滚的可能性极小。由于分叉选择依赖于所有验证者，这也确保了区块无法被回滚，除非攻击者确实控制了接近 50% 的整个验证者集；通过操控随机性无法获得巨大优势。

### 保管证明游戏

在每个 9 天的周期内，每个验证者都有能力私下生成一个“周期子密钥”。验证者的公钥唯一确定他们在每个周期的周期子密钥，因此一旦验证者存款，他们就没有进一步选择子密钥的自由。除了验证者自己，没有人可以计算任何给定验证者的子密钥，但一旦验证者自愿揭示一个子密钥，任何人都可以验证其正确性（这一切都是通过 BLS 魔法完成的，如果未来需要量子安全，可以通过基于哈希的承诺来实现）。
在第 $j$ 个周期使用根 $R$ 对数据 $D$ 签名时，设 $s$ 为该验证者的第 $j$ 个周期的秘密，验证者需要计算一个位字段 $M$，具体如下：

* 将 $D$ 拆分为 512 字节的块 $D[0] ... D[n-1]$
* 将 $M$ 设置为位字段，其中第 i 位为 $M[i] = mix(s, D[i])$

它们包括 `get_chunk_bits_root(M)`（这被称为 **监护位**）作为它们签名的一部分。`mix` 和 `get_chunk_bits_root` 都可以视为输出单个位的哈希类函数（但设计上是为了多方计算友好）。

如果一个交叉链接包含多个区块 $B_1 ... B_n$，并且验证者为这些区块计算监护位 $c_1 ... c_n$，那么验证者会签署所有的 $(B_i, c_i, i)$ 元组并进行聚合。这种非常规的自聚合用于确保只有 $2n$ 个不同的消息（n 个不同的区块/索引对 * 2 个不同的位值）被不同的验证者签名，从而减少验证签名所需的配对数量。

如果验证者在第 $j$ 个周期期间或之前发布他们的周期 $j$ 子密钥，任何其他验证者都可以向链上发布子密钥的知识证明，这将惩罚被揭露子密钥的验证者。知识证明还证明了是哪个验证者创建了它；这防止了区块提议者“窃取”举报奖励（再次通过 BLS 魔法完成，如果未来需要量子安全，可以通过 STARKs 实现）。这样做的目的是使外包 $M$ 的计算变得危险。

在验证者发布他们的第 $j$ 个周期子密钥后，任何人都可以检查他们为任何已签名区块的工作。如果他们发现某个验证者提供了不正确的监护位，他们可以在链上对此提出质疑，并惩罚该验证者。一般来说，随机猜测（或任何不涉及全部 $D$ 的过程）只会在一半的时间内给出正确答案，导致每个签名区块有 50% 的惩罚风险。

该机制的目的是缓解 [验证者困境](../assets/eip-2982/iacr-2015-702-Demystifying-Incentives-in-the-Consensus-Computer.pdf) 问题，其中验证者有动机避免验证数据，出于懒惰而依赖于所有 *其他* 验证者都是诚实的假设；如果太多验证者这样思考，可能会导致公地悲剧，从而导致链接受无效区块。通过这个方案，如果验证者试图承诺他们没有亲自处理的数据，那么他们将无法计算 $M$，因此会在互动挑战游戏中失败。

### SSZ

SimpleSerialize 套件包含以下算法：

* 一个序列化算法
* 一个哈希算法（称为 `SSZTreeHash` 或 `hash_tree_root`）
* 一个通用的默克尔证明算法（称为“SSZ 部分”），可以处理多个值的证明，并在这种情况下优化去重默克尔树姐妹节点。

序列化算法具有以下设计目标：

* 简单性（例如，没有像 RLP 对于长/列表编码根据项目长度有三个子句）
* 在完全固定大小对象的情况下等同于简单连接
* 可用作共识层序列化算法和应用层 ABI

请注意，生成的 SSZ 序列化规范与以太坊 1.0 ABI 非常相似，主要区别在于 (i) 不同的基本数据类型和 (ii) 用 4 字节大小替换 32 字节长度/位置记录大小。

哈希算法具有以下设计目标：

* 在更新对象的情况下高效计算哈希，尤其是当对象非常大和/或复杂而更改相对较小时
* 在给定哈希的情况下，即使在大型或复杂对象中，也能高效（在验证复杂性 _和_ 见证大小方面）证明特定字段的值

这些要求共同使得默克尔树结构成为显而易见的选择。

#### 通用索引

请参见 https://github.com/ethereum/eth2.0-specs/blob/dev/ssz/merkle-proofs.md 以获取通用索引的描述，以及它们如何通过将路径表示为整数或位字段来轻松验证默克尔证明“插入”对象中的任意位置。

### 验证者生命周期

#### 存款

验证者通过发送交易调用以太坊 1 链上的存款合约中的一个函数进行存款（最终，也将添加从以太坊 2 内部存款的方式）。存款指定：

* 与将用于签名消息的私钥对应的公钥
* 提款凭证（将用于提取资金的公钥的哈希，一旦验证者完成验证）
* 存款金额

这些值都由签名密钥签名。将签名密钥和提款密钥分开的目的是允许更危险的提款密钥被更安全地保管（离线，不与任何质押池共享等），而签名密钥则用于每个周期主动签名消息。

存款合约维护所有迄今为止进行的存款的默克尔根。一旦包含存款的默克尔根被纳入以太坊 2 链（通过 Eth1Data 投票机制），以太坊 2 区块提议者可以提交存款的默克尔证明并开始存款过程。

#### 激活

验证者立即加入验证者注册表，但最初处于非活动状态。验证者在 $N \ge 4$ 个周期后变为活跃；最小值 4 是为了确保 RANDAO 不可操控，如果太多验证者同时尝试加入，$N$ 可能超过 4。如果活跃验证者集的大小为 $|V|$，则每个周期最多可以有 $max(4, \frac{|V|}{65536})$ 个验证者加入；如果更多验证者尝试加入，他们将被放入队列并尽快处理。

#### 退出

当验证者退出（无论是通过发布自愿退出消息还是被惩罚），他们同样被放入退出队列，具有相同的最大吞吐量。

入口/退出队列限制的原因是确保验证者集在任何两个时间点之间不能变化太快，这确保了只要验证者足够频繁地登录（如果 $|V| \ge 262144$，大约每 1-2 个月一次），则在两个链之间仍然保持最终性保证。请参见此处 https://ethresear.ch/t/rate-limiting-entry-exits-not-withdrawals/4942 以获取理由（特别是为什么使用速率限制而不是固定等待时间）以及 https://ethresear.ch/t/weak-subjectivity-under-the-exit-queue-model/5187 以获取如何计算离线一段时间的客户端的安全边际。

#### 提款

一旦验证者离开退出队列，他们将有大约 27 小时的时间才能提款。此期间有几个功能：

* 确保如果验证者行为不当，有一段时间可以捕捉到错误，并且即使退出队列几乎为空，验证者也可以被惩罚。
* 提供时间以包含最后一周期的分片奖励。
* 提供时间以进行监护证明挑战。

如果验证者被惩罚，将施加进一步约 36 天的延迟。这进一步惩罚他们（并迫使他们持有 ETH；这使得对试图破坏以太坊区块链的恶意验证者的惩罚相对较大，而那些想要支持平台但只是犯了错误的验证者则相对较小，因为前者需要冒着暴露风险或支付衍生品来抵消），但也允许在此期间计算被惩罚的其他验证者的数量。
在第 0 阶段，"已撤回"的验证者实际上还不能提取到任何地方；唯一的区别是它受到验证者惩罚的保护，并且没有任何责任。在后续阶段，将提供将资金从已撤回验证者插槽移动到执行环境的能力。

#### 有效余额

大多数基于验证者余额的计算使用验证者的"有效余额"；唯一的例外是增加或减少验证者余额的计算。只有当验证者的余额 $B$ 低于 $EB$ 或高于 $EB + 1.5$ 时，$EB$ 才会调整为等于 $floor(B)$。这样做是为了确保有效余额不频繁变化，从而减少每个周期重新计算状态所需的哈希量；平均而言，只需更新所有余额，而有效余额每个验证者只需相对较少地更新。所有余额都存储在一个专用向量中，因此重新计算余额数组需要 $2 * \frac{N * 8}{32} = \frac{N}{2}$ 个哈希，而有效余额存储在验证者记录对象中，每个验证者至少需要 $5N$ 个哈希来调整 SSZ 哈希根。此外，$EB$ 可以更容易地压缩到一个 CompactValidator 对象中，因为它只有一个字节。

### 分叉机制

`Fork` 数据结构包含 (i) 当前的 "分叉 ID"，(ii) 之前的分叉 ID 和 (iii) 切换槽。当前高度的分叉 ID 影响所有消息的有效签名；因此，使用一个分叉 ID 签名的消息在使用任何其他分叉 ID 的验证函数中都是无效的。

通过在某个 "分叉槽" $n$ 添加状态转换来进行分叉，该转换将之前的分叉 ID 设置为当前分叉 ID，将当前分叉 ID 设置为新值，并将切换槽设置为 $n$。签名验证函数将使用消息所在槽的分叉 ID 验证消息，这可能是之前的分叉 ID 或当前的分叉 ID（例如，考虑在延迟后包含的证明；来自分叉槽之前的证明可以在分叉槽之后包含）。

如果任何用户不想加入分叉，他们可以简单地继续在分叉槽不更改分叉 ID 的链上。两个链可以继续进行，验证者可以自由地在两个链上进行验证而不会被削减。

## 向后兼容性

尽管此 EIP 并未对当前以太坊主网引入任何直接变化，但此 EIP 为未来的向后不兼容性奠定了基础，通过引入新的 eth2 共识机制，Ethereum 将在后续阶段集成。为了确保该机制，用户将以太币转移到信标链，并发行额外的以太币。此 EIP 是对这一路径的承诺，同时直接告知以太坊主网的未来和路线图。

## 安全考虑

Eth2 是以太坊核心共识从 PoW 到分片 PoS 的重大改革。这一迁移存在固有风险，但有大量研究文献分析安全性和权衡。*以下仅代表可用资源的高层选择：*

* [Casper FFG](../assets/eip-2982/arxiv-1710.09437-Casper-the-Friendly-Finality-Gadget.pdf)
* [结合 GHOST 和 Casper](../assets/eip-2982/arxiv-2003.03052-Combining-GHOST-and-Casper.pdf)

除了支持这一路径的研究外，还进行了多项审计和规范、密码学及客户端实现的形式验证。*许多客户端和实用库的审计目前正在进行中，完成后将附加在此。*

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。