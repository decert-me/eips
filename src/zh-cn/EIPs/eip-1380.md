---
eip: 1380
title: 减少对自身调用的 gas 成本
author: Alex Beregszaszi (@axic), Jacques Wagener (@jacqueswww)
discussions-to: https://ethereum-magicians.org/t/eip-1380-reduced-gas-cost-for-call-to-self/1242
status: Stagnant
type: Standards Track
category: Core
created: 2018-08-31
requires: 150
---

## 摘要

减少调用指令的 gas 成本，当目标是运行当前加载合约的新实例时。

## 动机

当前所有调用类型（`CALL`、`DELEGATECALL`、`CALLCODE` 和 `STATICCALL`）的 gas 成本为 700，并未考虑到对合约自身的调用
不需要执行额外的 I/O 操作，因为当前合约代码已经加载到内存中。

减少对自身调用的 gas 成本将极大地惠及智能合约语言，如 Solidity 和 Vyper，这样它们就可以利用 `CALL` 而不是
`JUMP` 操作码进行内部函数调用。虽然语言已经可以利用 `CALL` 进行内部函数调用，但由于相关的 gas 成本，它们不被鼓励这样做。

使用 `JUMP` 在智能合约语言和/或编译器的实现中带来了相当大的复杂性成本。上下文（包括堆栈和内存）
必须在调用函数的上下文中进行切换。一个期望的特性是拥有 *纯* 函数，这些函数不修改内存的状态，而通过 `JUMP` 实现它们
需要编译器付出更大的努力，而不是能够使用 `CALL`。

使用对自身调用提供了保证，当进行内部调用时，函数可以依赖于内存或上下文的清晰重置状态，这对合约编写者和合约消费者都有利，
可以防止潜在未检测到的边缘情况，其中内存可能会污染内部函数的上下文。

由于对内部函数使用 `JUMP`，智能合约语言也面临着更快达到堆栈深度限制的风险，如果需要嵌套函数调用并且有许多输入和/或输出。

减少 gas 成本，从而激励使用对自身调用而不是 `JUMP` 进行内部函数实现，也将有利于静态分析器和跟踪器。

## 规范

如果 `block.number >= FORK_BLKNUM`，则将 `CALL`、`DELEGATECALL`、`CALLCODE` 和 `STATICCALL` 的成本从 700 降低到 40，
仅当调用的目标地址等于调用者的地址时。

## 理由

EIP150 将这些指令的成本从 40 增加到 700，以更公平地收取从磁盘加载新合约的费用，例如，更准确地反映 I/O 收费。
假设 660 是从磁盘加载合约的成本，可以认为原始的 40 gas 是创建已加载合约代码的新 VM 实例的合理成本。

## 向后兼容性

这不应对向后兼容性构成风险。当前现有合约不应注意到差异，只需看到更便宜的执行。
通过 EIP150，合约（和语言）开发者得到了一个教训，即依赖严格的 gas 成本是不可行的，因为成本可能会变化。
该 EIP 的影响甚至小于 EIP150，因为成本是向下变化而不是向上变化。

## 测试用例

待定

## 实现

待定

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。