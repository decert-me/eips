---
eip: 1965
title: 检查特定区块号下链 ID 是否有效的方法
author: Ronan Sandford (@wighawag)
category: 核心
type: 标准跟踪
discussions-to: https://ethereum-magicians.org/t/eip-1965-valid-chainid-for-specific-blocknumber-protect-all-forks/3181
status: 停滞
created: 2019-04-20
requires: 155
---

## 摘要
此 EIP 添加了一个预编译，返回特定链 ID（EIP-155 唯一标识符）在特定区块号下是否有效。链 ID 被假定在被新链 ID 替换的区块号之前是有效的。

## 动机
[EIP-155](./eip-155.md)提议使用链 ID 来防止不同链之间的交易重放。在处理离线消息签名时，尤其是在使用 [EIP-712](./eip-712.md) 的第二层签名方案中，能够在智能合约内部实现相同的可能性将是一个巨大的好处。

[EIP-1344](./eip-1344.md)试图通过让智能合约访问链 ID 历史的最新状态来解决这个问题。这是不够的，因为这样的值是变化的。因此，EIP-1344 描述了一种基于合约的解决方案来解决这个问题。更好的方法是以更简单、更便宜和更安全的方式解决它，消除 EIP-1344 中存在的潜在滥用风险。此外，EIP-1344 无法正确保护少数主导的硬分叉的重放，因为缓存系统无法保证新链 ID 引入时的区块号的准确性。

[EIP-1959](./eip-1959.md)解决了 EIP-1344 的问题，但未尝试保护少数主导的硬分叉，如理由中所提到的。我们认为这是一个错误，因为这限制了分叉的自由。我们认为所有分叉都应获得平等的机会。尽管总会存在我们无法为忽视特定分叉的多数解决的问题，**决定同时使用少数分叉和多数链的用户应在不必等待多数链更新其链 ID 的情况下受到重放保护。**

## 规范
添加一个新的预编译，使用两个参数：一个 32 字节的值表示要测试的链 ID，一个 32 字节的值表示测试链 ID 时的区块号。如果链 ID 在特定区块号下有效，则返回 0x1，否则返回 0x0。请注意，链 ID 被认为在被替换的区块号之前是有效的。因此，它们在被替换后的每个区块号都是有效的。

该操作的执行成本不超过`G_blockhash` + `G_verylow`。由于链 ID 仅在硬分叉期间引入，因此这可能更低。

随着链历史中链 ID 数量的增加，该操作的成本可能需要稍后进行调整。

请注意，跟踪旧链 ID 的替代方案是实现基于智能合约的缓存解决方案，如 EIP-1344 所提议的，这会带来整体更高的 gas 成本，并在少数主导的硬分叉中出现问题（见下文的理由部分）。因此，gas 成本只是该功能的必要成本。

## 理由

EIP-1959 中的理由在这里同样适用：

- 一个操作码比过去链 ID 的缓存系统更好，它更便宜、更安全且没有间隙。
- 直接访问最新链 ID 是危险的，因为这使得合约可以将其用作重放保护机制，同时阻止在更改链 ID 后有效的旧消息。这可能对用户造成灾难性的后果。
- 在分叉之前签署的所有离线消息在分叉的两侧都应有效。

唯一的区别是当前提案提出了一种保护少数主导的硬分叉的解决方案。

总结来说，有两种可能的分叉场景：

1) 大多数决定进行硬分叉，但少数不同意（ETC 就是一个例子）。分叉计划在区块 X。如果大多数没有采取任何行动来自动分配不同的链 ID，少数有充足的时间计划在同一区块 X 进行链 ID 升级。如果他们不这样做，他们的用户将面临消息在多数链上可重放的问题（请注意，反之则不成立，因为我们假设大多数决定更改链 ID）。因此，他们没有理由让它保持那样。

2) 少数决定创建一个大多数不同意（或简单忽视）的硬分叉。现在，和上面一样的情况可能发生，但由于我们谈论的是少数，可能大多数并不关心少数。在这种情况下，大多数没有升级链 ID 的动力。这意味着分叉两侧的用户将面临消息在少数链上可重放（即使该链更改了其链 ID），除非采取额外的预防措施。

解决方案是添加表示消息签署时间的区块号，并将其作为参数传递给此处提议的操作码。这样，当少数分叉时，新的链 ID 将使之前的链 ID 从那时起无效。因此，发往多数链的新消息无法在少数分叉上重放。

## 向后兼容性

EIP-712 仍在草案中，但需要更新以包括区块号作为钱包需要验证的用户保护值的一部分。

由于链 ID 和区块号将有所不同，它们不应成为域分隔符的一部分（该分隔符应生成一次），而应成为消息的另一部分。

虽然对于不关心重放或有其他方法防止重放的合约，这对可以是可选的，但如果链 ID 存在，则区块号也必须存在。如果其中任何一个存在，钱包需要确保链 ID 确实是所使用链的最新链 ID，而区块号是在签署时的最新链号。在分叉过渡期间，钱包可以使用区块号来确定使用哪个链 ID。

## 参考
这之前作为 [EIP1959 讨论](https://ethereum-magicians.org/t/eip-1959-valid-chainid-opcode/3170)的一部分被建议过。

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。