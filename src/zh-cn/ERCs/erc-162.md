---
eip: 162
title: 初始 ENS 哈希注册器
author: Maurelian, Nick Johnson  <nick@ethereum.org>, Alex Van de Sande <avsa@ethereum.org>
status: 最终
type: 标准跟踪
category: ERC
created: 2016-10-25
---

## 目录
- 摘要
- 动机
- 规范
  - 初始限制
  - 哈希注册的名称格式
  - 名称拍卖
  - 契约
  - 部署和升级过程
  - 注册器接口
- 理由
  - 开始时不承诺永久注册器
  - 有效名称 >= 7 个字符
  - 限制顶级域为 `.eth`
  - 以以太作为抵押
- 先前工作

<!-- /MarkdownTOC -->

## 摘要

本 ERC 描述了在 2017-05-04 部署到主以太坊网络的注册器合约的实现，以管理以太坊名称服务（ENS）中的名称分配。相应的源代码在 [这里](https://github.com/ethereum/ens/blob/mainnet/contracts/HashRegistrarSimplified.sol)。

有关更多背景信息，请参阅 [EIP-137](./eip-137.md)。

> 注册器负责将域名分配给系统用户，并且是唯一能够更新 ENS 的实体；ENS 注册表中节点的所有者是其注册器。注册器可以是合约或外部拥有的账户，但预计根和顶级注册器至少将作为合约实现。
>
> \- EIP 137

一个设计良好且管理得当的注册器对于 EIP 137 中描述的 ENS 的成功至关重要，但在本文件中单独描述，因为它是核心 ENS 协议之外的内容。

为了最大化新命名空间的实用性和采用，注册器应减轻投机和“名称抢注”，但减轻的最佳方法尚不清楚。因此，提出了一个“初始”注册器，它实现了一种简单的名称分配方法。在初始期间，可用的命名空间将显著限制为 `.eth` 顶级域，并且不允许长度小于 7 个字符的子域名。该规范主要描述了 @alexvandesande 和 @arachnid 的 [哈希注册器实现](https://github.com/ethereum/ens/blob/mainnet/contracts/HashRegistrarSimplified.sol)，以促进讨论。

意图是用永久注册器合约替换初始注册器合约。永久注册器将增加可用的命名空间，并结合从初始注册器的性能中获得的经验教训。预计此升级将在初始部署后大约 2 年内进行。

## 动机

以下因素应考虑在内，以优化 ENS 的采用和初始注册器命名空间的良好治理。

**可升级性：** 初始注册器应安全可升级，以便在其部署期间获得的知识可以用于用改进的永久注册器替换它。

**有效分配：** 新发布的命名空间通常会造成土地抢夺的情况，导致许多潜在有价值的名称被购买但未使用，期望以盈利的方式转售。这减少了最有用名称的可用性，从而降低了名称服务对最终用户的实用性。

实现有效分配可能需要或不需要人为干预来解决争议和其他形式的策展。初始注册器不应旨在创建最有效的分配，而应限制长期内错误分配的成本。

**安全性：** 注册器将持有没有明确限制的以太余额。必须安全设计。

**简单性：** ENS 规范本身强调关注点的分离，使最基本的元素，即注册表尽可能简单。临时注册器应在满足其他设计目标的同时尽可能简单。

**采用：** 成功的标准由于网络效应而变得更加成功。注册器应考虑哪些策略将鼓励 ENS 的普遍采用，以及它特别控制的命名空间的采用。

## 规范

### 初始限制

初始注册器预计将在升级前服务约两年。这应该足够的时间来学习、观察和设计更新的系统。

在初始的两年期间，可用的命名空间将限制为 `.eth` 顶级域。

此限制由 ENS 根节点的所有者强制执行，后者不应将任何节点分配给初始注册器，除了 `.eth`。ENS 的根节点应由多个方使用多重签名合约控制。

初始注册器还将禁止注册长度为 6 个字符或更少的名称。

### 哈希注册的名称格式

提交给初始注册器的名称必须使用以太坊的 sha3 函数进行哈希。请注意，提交给注册器的哈希是被注册的子域标签的哈希，而不是 EIP 137 中定义的名称哈希。

例如，为了注册 `abcdefg.eth`，应提交 `sha3('abcdefg')`，而不是 `sha3(sha3(0, 'eth'), 'abcdefg')`。

### 名称拍卖

注册器将通过维克瑞拍卖分配可用名称：

> 维克瑞拍卖是一种密封投标拍卖。投标者在不知道其他人投标的情况下提交书面投标。最高出价者获胜，但支付的价格是第二高的投标。这种类型的拍卖...给投标者提供了以真实价值投标的激励。
>
> \- [维克瑞拍卖，维基百科](https://en.wikipedia.org/wiki/Vickrey_auction)

名称的拍卖生命周期有 5 种可能的状态或模式。

1. **尚未可用：** 大多数名称在初始时将不可用于拍卖，并将在启动后的 8 周内某个时间变得可用。
2. **开放：** 名称的最早可用性由其 sha3 哈希的最重要字节决定。`0x00` 将立即可用，`0xFF` 将在 8 周后可用，其他名称的可用性相应分布。一旦名称可用，就可以开始拍卖。
3. **拍卖：** 一旦名称的拍卖开始，将有 72 小时的投标期。投标者必须提交以太的支付，以及作为 `sha3(bytes32 hash, address owner, uint value, bytes32 salt)` 的哈希的密封投标。投标者可以通过发送更多的以太来模糊真实的投标价值。
4. **揭示：** 在投标期结束后，将开始 48 小时的揭示期。在此期间，投标者必须揭示其密封投标的真实参数。随着投标的揭示，以太支付将根据下表中概述的“退款比例”计划返回。如果没有投标被揭示，名称将返回到开放状态。
5. **已拥有：** 在揭示期结束后，获胜的投标者必须提交交易以完成拍卖，然后调用 ENS 的 `setSubnodeOwner` 函数，记录获胜投标者的地址为名称哈希的所有者。

下表概述了定义注册器拍卖机制的重要参数。

#### 注册器参数

|        名称        |                                            描述                                             |   值    |
|--------------------|------------------------------------------------------------------------------------------------|----------|
| totalAuctionLength | 从拍卖开始到揭示期结束的完整时间段。                                                        | 5 天     |
| revealPeriod       | 投标不再允许的时间段，必须揭示投标的长度。                                                  | 48 小时  |
| launchLength       | 所有名称将变得可用于拍卖的时间段。                                                          | 8 周     |
| minPrice           | 必须锁定的以太最低金额，以换取名称的所有权。                                                | 0.01 以太 |
### 产权契约

初始注册合约本身不持有余额。所有发送到注册者的以太币将保存在单独的 `Deed` 合约中。当提交密封竞标时，首先创建并资助一个契约。拍卖完成并注册哈希后，获胜竞标的契约将被持有，以换取哈希的所有权。未获胜的竞标将被退款。

已拥有名称的契约可以由其所有者转移到另一个账户，从而转移名称的所有权和控制权。

在注册一年后，哈希的所有者可以选择放弃所有权，并将契约的价值返还给他们。

未获胜竞标的契约可以通过各种方式关闭，此时任何持有的以太币将被退还给竞标者、销毁或作为奖励发送给帮助注册者的其他人。

下表概述了在关闭契约时将退还的余额部分及其接收者。剩余余额将被销毁。

#### 退款计划

| 产权契约关闭原因 | 退款接收者 | 退款百分比 |
| --- | --- | --- |
| 公开有效的未获胜竞标。 | 竞标者 | 99.5% |
| 拍卖期间后提交的竞标被公开。 | 竞标者 | 99.5% |
| 在已拥有名称上公开的其他有效竞标。<sup>1</sup> | 竞标者 | 0.5% |
| 过期的密封竞标被取消。<sup>2</sup> | 取消者 | 0.5% |
| 注册的哈希被报告为无效。<sup>3</sup> | 报告者 | 50% |
| 注册的哈希被报告为无效。<sup>3</sup> | 所有者 | 50% |

##### 注释：

1. 这激励所有竞标及时公开。如果竞标可以延迟公开，则可以通过威胁公开新的第二高竞标对当前最高竞标者进行敲诈攻击。
2. 在超过 2 周 5 天后仍保持密封的竞标可以被任何人取消，以收取小额奖励。
2. 由于名称在拍卖和注册之前被哈希，初始注册者无法独立执行字符长度限制。因此，提供了报告无效名称的奖励。

### 部署和升级过程

初始注册者需要 ENS 的地址作为构造函数，并应在 ENS 之后部署。拥有 ENS 根节点的多签账户应将初始注册者的地址设置为 `eth` 节点的所有者。

预计初始注册者将在部署后约 2 年被永久注册者替代。升级过程应如下进行：
1. 部署永久注册者合约。
2. 拥有 ENS 根节点的多签账户将 `.eth` 节点的所有权分配给永久注册者。
3. 初始注册者中的哈希所有者将负责将其契约注册到永久注册者。这里考虑了几个选项：
   1. 要求所有者在截止日期之前转移其所有权，以保持所有权和/或继续名称解析服务。
   2. 让永久注册者查询初始注册者以获取所有权，如果缺少条目。

### 计划停用

为了限制对初始注册者的依赖，新拍卖将在 4 年后停止，8 年后所有持有的契约中的以太币将变得无法访问。

### 注册者接口

`function state(bytes32 _hash) constant returns (Mode)`
- 实现一个状态机，返回名称的当前状态

`function entries(bytes32 _hash) constant returns (Mode, address, uint, uint, uint)`
- 返回有关注册名称的以下信息：
  * 状态
  * 契约地址
  * 注册日期
  * 契约余额
  * 拍卖中最高的竞标金额

`function getAllowedTime(bytes32 _hash) constant returns (uint timestamp)`
- 返回哈希不再处于初始 `not-yet-available` 状态的时间。

`function isAllowed(bytes32 _hash, uint _timestamp) constant returns (bool allowed)`
- 接受一个哈希和一个时间，仅在通过初始 `not-yet-available` 状态后返回 true。

`function startAuction(bytes32 _hash);`
- 将哈希的状态从开放状态移动到拍卖状态。如果状态不是开放状态则抛出异常。

`function startAuctions(bytes32[] _hashes);`
- 在一组哈希上启动多个拍卖。这使得某人可以为多个虚拟哈希开启拍卖，而他们实际上只对竞标一个感兴趣。这将增加攻击者在所有新拍卖中盲目竞标的成本。开放但未竞标的虚拟拍卖将在一周后关闭。

`function shaBid(bytes32 hash, address owner, uint value, bytes32 salt) constant returns (bytes32 sealedBid);`
- 接受竞标的参数，并返回参与拍卖所需的密封竞标哈希值。这会模糊参数，以模拟将竞标放入信封中的机制。

`function newBid(bytes32 sealedBid);`
- 通过向主合约发送带有密封竞标哈希和以太币金额的消息来发送竞标。哈希包含有关竞标的信息，包括竞标名称哈希、竞标金额和随机盐。竞标在被公开之前与任何一个拍卖无关。竞标的实际金额可以通过发送超过实际竞标金额的以太币来伪装。接下来是 48 小时的公开期。在此期间后公开的竞标将被销毁，且以太币无法恢复。由于这是拍卖，预计大多数公共哈希，如已知域名和常见字典单词，将有多个竞标者推高价格。

`function startAuctionsAndBid(bytes32[] hashes, bytes32 sealedBid)`
- 一个实用函数，允许在单个交易中调用 `startAuctions` 后跟 `newBid`。

`function unsealBid(bytes32 _hash, address _owner, uint _value, bytes32 _salt);`
- 一旦竞标期结束，将有一个公开期，在此期间提交竞标的属性以进行公开。注册者使用上述 `shaBid()` 函数对这些属性进行哈希，以验证它们是否与预先存在的密封竞标匹配。如果 unsealedBid 是新的最佳竞标，则将旧的最佳竞标返回给其竞标者。

`function cancelBid(bytes32 seal);`
- 根据上述退款计划中的规则取消未公开的竞标。

`function finalizeAuction(bytes32 _hash);`

在注册日期过去后，可以调用此函数以最终确定拍卖，然后调用 ENS 函数 `setSubnodeOwner()` 更新 ENS 记录，将获胜竞标者设置为节点的所有者。

`function transfer(bytes32 _hash, address newOwner);`
- 将与提交的哈希对应的 ENS 节点的所有者更新为新所有者。此函数必须仅由当前所有者调用。

`function releaseDeed(bytes32 _hash);`
- 经过一段时间后，所有者可以释放财产并取回他们的以太币。

`function invalidateName(string unhashedName);`
- 由于注册是在名称的哈希上进行的，注册者本身无法验证名称。此函数可用于报告长度为 6 个字符或更少的名称。如果已注册，提交者将获得契约价值的 10%。我们故意限制简化注册者，以迫使其在几年内进行重组。
```markdown
`function eraseNode(bytes32[] labels)`
- 允许任何人删除当前在注册处未拥有的名称的子域的所有者和解析器记录。例如，要在拥有 `.eth` 的注册处将 `foo.bar.eth` 清零，请传递包含 `[sha3('foo'), sha3('bar')]` 的数组。

`function transferRegistrars(bytes32 _hash) onlyOwner(_hash);`
- 在升级到永久注册处的过程中使用。如果该注册处不再是其在 ENS 中根节点的所有者，则此函数将把契约转移给当前所有者，该所有者应为新的注册处。如果该注册处仍然拥有其根节点，则此函数会抛出异常。

## 理由

### 从临时注册处开始

预见和设计所有潜在的名称分配问题是不太可能成功的。这种方法选择不关注完美，而是允许我们在有训练轮的情况下观察和学习，并在将可用命名空间扩展到更短的名称或其他 TLD 之前实施改进。

### 有效名称 >= 7 个字符

为升级的注册处保留最短且通常最有价值的域名提供了实施争议解决流程的机会（假设发现它们是必要的）。

### 名称的延迟发布

较慢的发布允许额外的时间来识别和解决在发布后可能出现的任何问题。

### 将 TLD 限制为 `.eth`

选择单一 TLD 有助于通过专注于一个命名空间来最大化网络效应。

三字母 TLD 是因其在互联网域名中的常见使用而熟悉的模式。这种熟悉感显著增加了 ENS 被集成到现有 DNS 系统中的潜力，并被保留为 [特殊用途域名](https://www.iana.org/assignments/special-use-domain-names/special-use-domain-names.xhtml#special-use-domain)。 最近的先例是 [`.onion` 域的保留](https://tools.ietf.org/html/rfc7686)。

### 将以太币作为抵押

这种方法比要求所有者定期支付以保留域名所有权的熟悉模型更简单。它还使初始注册处成为一个收入中立的服务。

## 先前的工作

本文档大量借鉴了几个来源：
- [EIP-137](./eip-137.md) 概述了注册合约 (ENS.sol) 和相关解析器合约的初始实现。
- [ERC-26](https://github.com/ethereum/EIPs/issues/26) 是第一个在合约层面提出名称服务的 ERC。
- @alexvandesande 当前实现的 [HashRegistrar](https://github.com/ethereum/ens/blob/mainnet/contracts/HashRegistrarSimplified.sol)

### 编辑：
- 2016-10-26 在摘要中添加了 Alex 的设计链接
- 2016-11-01 将 '计划停用' 更改为 h3'
- 2017-03-13 更新竞标和揭示周期的时间表

## 版权
版权及相关权利通过 [CC0](../LICENSE.md) 放弃。
```