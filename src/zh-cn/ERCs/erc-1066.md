---
eip: 1066
title: 状态码
author: Brooklyn Zelenka (@expede), Tom Carchrae (@carchrae), Gleb Naumenko (@naumenkogs)
discussions-to: https://ethereum-magicians.org/t/erc-1066-ethereum-status-codes-esc/
status: 停滞
type: 标准跟踪
category: ERC
created: 2018-05-05
---

## 简要总结

适用于智能合约的广泛状态码。

## 摘要

本标准概述了一组通用的状态码，类似于 HTTP 状态码。这提供了一组共享信号，使智能合约能够自主响应情况，向用户展示本地化的错误信息等。

当前的最佳实践是对任何非明确成功的情况 `revert`（即：需要人工干预），或返回低上下文的 `true` 或 `false`。状态码与带原因的 `revert` 类似但又正交，旨在实现自动化、调试和最终用户反馈（包括翻译）。*它们与 `revert` 和带原因的 `revert` 完全兼容。*

与 HTTP 一样，拥有一组标准的已知代码对开发者有许多好处。它们消除了为每个合约开发自己方案的摩擦，使合约间的自动化更容易，并使人们更容易理解请求产生的有限状态。重要的是，它使区分预期错误状态、真正需要停止执行的异常条件、正常状态转换和各种成功案例变得更加容易。

## 动机

### 语义密度

HTTP 状态码广泛用于此目的。BEAM 语言使用原子和标记元组来表示相似的信息。这两者都为程序员（例如调试）和需要决定下一步该做什么的程序提供了大量信息。

状态码传达的信息比 [布尔值](https://existentialtype.wordpress.com/2011/03/15/boolean-blindness/) 丰富得多，并且能够自主响应，而不是任意字符串。

### 用户体验 (UX)

*最终用户几乎没有反馈，也没有翻译层。*

由于 ERC1066 状态码是有限且预先已知的，我们可以利用 [ERC-1444](./eip-1444.md) 提供全球可读的状态消息集。这些消息也可以翻译成任何语言，具有不同的技术细节级别，作为 `revert` 消息、natspecs 等添加。

状态码传达的信息比布尔值丰富得多，并且能够自主响应，而不是任意字符串。

### 开发者体验 (DX)

*开发者目前从智能合约中获得的上下文非常有限。*

在撰写时，除了逐步执行 EVM 并直接检查内存转储外，很难理解智能合约执行期间发生的事情。通过返回更多上下文，开发者可以编写良好分解的测试，并断言某些代码作为智能合约达到的状态的表达。这包括状态码作为裸值、`event` 和 `revert`。

拥有一组固定的代码也使得编写通用的辅助函数以对某些信号以常见方式做出反应成为可能。这可以在链外或链上库中实现，降低构建智能合约的开销，并通过可信的共享组件提高代码质量。

我们在 [交易](./eip-658.md) 中也看到了这种需求，并且没有理由这些状态码不能被 EVM 本身使用。

### 智能合约自主性

*智能合约对请求的结果了解不多，除了通过/失败；它们可以通过更多上下文变得更智能。*

智能合约主要旨在实现自主性。虽然每个合约可能定义特定的接口，但拥有一组通用的语义代码可以帮助开发者编写能够适当地响应各种情况的代码。

状态码与带原因的 `revert` 明显相关，但又是互补的。状态码并不局限于回滚交易，可能表示已知的错误状态而不停止执行。它们还可以表示链外条件，提供字符串以进行回滚，信号延迟等。

所有这些使合约能够共享状态转换、结果和内部变化的通用词汇，而无需深入理解自定义状态枚举或协作合约的内部业务逻辑。

## 规范

### 格式

代码可以单独返回，或作为多个返回值的第一个值。

```solidity
// Status only

function isInt(uint num) public pure returns (byte status) {
    return hex"01";
}

// Status and value

uint8 private counter;

function safeIncrement(uint8 interval) public returns (byte status, uint8 newCounter) {
    uint8 updated = counter + interval;

    if (updated >= counter) {
        counter = updated;
        return (hex"01", updated);
    } else {
        return (hex"00", counter);
    }
}
```

### 代码表

代码很好地分为 16x16 矩阵，以 2 位十六进制数字表示。高半字节表示代码的种类或“类别”，低半字节包含状态或“原因”。我们将它们分为不同范围的表格，以便于解释和布局。

**注意：未指定的代码*不是*任意使用的，而是开放以供进一步规范。**

#### `0x0*` 通用

通用代码。这些也作为裸“原因”，因为 `0x01 == 1`。

| 代码   | 描述                                   |
|--------|----------------------------------------|
| `0x00` | 失败                                   |
| `0x01` | 成功                                   |
| `0x02` | 等待其他人                             |
| `0x03` | 已接受                                 |
| `0x04` | 下限或不足                             |
| `0x05` | 请求接收者采取行动                     |
| `0x06` | 上限                                   |
| `0x07` | [保留]                                 |
| `0x08` | 重复、不必要或不适用                   |
| `0x09` | [保留]                                 |
| `0x0A` | [保留]                                 |
| `0x0B` | [保留]                                 |
| `0x0C` | [保留]                                 |
| `0x0D` | [保留]                                 |
| `0x0E` | [保留]                                 |
| `0x0F` | 信息或元数据                           |

#### `0x1*` 权限与控制

也用于常见状态机操作（例如“红绿灯”操作）。

| 代码   | 描述                                         |
|--------|----------------------------------------------|
| `0x10` | 不允许或停止                                |
| `0x11` | 允许或继续                                   |
| `0x12` | 等待其他人的权限                            |
| `0x13` | 请求权限                                    |
| `0x14` | 太开放/不安全                               |
| `0x15` | 需要您的权限或请求继续                      |
| `0x16` | 撤销或禁止                                  |
| `0x17` | [保留]                                      |
| `0x18` | 不适用于当前状态                            |
| `0x19` | [保留]                                      |
| `0x1A` | [保留]                                      |
| `0x1B` | [保留]                                      |
| `0x1C` | [保留]                                      |
| `0x1D` | [保留]                                      |
| `0x1E` | [保留]                                      |
| `0x1F` | 权限详情或控制条件                          |

#### `0x2*` 查找、不等式与范围

此范围广泛用于查找和匹配。数据查找和订单匹配是两个常见的用例。
| 代码   | 描述                                   |
|--------|----------------------------------------|
| `0x20` | 未找到、不相等或超出范围               |
| `0x21` | 找到、相等或在范围内                  |
| `0x22` | 等待匹配                               |
| `0x23` | 匹配请求已发送                         |
| `0x24` | 低于范围或下溢                        |
| `0x25` | 请求匹配                               |
| `0x26` | 超出范围或上溢                        |
| `0x27` | [保留]                                 |
| `0x28` | 重复、冲突或碰撞                      |
| `0x29` | [保留]                                 |
| `0x2A` | [保留]                                 |
| `0x2B` | [保留]                                 |
| `0x2C` | [保留]                                 |
| `0x2D` | [保留]                                 |
| `0x2E` | [保留]                                 |
| `0x2F` | 匹配元数据或信息                       |

#### `0x3*` 协商与治理

协商，以及广义上的此类交易的流程。请注意，“其他方”可能不止一个参与者（不一定是发送者）。

| 代码   | 描述                                   |
|--------|----------------------------------------|
| `0x30` | 发送者不同意或否                        |
| `0x31` | 发送者同意或是                         |
| `0x32` | 等待批准                               |
| `0x33` | 提供已发送或投票                       |
| `0x34` | 未达到法定人数                         |
| `0x35` | 收件人的批准请求                       |
| `0x36` | 提供或投票限制已达到                   |
| `0x37` | [保留]                                 |
| `0x38` | 已经投票                               |
| `0x39` | [保留]                                 |
| `0x3A` | [保留]                                 |
| `0x3B` | [保留]                                 |
| `0x3C` | [保留]                                 |
| `0x3D` | [保留]                                 |
| `0x3E` | [保留]                                 |
| `0x3F` | 协商规则或参与信息                     |

#### `0x4*` 可用性与时间

服务或操作的可用性。

| 代码   | 描述                                   |
|--------|----------------------------------------|
| `0x40` | 不可用                                 |
| `0x41` | 可用                                   |
| `0x42` | 暂停                                   |
| `0x43` | 排队                                   |
| `0x44` | 尚不可用                               |
| `0x45` | 等待您的可用性                         |
| `0x46` | 已过期                                 |
| `0x47` | [保留]                                 |
| `0x48` | 已完成                                 |
| `0x49` | [保留]                                 |
| `0x4A` | [保留]                                 |
| `0x4B` | [保留]                                 |
| `0x4C` | [保留]                                 |
| `0x4D` | [保留]                                 |
| `0x4E` | [保留]                                 |
| `0x4F` | 可用性规则或信息（例如，自或至的时间） |

#### `0x5*` 代币、资金与财务

特殊代币和金融概念。许多相关概念包含在其他范围内。

| 代码   | 描述                                   |
|--------|----------------------------------------|
| `0x50` | 转账失败                               |
| `0x51` | 转账成功                               |
| `0x52` | 等待他人付款                           |
| `0x53` | 保留或托管                             |
| `0x54` | 资金不足                               |
| `0x55` | 请求资金                               |
| `0x56` | 转账量超出                             |
| `0x57` | [保留]                                 |
| `0x58` | 不需要资金                             |
| `0x59` | [保留]                                 |
| `0x5A` | [保留]                                 |
| `0x5B` | [保留]                                 |
| `0x5C` | [保留]                                 |
| `0x5D` | [保留]                                 |
| `0x5E` | [保留]                                 |
| `0x5F` | 代币或财务信息                         |

#### `0x6*` 待定

当前未指定。（整个范围保留）

#### `0x7*` 待定

当前未指定。（整个范围保留）

#### `0x8*` 待定

当前未指定。（整个范围保留）

#### `0x9*` 待定

当前未指定。（整个范围保留）

#### `0xA*` 应用特定代码

合约可能有需要信号的特殊状态。此提案仅概述最广泛的含义，但实现者可以对每个状态有非常具体的含义，只要它们与更广泛的定义一致。

| 代码   | 描述                                   |
|--------|----------------------------------------|
| `0xA0` | 应用特定失败                          |
| `0xA1` | 应用特定成功                          |
| `0xA2` | 应用特定等待他人                      |
| `0xA3` | 应用特定接受                          |
| `0xA4` | 应用特定低于条件                      |
| `0xA5` | 应用特定请求接收者行动                |
| `0xA6` | 应用特定到期或限制                    |
| `0xA7` | [保留]                                 |
| `0xA8` | 应用特定不适用条件                    |
| `0xA9` | [保留]                                 |
| `0xAA` | [保留]                                 |
| `0xAB` | [保留]                                 |
| `0xAC` | [保留]                                 |
| `0xAD` | [保留]                                 |
| `0xAE` | [保留]                                 |
| `0xAF` | 应用特定元数据或信息                  |

#### `0xB*` 待定

当前未指定。（整个范围保留）

#### `0xC*` 待定

当前未指定。（整个范围保留）

#### `0xD*` 待定

当前未指定。（整个范围保留）

#### `0xE*` 加密、身份与证明

围绕签名、密码学、签署和应用级身份验证的操作。

元代码 `0xEF` 通常用于信号传达描述所使用的算法或过程的有效负载。

| 代码   | 描述                                   |
|--------|----------------------------------------|
| `0xE0` | 解密失败                               |
| `0xE1` | 解密成功                               |
| `0xE2` | 等待其他签名或密钥                    |
| `0xE3` | 已签名                                 |
| `0xE4` | 未签名或不可信                         |
| `0xE5` | 需要签名                               |
| `0xE6` | 已知被泄露                             |
| `0xE7` | [保留]                                 |
| `0xE8` | 已签名或未加密                         |
| `0xE9` | [保留]                                 |
| `0xEA` | [保留]                                 |
| `0xEB` | [保留]                                 |
| `0xEC` | [保留]                                 |
| `0xED` | [保留]                                 |
| `0xEE` | [保留]                                 |
| `0xEF` | 密码学、身份或证明元数据              |

#### `0xF*` 链下

用于链下操作。与 `0x0*: 通用` 范围类似，`0xF*` 非常通用，并且对原因的修改很少。

在其他方面，元代码 `0xFF` 可用于描述链下过程是什么。

| 代码   | 描述                                   |
|--------|----------------------------------------|
| `0xF0` | 链下失败                               |
| `0xF1` | 链下成功                               |
| `0xF2` | 等待链下过程                           |
| `0xF3` | 链下过程已启动                         |
| `0xF4` | 链下服务无法访问                       |
| `0xF5` | 需要链下操作                           |
| `0xF6` | 链下到期或限制已达到                   |
| `0xF7` | [保留]                                 |
| `0xF8` | 重复的链下请求                         |
| `0xF9` | [保留]                                 |
| `0xFA` | [保留]                                 |
| `0xFB` | [保留]                                 |
| `0xFC` | [保留]                                 |
| `0xFD` | [保留]                                 |
| `0xFE` | [保留]                                 |
| `0xFF` | 链下信息或元数据                      |
### 作为网格

|        | `0x0*` 一般                                   | `0x1*` 权限与控制                                   | `0x2*` 查找、不等式与范围                     | `0x3*` 谈判与治理                               | `0x4*` 可用性与时间                                   | `0x5*` 代币、资金与金融                     | `0x6*` 待定        | `0x7*` 待定        | `0x8*` 待定        | `0x9*` 待定        | `0xA*` 应用特定代码                             | `0xB*` 待定        | `0xC*` 待定        | `0xD*` 待定        | `0xE*` 加密、身份与证明                         | `0xF*` 链下                             |
|--------|------------------------------------------------|----------------------------------------------------|----------------------------------------------|------------------------------------------------|-----------------------------------------------------|--------------------------------------------|-------------------|-------------------|-------------------|-------------------|------------------------------------------------|-------------------|-------------------|-------------------|------------------------------------------------|------------------------------------------|
| `0x*0` | `0x00` 失败                                   | `0x10` 不允许或停止                                 | `0x20` 未找到、不等或超出范围                | `0x30` 发送者不同意或否决                       | `0x40` 不可用                                        | `0x50` 转账失败                             | `0x60` [保留]     | `0x70` [保留]     | `0x80` [保留]     | `0x90` [保留]     | `0xA0` 应用特定失败                             | `0xB0` [保留]     | `0xC0` [保留]     | `0xD0` [保留]     | `0xE0` 解密失败                                 | `0xF0` 链下失败                             |
| `0x*1` | `0x01` 成功                                   | `0x11` 允许或继续                                   | `0x21` 找到、相等或在范围内                  | `0x31` 发送者同意或赞成                         | `0x41` 可用                                          | `0x51` 转账成功                             | `0x61` [保留]     | `0x71` [保留]     | `0x81` [保留]     | `0x91` [保留]     | `0xA1` 应用特定成功                             | `0xB1` [保留]     | `0xC1` [保留]     | `0xD1` [保留]     | `0xE1` 解密成功                                 | `0xF1` 链下成功                             |
| `0x*2` | `0x02` 等待其他人                             | `0x12` 等待他人的权限                               | `0x22` 等待匹配                              | `0x32` 等待批准                                   | `0x42` 暂停                                          | `0x52` 等待其他人付款                         | `0x62` [保留]     | `0x72` [保留]     | `0x82` [保留]     | `0x92` [保留]     | `0xA2` 应用特定等待其他人                       | `0xB2` [保留]     | `0xC2` [保留]     | `0xD2` [保留]     | `0xE2` 等待其他签名或密钥                     | `0xF2` 等待链下处理                           |
| `0x*3` | `0x03` 接受                                   | `0x13` 请求权限                                   | `0x23` 匹配请求已发送                        | `0x33` 提供或投票已发送                         | `0x43` 排队                                          | `0x53` 保留或托管                             | `0x63` [保留]     | `0x73` [保留]     | `0x83` [保留]     | `0x93` [保留]     | `0xA3` 应用特定接受                             | `0xB3` [保留]     | `0xC3` [保留]     | `0xD3` [保留]     | `0xE3` 已签名                                   | `0xF3` 链下处理已开始                       |
| `0x*4` | `0x04` 下限或不足                             | `0x14` 过于开放/不安全                             | `0x24` 低于范围或下溢                        | `0x34` 未达到法定人数                             | `0x44` 还不可用                                    | `0x54` 资金不足                               | `0x64` [保留]     | `0x74` [保留]     | `0x84` [保留]     | `0x94` [保留]     | `0xA4` 应用特定低于条件                         | `0xB4` [保留]     | `0xC4` [保留]     | `0xD4` [保留]     | `0xE4` 未签名或不可信                         | `0xF4` 链下服务不可达                       |
| `0x*5` | `0x05` 需要接收者操作                         | `0x15` 需要您的权限或请求继续                     | `0x25` 请求匹配                              | `0x35` 请求接收者的批准                         | `0x45` 等待您的可用性                             | `0x55` 请求资金                               | `0x65` [保留]     | `0x75` [保留]     | `0x85` [保留]     | `0x95` [保留]     | `0xA5` 应用特定接收者操作请求                   | `0xB5` [保留]     | `0xC5` [保留]     | `0xD5` [保留]     | `0xE5` 需要签名                               | `0xF5` 链下操作需要                           |
| `0x*6` | `0x06` 上限                                   | `0x16` 撤销或禁止                                 | `0x26` 超出范围或溢出                        | `0x36` 提供或投票限制已达到                     | `0x46` 已过期                                      | `0x56` 转账量超出                             | `0x66` [保留]     | `0x76` [保留]     | `0x86` [保留]     | `0x96` [保留]     | `0xA6` 应用特定到期或限制                       | `0xB6` [保留]     | `0xC6` [保留]     | `0xD6` [保留]     | `0xE6` 已知被破坏                             | `0xF6` 链下到期或限制已达到                   |
| `0x*7` | `0x07` [保留]                                 | `0x17` [保留]                                      | `0x27` [保留]                                | `0x37` [保留]                                    | `0x47` [保留]                                      | `0x57` [保留]                                | `0x67` [保留]   | `0x77` [保留]   | `0x87` [保留]   | `0x97` [保留]   | `0xA7` [保留]                                   | `0xB7` [保留]   | `0xC7` [保留]   | `0xD7` [保留]   | `0xE7` [保留]                                    | `0xF7` [保留]                                  |
| `0x*8` | `0x08` 重复、不必要或不适用                   | `0x18` 不适用于当前状态                           | `0x28` 重复、冲突或碰撞                      | `0x38` 已投票                                   | `0x48` 已完成                                        | `0x58` 不需要资金                             | `0x68` [保留]     | `0x78` [保留]     | `0x88` [保留]     | `0x98` [保留]     | `0xA8` 应用特定不适用条件                       | `0xB8` [保留]     | `0xC8` [保留]     | `0xD8` [保留]     | `0xE8` 已签名或未加密                         | `0xF8` 重复链下请求                           |
| `0x*9` | `0x09` [保留]                                 | `0x19` [保留]                                      | `0x29` [保留]                                | `0x39` [保留]                                    | `0x49` [保留]                                      | `0x59` [保留]                                | `0x69` [保留]   | `0x79` [保留]   | `0x89` [保留]   | `0x99` [保留]   | `0xA9` [保留]                                   | `0xB9` [保留]   | `0xC9` [保留]   | `0xD9` [保留]   | `0xE9` [保留]                                    | `0xF9` [保留]                                  |
| `0x*A` | `0x0A` [保留]                                 | `0x1A` [保留]                                      | `0x2A` [保留]                                | `0x3A` [保留]                                    | `0x4A` [保留]                                      | `0x5A` [保留]                                | `0x6A` [保留]   | `0x7A` [保留]   | `0x8A` [保留]   | `0x9A` [保留]   | `0xAA` [保留]                                   | `0xBA` [保留]   | `0xCA` [保留]   | `0xDA` [保留]   | `0xEA` [保留]                                    | `0xFA` [保留]                                  |
| `0x*B` | `0x0B` [保留]                                 | `0x1B` [保留]                                      | `0x2B` [保留]                                | `0x3B` [保留]                                    | `0x4B` [保留]                                      | `0x5B` [保留]                                | `0x6B` [保留]   | `0x7B` [保留]   | `0x8B` [保留]   | `0x9B` [保留]   | `0xAB` [保留]                                   | `0xBB` [保留]   | `0xCB` [保留]   | `0xDB` [保留]   | `0xEB` [保留]                                    | `0xFB` [保留]                                  |
| `0x*C` | `0x0C` [保留]                                 | `0x1C` [保留]                                      | `0x2C` [保留]                                | `0x3C` [保留]                                    | `0x4C` [保留]                                      | `0x5C` [保留]                                | `0x6C` [保留]   | `0x7C` [保留]   | `0x8C` [保留]   | `0x9C` [保留]   | `0xAC` [保留]                                   | `0xBC` [保留]   | `0xCC` [保留]   | `0xDC` [保留]   | `0xEC` [保留]                                    | `0xFC` [保留]                                  |
| `0x*D` | `0x0D` [保留]                                 | `0x1D` [保留]                                      | `0x2D` [保留]                                | `0x3D` [保留]                                    | `0x4D` [保留]                                      | `0x5D` [保留]                                | `0x6D` [保留]   | `0x7D` [保留]   | `0x8D` [保留]   | `0x9D` [保留]   | `0xAD` [保留]                                   | `0xBD` [保留]   | `0xCD` [保留]   | `0xDD` [保留]   | `0xED` [保留]                                    | `0xFD` [保留]                                  |
| `0x*E` | `0x0E` [保留]                                 | `0x1E` [保留]                                      | `0x2E` [保留]                                | `0x3E` [保留]                                    | `0x4E` [保留]                                      | `0x5E` [保留]                                | `0x6E` [保留]   | `0x7E` [保留]   | `0x8E` [保留]   | `0x9E` [保留]   | `0xAE` [保留]                                   | `0xBE` [保留]   | `0xCE` [保留]   | `0xDE` [保留]   | `0xEE` [保留]                                    | `0xFE` [保留]                                  |
| `0x*F` | `0x0F` 信息或元数据                           | `0x1F` 权限详情或控制条件                          | `0x2F` 匹配元数据或信息                      | `0x3F` 谈判规则或参与信息                       | `0x4F` 可用性规则或信息（例如，自何时或至何时） | `0x5F` 代币或财务信息                       | `0x6F` [保留]   | `0x7F` [保留]   | `0x8F` [保留]   | `0x9F` [保留]   | `0xAF` 应用特定元数据或信息                     | `0xBF` [保留]   | `0xCF` [保留]   | `0xDF` [保留]   | `0xEF` 加密、身份或证明元数据                  | `0xFF` 链下信息或元数据                       |
### 示例函数更改

```solidity
uint256 private startTime;
mapping(address => uint) private counters;

// Before
function increase() public returns (bool _available) {
    if (now < startTime && counters[msg.sender] == 0) {
        return false;
    };

    counters[msg.sender] += 1;
    return true;
}

// After
function increase() public returns (byte _status) {
    if (now < start) { return hex"44"; } // Not yet available
    if (counters[msg.sender] == 0) { return hex"10"; } // Not authorized

    counters[msg.sender] += 1;
    return hex"01"; // Success
}
```

### 示例序列图

```
0x03 = Waiting
0x31 = Other Party (ie: not you) Agreed
0x41 = Available
0x44 = Not Yet Available


                          Exchange


AwesomeCoin                 DEX                     TraderBot
     +                       +                          +
     |                       |       buy(AwesomeCoin)   |
     |                       | <------------------------+
     |         buy()         |                          |
     | <---------------------+                          |
     |                       |                          |
     |     Status [0x44]     |                          |
     +---------------------> |       Status [0x44]      |
     |                       +------------------------> |
     |                       |                          |
     |                       |        isDoneYet()       |
     |                       | <------------------------+
     |                       |                          |
     |                       |       Status [0x44]      |
     |                       +------------------------> |
     |                       |                          |
     |                       |                          |
     |     Status [0x41]     |                          |
     +---------------------> |                          |
     |                       |                          |
     |       buy()           |                          |
     | <---------------------+                          |
     |                       |                          |
     |                       |                          |
     |     Status [0x31]     |                          |
     +---------------------> |      Status [0x31]       |
     |                       +------------------------> |
     |                       |                          |
     |                       |                          |
     |                       |                          |
     |                       |                          |
     +                       +                          +
```



```
0x01 = Generic Success
0x10 = Disallowed
0x11 = Allowed

                                              Token Validation


           Buyer                  RegulatedToken           TokenValidator               IDChecker          SpendLimiter
             +                          +                         +                         +                   +
             |        buy()             |                         |                         |                   |
             +------------------------> |          check()        |                         |                   |
             |                          +-----------------------> |          check()        |                   |
             |                          |                         +-----------------------> |                   |
             |                          |                         |                         |                   |
             |                          |                         |         Status [0x10]   |                   |
             |                          |       Status [0x10]     | <-----------------------+                   |
             |        revert()          | <-----------------------+                         |                   |
             | <------------------------+                         |                         |                   |
             |                          |                         |                         |                   |
+---------------------------+           |                         |                         |                   |
|                           |           |                         |                         |                   |
| Updates ID with provider  |           |                         |                         |                   |
|                           |           |                         |                         |                   |
+---------------------------+           |                         |                         |                   |
             |                          |                         |                         |                   |
             |         buy()            |                         |                         |                   |
             +------------------------> |        check()          |                         |                   |
             |                          +-----------------------> |         check()         |                   |
             |                          |                         +-----------------------> |                   |
             |                          |                         |                         |                   |
             |                          |                         |       Status [0x11]     |                   |
             |                          |                         | <-----------------------+                   |
             |                          |                         |                         |                   |
             |                          |                         |                         |   check()         |
             |                          |                         +-------------------------------------------> |
             |                          |                         |                         |                   |
             |                          |                         |                         |  Status [0x11]    |
             |                          |       Status [0x11]     | <-------------------------------------------+
             |        Status [0x01]     | <-----------------------+                         |                   |
             | <------------------------+                         |                         |                   |
             |                          |                         |                         |                   |
             |                          |                         |                         |                   |
             |                          |                         |                         |                   |
             +                          +                         +                         +                   +
```

## 理由

### 编码

状态码被编码为一个 `byte`。十六进制值很好地分为高和低半字节：`category` 和 `reason`。例如，`0x01` 代表一般成功（即：`true`），而 `0x00` 代表一般失败（即：`false`）。

作为一种通用方法，所有偶数都是阻塞条件（接收者没有控制权），而奇数是非阻塞的（接收者可以自由继续）。这将简单的位检查与布尔值的常见编码对齐。

`bytes1` 非常轻量、可移植，易于与 `uint8` 互操作，可以从 `enum` 转换等。

#### 替代方案

替代方案包括 `bytes32` 和 `uint8`。虽然这些方案工作得相当不错，但也有缺点。

`uint8` 感觉更像 HTTP 状态码，且枚举不需要太多的转换。然而，它的分布不如一个方形表格（256 在十进制中看起来不那么美观）。

将多个代码打包到一个 `bytes32` 中在理论上是不错的，但带来了额外的挑战。未使用的空间可能被解释为 `0x00 Failure`，你只能有效地同时打包四个代码，并且确保代码组合合理是一个挑战。强迫四个代码进入一个打包表示会鼓励返回多个状态码，这通常提供的信息超过了严格必要的。这可能导致矛盾的结果（例如 `0x00` 和 `0x01` 一起），或者在解释 256<sup>4</sup>（43 亿）排列时分配更多资源。

### 多重返回

虽然在某些情况下打包状态码的字节数组可能有意义，但最简单、最向前兼容的传输方法是作为多个返回的第一个值。

熟悉性也是一个动机因素。一致的位置和编码遵循最小惊讶原则。它既可以视为 HTTP 类比中的“头部”，也可以像 BEAM 标记元组中的“标签”。

### 可读性

开发者不应被要求记住 256 个代码。然而，它们很好地分为一个表格。通过将表格组织成类别和原因，降低了认知负担。`0x10` 和 `0x11` 属于同一类别，而 `0x04` 与 `0x24` 共享一个原因。

虽然这个库包含辅助枚举，但我们发现直接使用十六进制值是相当自然的。例如，状态码 `0x10` 和 HTTP 401 一样舒适。

#### 本地化

这个规范的一个常见请求是状态码的人类可读翻译。这已被移至其自己的提案：[ERC-1444](./eip-1444.md)，主要是出于希望保持两个规范专注的愿望。

### 可扩展性

`0xA` 类别保留用于特定应用的状态。如果 256 个代码变得不足，`bytes1` 可以嵌入更大的字节数组中。

### EVM 代码

EVM 在交易中也返回状态码；具体来说是 `0x00` 和 `0x01`。该提案既匹配这两个代码的含义，也可以在 EVM 层面上使用。

### 空白空间

就像 HTTP 状态码有大量未使用的范围一样，这个提案中也有完全空的部分。其意图是不提前强加完整的代码集，并允许用户随着时间的推移建议这些空间的用途。

### 超越错误

这个规范旨在远不止一组常见错误。一个设计目标是实现更容易的合约间通信、基于状态码构建的协议，以及跨链的流程。这些情况通常包括预期的异常状态（而非真正的错误）、中性状态、时间逻辑和各种成功。

就像 HTTP 200 与 HTTP 201 的含义不同一样，ERC-1066 状态码可以在合约之间传递信息，而不仅仅是通过或失败。它们可以被视为一个图中的边，智能合约作为节点。

### 完全可 `revert`

_该规范与 `revert`-with-reason 完全兼容，并不打算以任何方式取代它。_ 通过使用一个通用代码进行回退，开发者可以从一组已知的错误状态中确定出了什么问题。

此外，通过结合使用 ERC-1066 和翻译表（如 ERC-1444），开发者和最终用户都可以接收完全自动化的人类可读错误消息，以他们选择的语言和措辞。

### 半字节顺序

半字节顺序对机器没有影响，纯粹是助记符。该设计最初是相反的顺序，但出于一些便利因素进行了更改。由于它与 HTTP 的方案不同，最初可能会感觉奇怪，但在使用几个小时后会变得非常自然。

#### 简短形式

通用形式是 `0x0*`，一般代码与其整数表示一致

```solidity
hex"1" == hex"01" == 1 // with casting
```

#### 合约类别

许多应用程序将始终属于同一类别。例如，验证通常在 `0x10` 范围内。

```solidity
contract Whitelist {
    mapping(address => bool) private whitelist;
    uint256 private deadline;
    byte constant private prefix = hex"10";

    check(address _, address _user) returns (byte _status) {
        if (now >= deadline)  { return prefix | 5; }
        if (whitelist[_user]) { return prefix | 1; }
        return prefix;
    }
}
```

#### 辅助工具

上述内容也意味着与特定应用的枚举一起工作稍微容易一些，并且也节省了 gas（所需操作更少）。

```solidity
enum Sleep {
    Awake,
    Asleep,
    BedOccupied,
    WindingDown
}

// From the helper library

function appCode(Sleep _state) returns (byte code) {
    return byte(160 + _state); // 160 = 0xA0
}

// Versus

function appCode(Sleep _state) returns (byte code) {
    return byte((16 * _state) + 10); // 10 = 0xA
}
```

## 实现

参考案例和辅助库（Solidity 和 JS）可以在以下位置找到：
* [源代码](https://github.com/fission-suite/fission-codes/)
* [npm 上的包](https://www.npmjs.com/package/fission-codes/)

## 版权

版权及相关权利通过 [CC0](../LICENSE.md) 放弃。